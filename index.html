<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kin - C√¥ng C·ª• Nhi·ªám V·ª•</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Inter t·ª´ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* S·ª≠ d·ª•ng font Inter l√†m font ch·ªØ m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }

        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* N√∫t b·∫•m gradient */
        .btn-gradient {
            background-image: linear-gradient(to right, #3b82f6, #6366f1);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            background-image: linear-gradient(to right, #2563eb, #4f46e5);
            box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.3);
        }

        /* Animation cho modal */
        @keyframes slide-in {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-content {
            animation: slide-in 0.3s ease-out forwards;
        }

        /* Animation cho pop-up th√¥ng b√°o */
        @keyframes pop-up {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-up {
            animation: pop-up 0.3s ease-out forwards;
        }

        /* Animation khi tr·∫£ l·ªùi sai */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
        }
        .shake-error {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Animation cho log */
        @keyframes slide-in-log {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .animate-slide-in {
            animation: slide-in-log 0.3s ease-out forwards;
        }

        /* Icon ng∆∞·ªùi d√πng */
        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background-color: #374151; /* gray-700 */
            color: white;
            border: 2px solid #4b5563; /* gray-600 */
            flex-shrink: 0;
        }
        .user-icon-sm {
            width: 28px;
            height: 28px;
            font-size: 1rem;
            border-width: 1px;
        }
        
        /* N√∫t ch·ªçn Emoji */
        .emoji-btn {
            background-color: #4b5563; /* gray-600 */
            border: none;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-btn:hover {
            background-color: #6b7280; /* gray-500 */
            transform: scale(1.1);
        }
        
        /* Bi·ªÉu t∆∞·ª£ng Rank */
        .rank-icon {
            font-size: 3rem;
            line-height: 1;
        }
        
        /* Ch·∫•m ƒë·ªè th√¥ng b√°o üîî */
        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid #1f2937; /* gray-800 */
        }
        
        /* CSS V√≤ng Quay May M·∫Øn */
        #wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 2rem auto;
        }
        
        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 8px solid #374151; /* gray-700 */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            background-color: #1f2937; /* gray-800 */
        }
        
        .wheel-slice {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 0);
            display: flex;
            align-items: center;
            justify-content: center;
            padding-right: 30px;
            box-sizing: border-box;
            font-size: 0.75rem; /* 12px */
            font-weight: 600; /* semibold */
            color: #111827; /* gray-900 */
            text-align: right;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(calc(var(--i) * var(--degree))) skewY(calc(var(--skew) * 1deg));
        }
        
        #wheel-pointer {
            position: absolute;
            top: 50%;
            right: -25px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-left: 30px solid #ef4444; /* red-500 */
            z-index: 10;
        }
        
        #spin-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #4b5563; /* gray-600 */
            border: 4px solid #f9fafb; /* gray-50 */
            color: white;
            font-weight: 700;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }
        #spin-btn:hover {
            background-color: #6b7280; /* gray-500 */
        }
        #spin-btn:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* CSS cho K√©o/Th·∫£ (Drag/Drop) */
        .draggable {
            cursor: move;
            user-select: none;
            transition: background-color 0.2s;
        }
        .dragging {
            opacity: 0.5;
            background: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-inter antialiased">

    <!-- 1. Trang ƒêƒÉng Nh·∫≠p (Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h1 class="text-5xl font-extrabold text-center mb-4 text-white">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Kin</span>
            </h1>
            <p class="text-center text-gray-400 mb-8">C√¥ng c·ª• Nhi·ªám V·ª• & Rank</p>
            
            <form id="login-form">
                <div class="mb-5">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                    <input type="text" id="username" name="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="Nh·∫≠p t√†i kho·∫£n" required>
                </div>
                <div class="mb-5">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="flex items-center mb-6">
                    <input id="remember-me" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                    <label for="remember-me" class="ml-2 text-sm font-medium text-gray-300">Nh·ªõ m·∫≠t kh·∫©u</label>
                </div>
                
                <button type="submit" class="w-full text-white btn-gradient font-medium rounded-lg text-sm px-5 py-3.5 text-center shadow-lg transition duration-300 transform hover:scale-105">
                    ƒêƒÉng Nh·∫≠p
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Trang Ng∆∞·ªùi Ch∆°i (·∫®n ban ƒë·∫ßu) -->
    <div id="player-view" class="container mx-auto p-4 hidden">
        <!-- Header Ng∆∞·ªùi Ch∆°i -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div id="player-header-icon" class="user-icon">üë§</div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Ch√†o, <span id="player-displayname" class="text-blue-400"></span>!</h1>
                    <p class="text-sm text-gray-400 -mt-1">(@<span id="player-username"></span>)</p>
                </div>
                <div class="flex items-center gap-2 text-lg bg-yellow-400 text-gray-900 px-4 py-1 rounded-full font-semibold shadow-md">
                    <span class="text-xl">üí∞</span>
                    <span id="player-balance">0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- N√∫t Chu√¥ng Th√¥ng B√°o -->
                <button id="notification-bell-btn" class="relative text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span id="notification-dot" class="notification-dot hidden"></span>
                </button>
                <button id="logout-btn-player" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Player (5 tab) -->
        <nav id="player-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="tasks" class="player-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">üöÄ Nhi·ªám V·ª•</button>
                    <button data-tab="challenges" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üéØ Th·ª≠ Th√°ch</button>
                    <button data-tab="shop" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üõçÔ∏è C·ª≠a H√†ng</button>
                    <button data-tab="wheel" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üé° V√≤ng Quay</button>
                    <button data-tab="profile" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üë§ C√° Nh√¢n</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Player -->
        <div class="p-4 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[60vh]">
            
            <!-- Tab Nhi·ªám V·ª• -->
            <div id="tasks-tab" class="player-tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Nhi·ªám V·ª• C·ªßa B·∫°n</h2>
                <div id="task-list-player" class="space-y-4">
                    <p class="text-gray-400">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh h·∫øt nhi·ªám v·ª•.</p>
                </div>
            </div>
            
            <!-- Tab Th·ª≠ Th√°ch -->
            <div id="challenges-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Th·ª≠ Th√°ch H√†ng Ng√†y</h2>
                <div id="challenge-list-player" class="space-y-4">
                    <p class="text-gray-400">Ch∆∞a c√≥ th·ª≠ th√°ch n√†o h√¥m nay.</p>
                </div>
            </div>

            <!-- Tab C·ª≠a H√†ng -->
            <div id="shop-tab" class="player-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 sm:mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">C·ª≠a H√†ng ƒê·ªïi Th∆∞·ªüng</h2>
                    <button id="view-my-gifts-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 self-start sm:self-center">
                        üéÅ Xem Qu√† ƒê√£ ƒê·ªïi
                    </button>
                </div>
                <div id="view-gifts-pointer" class="hidden text-right text-green-400 font-semibold mb-4 animate-bounce">
                    H√£y xem qu√† c·ªßa m√¨nh nh√©! &nearr;
                </div>
                
                <div id="shop-list-player" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-400">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t.</p>
                </div>
            </div>
            
            <!-- Tab V√≤ng Quay May M·∫Øn -->
            <div id="wheel-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6 text-center">V√≤ng Quay May M·∫Øn</h2>
                <div class="flex flex-col items-center">
                    <div id="wheel-container">
                        <div id="wheel">
                            <!-- C√°c l√°t c·∫Øt (slices) c·ªßa v√≤ng quay s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                        </div>
                        <div id="wheel-pointer"></div>
                        <button id="spin-btn">QUAY</button>
                    </div>
                    <p id="spin-timer" class="text-yellow-400 font-semibold text-lg mt-4"></p>
                </div>
            </div>
            
            <!-- Tab C√° Nh√¢n -->
            <div id="profile-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Th√¥ng Tin C√° Nh√¢n</h2>
                
                <!-- Khu v·ª±c Rank -->
                <div class="max-w-lg mx-auto bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-6 text-center">
                    <h3 class="text-2xl font-bold text-white mb-4">Rank Hi·ªán T·∫°i</h3>
                    <div id="profile-rank-icon" class="rank-icon">‚öôÔ∏è</div>
                    <h4 id="profile-rank-name" class="text-3xl font-bold text-yellow-400 mt-2">Rank S·∫Øt</h4>
                    <p id="profile-rank-tasks" class="text-gray-400 mt-1">0 nhi·ªám v·ª• ƒë√£ ho√†n th√†nh</p>
                    <button id="rank-rules-btn" class="mt-4 text-sm text-blue-400 hover:underline">Xem lu·∫≠t ch∆°i</button>
                </div>
                
                <!-- Form Th√¥ng tin -->
                <div class="max-w-lg mx-auto bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700">
                    <div class="text-center mb-6">
                        <div id="profile-icon-display" class="user-icon text-5xl w-24 h-24 mx-auto mb-4 border-4 border-blue-500">üë§</div>
                    </div>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label for="profile-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                            <input type="text" id="profile-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <p id="cooldown-name" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <div>
                            <label for="profile-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (ch·ªâ 1 emoji, v√≠ d·ª•: üòä)</label>
                            <input type="text" id="profile-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <!-- B·ªô ch·ªçn Emoji -->
                            <div id="profile-emoji-list" class="flex flex-wrap gap-2 mt-2">
                                <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                            </div>
                            <p id="cooldown-icon" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <div>
                            <label for="profile-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t Kh·∫©u M·ªõi (b·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                            <input type="password" id="profile-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <p id="cooldown-password" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                            L∆∞u Thay ƒê·ªïi
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- 3. Trang Admin (·∫®n ban ƒë·∫ßu) -->
    <div id="admin-view" class="container mx-auto p-4 hidden">
        <!-- Header Admin -->
        <header class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <h1 class="text-3xl font-bold text-white">Admin Panel</h1>
            <button id="logout-btn-admin" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                ƒêƒÉng Xu·∫•t
            </button>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Admin (6 tab) -->
        <nav id="admin-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="userMgmt" class="admin-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</button>
                    <button data-tab="taskMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Nhi·ªám V·ª•</button>
                    <button data-tab="challengeMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Th·ª≠ Th√°ch</button>
                    <button data-tab="shopMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ C·ª≠a H√†ng</button>
                    <button data-tab="wheelMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ V√≤ng Quay</button>
                    <button data-tab="notifyMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">G·ª≠i Th√¥ng B√°o</button>
                    <button data-tab="activityLog" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Admin -->
        <div class="p-6 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[70vh]">

            <!-- Tab Qu·∫£n L√≠ Ng∆∞·ªùi D√πng -->
            <div id="user-mgmt-tab" class="admin-tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</h2>
                <form id="user-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                        <input type="text" id="user-username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                        <input type="text" id="user-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="user-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (Emoji)</label>
                        <input type="text" id="user-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- B·ªô ch·ªçn Emoji (Admin) -->
                        <div id="admin-emoji-list" class="flex flex-wrap gap-2 mt-2">
                            <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                        </div>
                    </div>
                    <div>
                        <label for="user-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</M·∫≠t kh·∫©u>
                        <input type="text" id="user-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-balance" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                        <input type="number" id="user-balance" value="0" min="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="user-tasks-completed" class="block mb-2 text-sm font-medium text-gray-300">S·ªë Nhi·ªám V·ª• HT (Rank)</label>
                        <input type="number" id="user-tasks-completed" value="0" min="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    
                    <div class="md:col-span-3 lg:col-span-4 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u</button>
                        <button type="button" id="clear-user-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>

                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Icon</th>
                                <th scope="col" class="py-3 px-6">T√™n Hi·ªÉn Th·ªã</th>
                                <th scope="col" class="py-3 px-6">T√†i kho·∫£n</th>
                                <th scope="col" class="py-3 px-6">Ti·ªÅn th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">Rank (NV HT)</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ Nhi·ªám V·ª• -->
            <div id="task-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Nhi·ªám V·ª•</h2>
                <form id="task-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <input type="hidden" id="task-id">
                    <div class="md:col-span-2 lg:col-span-4">
                        <label for="task-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n nhi·ªám v·ª•</label>
                        <input type="text" id="task-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="task-reward" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                        <input type="number" id="task-reward" min="0" value="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="task-penalty" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn ph·∫°t (N·∫øu tr·ªÖ) üí∞</label>
                        <input type="number" id="task-penalty" min="0" value="5" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="task-deadline" class="block mb-2 text-sm font-medium text-gray-300">Deadline (Ng√†y/Gi·ªù)</label>
                        <input type="datetime-local" id="task-deadline" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div class="md:col-span-2 lg:col-span-4 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u Nhi·ªám V·ª•</button>
                        <button type="button" id="clear-task-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">T√™n nhi·ªám v·ª•</th>
                                <th scope="col" class="py-3 px-6">Th∆∞·ªüng/Ph·∫°t</th>
                                <th scope="col" class="py-3 px-6">Deadline</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ Th·ª≠ Th√°ch -->
            <div id="challenge-mgmt-tab" class="admin-tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Qu·∫£n L√≠ Th·ª≠ Th√°ch</h2>
                    <button id="delete-all-challenges-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        X√≥a T·∫•t C·∫£ Th·ª≠ Th√°ch
                    </button>
                </div>
                <form id="challenge-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 space-y-4">
                    <input type="hidden" id="challenge-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-type" class="block mb-2 text-sm font-medium text-gray-300">Lo·∫°i C√¢u H·ªèi</label>
                            <select id="challenge-type" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="mcq">Tr·∫Øc nghi·ªám</option>
                                <option value="text">T·ª± lu·∫≠n</option>
                            </select>
                        </div>
                        <div>
                            <label for="challenge-reward" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                            <input type="number" id="challenge-reward" min="0" value="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="challenge-question" class="block mb-2 text-sm font-medium text-gray-300">C√¢u h·ªèi</label>
                        <textarea id="challenge-question" rows="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></textarea>
                    </div>
                    
                    <!-- Ph·∫ßn Tr·∫Øc Nghi·ªám (MCQ) -->
                    <div id="mcq-options" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="challenge-op1" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 1</label>
                                <input type="text" id="challenge-op1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                            <div>
                                <label for="challenge-op2" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 2</label>
                                <input type="text" id="challenge-op2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                            <div>
                                <label for="challenge-op3" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 3</label>
                                <input type="text" id="challenge-op3" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                            <div>
                                <label for="challenge-op4" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 4</label>
                                <input type="text" id="challenge-op4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            </div>
                        </div>
                        <div>
                            <label for="challenge-answer" class="block mb-2 text-sm font-medium text-gray-300">ƒê√°p √°n ƒë√∫ng (1-4)</label>
                            <input type="number" id="challenge-answer" min="1" max="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                    
                    <!-- Ph·∫ßn Gi·∫£i Th√≠ch (Chung cho c·∫£ 2 lo·∫°i) -->
                    <div>
                        <label for="challenge-explanation-text" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch ƒë√°p √°n (Text)</label>
                        <input type="text" id="challenge-explanation-text" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="challenge-explanation-img" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch (Link ·∫£nh) (Kh√¥ng b·∫Øt bu·ªôc)</label>
                        <input type="text" id="challenge-explanation-img" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u Th·ª≠ Th√°ch</button>
                        <button type="button" id="clear-challenge-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">C√¢u h·ªèi</th>
                                <th scope="col" class="py-3 px-6">Lo·∫°i</th>
                                <th scope="col" class="py-3 px-6">Th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="challenge-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ C·ª≠a H√†ng -->
            <div id="shop-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ C·ª≠a H√†ng</h2>
                <form id="shop-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <input type="hidden" id="shop-item-id">
                    <div>
                        <label for="shop-item-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n v·∫≠t ph·∫©m</label>
                        <input type="text" id="shop-item-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-price" class="block mb-2 text-sm font-medium text-gray-300">Gi√° üí∞</label>
                        <input type="number" id="shop-item-price" min="0" value="100" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-sale" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£m gi√° (%)</label>
                        <input type="number" id="shop-item-sale" min="0" max="100" value="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="md:col-span-3 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u V·∫≠t Ph·∫©m</button>
                        <button type="button" id="clear-shop-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">T√™n v·∫≠t ph·∫©m</th>
                                <th scope="col" class="py-3 px-6">Gi√° G·ªëc</th>
                                <th scope="col" class="py-3 px-6">Gi·∫£m gi√°</th>
                                <th scope="col" class="py-3 px-6">Gi√° B√°n</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="shop-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Qu·∫£n L√≠ V√≤ng Quay -->
            <div id="wheel-mgmt-tab" class="admin-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">Qu·∫£n L√≠ V√≤ng Quay</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="randomize-wheel-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            S·∫Øp X·∫øp Ng·∫´u Nhi√™n
                        </button>
                        <button id="clear-wheel-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a T·∫•t C·∫£
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Form th√™m ph·∫ßn th∆∞·ªüng -->
                    <form id="wheel-form" class="md:col-span-1 bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 space-y-4">
                        <input type="hidden" id="wheel-item-id">
                        <div>
                            <label for="wheel-item-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n Ph·∫ßn Th∆∞·ªüng</label>
                            <input type="text" id="wheel-item-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="wheel-item-type" class="block mb-2 text-sm font-medium text-gray-300">Lo·∫°i Ph·∫ßn Th∆∞·ªüng</label>
                            <select id="wheel-item-type" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="add_money">C·ªông Ti·ªÅn (+)</option>
                                <option value="subtract_money">Tr·ª´ Ti·ªÅn (-)</option>
                                <option value="item">V·∫≠t Ph·∫©m (t·ª´ C·ª≠a H√†ng)</option>
                                <option value="text">Ch·ªØ (v√≠ d·ª•: Ch√∫c may m·∫Øn)</option>
                            </select>
                        </div>
                        <div>
                            <label for="wheel-item-value" class="block mb-2 text-sm font-medium text-gray-300">Gi√° tr·ªã (S·ªë ti·ªÅn ho·∫∑c T√™n v·∫≠t ph·∫©m)</label>
                            <input type="text" id="wheel-item-value" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u</button>
                            <button type="button" id="clear-wheel-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                        </div>
                    </form>
                    
                    <!-- Danh s√°ch ph·∫ßn th∆∞·ªüng (K√©o/Th·∫£) -->
                    <div class="md:col-span-2 bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Danh S√°ch Ph·∫ßn Th∆∞·ªüng (K√©o/Th·∫£ ƒë·ªÉ s·∫Øp x·∫øp)</h3>
                        <div id="wheel-list-tbody" class="divide-y divide-gray-700 max-h-[60vh] overflow-y-auto">
                            <!-- Ph·∫ßn th∆∞·ªüng s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab G·ª≠i Th√¥ng B√°o -->
            <div id="notify-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">G·ª≠i Th√¥ng B√°o (T·ªõi üîî)</h2>
                <form id="notification-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 max-w-lg mx-auto">
                    <div class="mb-4">
                        <label for="notification-message" class="block mb-2 text-sm font-medium text-gray-300">N·ªôi dung th√¥ng b√°o</label>
                        <textarea id="notification-message" rows="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Vi·∫øt th√¥ng b√°o c·ªßa b·∫°n..." required></textarea>
                    </div>
                    <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                        G·ª≠i T·ªõi T·∫•t C·∫£ Ng∆∞·ªùi Ch∆°i
                    </button>
                </form>
            </div>
            
            <!-- Tab L·ªãch S·ª≠ Ho·∫°t ƒê·ªông -->
            <div id="activity-log-tab" class="admin-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (M·ªõi nh·∫•t)</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="clear-notifications-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            X√≥a H·∫øt Th√¥ng B√°o (User)
                        </button>
                        <button id="clear-purchase-log-btn" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-medium py-2 px-4 rounded-lg transition duration-200">
                            X√≥a L·ªãch S·ª≠ ƒê·ªïi Qu√†
                        </button>
                        <button id="clear-activity-log-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            X√≥a To√†n B·ªô L·ªãch S·ª≠
                        </button>
                    </div>
                </div>
                <div id="activity-log-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- 4. Modal Th√¥ng B√°o Chung (·∫®n ban ƒë·∫ßu) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Th√¥ng B√°o</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="p-6 text-gray-300 text-lg">
                <!-- N·ªôi dung modal -->
            </div>
            <div class="p-5 border-t border-gray-700 text-right space-x-3">
                <!-- N√∫t b·∫•m x√°c nh·∫≠n (n·∫øu c·∫ßn) -->
                <button id="modal-confirm-btn" class="hidden text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">X√°c nh·∫≠n</button>
                <button id="modal-cancel-btn" class="hidden text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                <button id="modal-ok-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">OK</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal Danh S√°ch Qu√† (·∫®n ban ƒë·∫ßu) -->
    <div id="gifts-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-white">üéÅ Qu√† ƒê√£ ƒê·ªïi</h3>
                <button id="gifts-modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="gifts-modal-body" class="p-6 text-gray-300 max-h-[60vh] overflow-y-auto">
                <!-- Danh s√°ch qu√† s·∫Ω render v√†o ƒë√¢y -->
            </div>
        </div>
    </div>
    
    <!-- 6. Modal Th√¥ng B√°o (Chu√¥ng üîî) (·∫®n ban ƒë·∫ßu) -->
    <div id="notifications-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-white">üîî Th√¥ng B√°o</h3>
                <button id="notifications-modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="notifications-modal-body" class="p-6 text-gray-300 max-h-[60vh] overflow-y-auto space-y-3">
                <!-- Danh s√°ch th√¥ng b√°o s·∫Ω render v√†o ƒë√¢y -->
            </div>
        </div>
    </div>
    
    <!-- 7. Modal Ch·∫•m ƒêi·ªÉm T·ª± Lu·∫≠n (·∫®n ban ƒë·∫ßu) -->
    <div id="grading-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-white">Ch·∫•m ƒêi·ªÉm T·ª± Lu·∫≠n</h3>
                <button id="grading-modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="grading-modal-body" class="p-6 text-gray-300 space-y-4">
                <p class="text-sm text-gray-400">Ng∆∞·ªùi n·ªôp: <span id="grading-username" class="font-medium text-white"></span></p>
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                    <p class="font-semibold text-white mb-2">C√¢u h·ªèi:</p>
                    <p id="grading-question" class="text-gray-300"></p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                    <p class="font-semibold text-white mb-2">C√¢u tr·∫£ l·ªùi c·ªßa user:</p>
                    <p id="grading-answer" class="text-white whitespace-pre-wrap"></p>
                </div>
            </div>
            <div class="p-5 border-t border-gray-700 text-right space-x-3">
                <button id="grading-reject-btn" class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">T·ª´ ch·ªëi (Kh√¥ng th∆∞·ªüng)</button>
                <button id="grading-approve-btn" class="text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">Duy·ªát (G·ª≠i th∆∞·ªüng)</button>
            </div>
        </div>
    </div>

<script>
// ---------- KH·ªûI CH·∫†Y ·ª®NG D·ª§NG ----------
// Bi·∫øn state to√†n c·ª•c, l∆∞u tr·ªØ tr·∫°ng th√°i c·ªßa ·ª©ng d·ª•ng
let state = {
    currentUser: null,
    users: {},
    tasks: {},
    challenges: {},
    shopItems: {},
    wheelItems: [], // V√≤ng quay gi·ªù l√† m·ªôt m·∫£ng ƒë·ªÉ gi·ªØ th·ª© t·ª±
    activityLog: [],
};

// Bi·∫øn l∆∞u tr·ªØ c√°c h√†m callback cho modal
let modalConfirmCallback = null;
let modalCancelCallback = null;

// Bi·∫øn l∆∞u tr·ªØ tr·∫°ng th√°i k√©o/th·∫£
let draggingElement = null;

// H·∫±ng s·ªë
const DB_KEY = 'kin_app_data';
const COOLDOWN_DAYS = 15; // 15 ng√†y
const WHEEL_COOLDOWN_HOURS = 24; // 24 gi·ªù

// H√†m kh·ªüi ch·∫°y ch√≠nh
function init() {
    loadData();
    setupEventListeners();
    checkRememberMe();
    renderEmojiPickers();
    
    // T·ª± ƒë·ªông th√™m t√†i kho·∫£n admin n·∫øu ch∆∞a c√≥
    if (!state.users['admin']) {
        state.users['admin'] = {
            username: 'admin',
            password: '123',
            displayName: 'Admin',
            icon: 'üëë',
            balance: 0,
            inventory: [],
            notifications: [],
            cooldowns: {},
            tasksCompleted: 0, // Rank
            tasks: {},
            challengesDone: {},
            lastSpin: 0,
        };
        saveData();
    }
}

// ---------- QU·∫¢N L√ù D·ªÆ LI·ªÜU (localStorage) ----------

// L∆∞u d·ªØ li·ªáu v√†o localStorage
function saveData() {
    try {
        localStorage.setItem(DB_KEY, JSON.stringify(state));
    } catch (e) {
        console.error("L·ªói khi l∆∞u d·ªØ li·ªáu v√†o localStorage:", e);
        showModal("L·ªói nghi√™m tr·ªçng", "Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu. C√≥ th·ªÉ b·ªô nh·ªõ ƒë√£ ƒë·∫ßy.");
    }
}

// T·∫£i d·ªØ li·ªáu t·ª´ localStorage
function loadData() {
    const data = localStorage.getItem(DB_KEY);
    if (data) {
        try {
            state = JSON.parse(data);
            // ƒê·∫£m b·∫£o c√°c c·∫•u tr√∫c d·ªØ li·ªáu m·ªõi t·ªìn t·∫°i
            if (!state.wheelItems) state.wheelItems = [];
            if (!state.activityLog) state.activityLog = [];
            
            // Chuy·ªÉn ƒë·ªïi users n·∫øu c·∫ßn (b·ªï sung c√°c tr∆∞·ªùng m·ªõi cho user c≈©)
            Object.values(state.users).forEach(user => {
                if (!user.tasks) user.tasks = {};
                if (!user.tasksCompleted) user.tasksCompleted = 0;
                if (!user.challengesDone) user.challengesDone = {};
                if (!user.notifications) user.notifications = [];
                if (!user.lastSpin) user.lastSpin = 0;
            });
            
        } catch (e) {
            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu:", e);
            initializeDefaultState();
        }
    } else {
        initializeDefaultState();
    }
}

// Kh·ªüi t·∫°o state m·∫∑c ƒë·ªãnh (n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu)
function initializeDefaultState() {
    state = {
        currentUser: null,
        users: {},
        tasks: {},
        challenges: {},
        shopItems: {},
        wheelItems: [], // M·∫£ng
        activityLog: [],
    };
}

// ---------- TI·ªÜN √çCH CHUNG ----------

// T·∫°o ID ng·∫´u nhi√™n
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
}

// Chuy·ªÉn ƒë·ªïi ng√†y th√†nh chu·ªói d·ªÖ ƒë·ªçc
function formatDateTime(isoString) {
    if (!isoString) return 'N/A';
    try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return 'Ng√†y kh√¥ng h·ª£p l·ªá';
        return date.toLocaleString('vi-VN', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    } catch (e) {
        return 'Ng√†y kh√¥ng h·ª£p l·ªá';
    }
}

// L·∫•y th·ªùi gian hi·ªán t·∫°i d∆∞·ªõi d·∫°ng ISO
function getCurrentISOTime() {
    return new Date().toISOString();
}

// ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn (th√™m d·∫•u ph·∫©y)
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount);
}

// L·∫•y m·ªëc Rank
function getRankInfo(tasksCompleted) {
    let rank = { name: "Rank S·∫Øt", icon: "‚öôÔ∏è", color: "text-gray-400" };
    if (tasksCompleted >= 100) {
        rank = { name: "Rank Kim C∆∞∆°ng", icon: "üíé", color: "text-cyan-400" };
    } else if (tasksCompleted >= 50) {
        rank = { name: "Rank V√†ng", icon: "ü•á", color: "text-yellow-400" };
    } else if (tasksCompleted >= 20) {
        rank = { name: "Rank B·∫°c", icon: "ü•à", color: "text-gray-300" };
    } else if (tasksCompleted >= 10) {
        rank = { name: "Rank ƒê·ªìng", icon: "ü•â", color: "text-yellow-600" };
    }
    return rank;
}

// G·ª≠i th√¥ng b√°o (chu√¥ng üîî) cho t·∫•t c·∫£ user (tr·ª´ admin)
function broadcastNotification(message, type = 'info') {
    Object.keys(state.users).forEach(username => {
        if (username !== 'admin') {
            const user = state.users[username];
            user.notifications.unshift({
                id: generateId(),
                date: getCurrentISOTime(),
                message: message,
                read: false,
                type: type // 'info', 'success', 'error'
            });
        }
    });
    saveData();
}

// G·ª≠i th√¥ng b√°o (chu√¥ng üîî) cho 1 user c·ª• th·ªÉ
function sendNotification(username, message, type = 'info') {
    const user = state.users[username];
    if (user) {
        user.notifications.unshift({
            id: generateId(),
            date: getCurrentISOTime(),
            message: message,
            read: false,
            type: type
        });
        saveData();
    }
}

// Th√™m v√†o L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (Admin)
function logActivity(message, details = {}) {
    const logEntry = {
        id: generateId(),
        date: getCurrentISOTime(),
        message: message,
        details: details // e.g., { type: 'challenge', challengeId: '...' }
    };
    state.activityLog.unshift(logEntry); // Th√™m v√†o ƒë·∫ßu m·∫£ng
    // Gi·ªØ cho log kh√¥ng qu√° 200 m·ª•c
    if (state.activityLog.length > 200) {
        state.activityLog.pop();
    }
    saveData();
}

// Render c√°c b·ªô ch·ªçn Emoji
const EMOJI_LIST = ['üòä', 'üî•', 'üöÄ', 'üåü', 'üéâ', 'üí°', 'üß†', 'üí™', 'üèÜ', 'üéØ', 'üëë', 'üòé'];
function renderEmojiPickers() {
    const containers = [
        document.getElementById('profile-emoji-list'),
        document.getElementById('admin-emoji-list')
    ];
    containers.forEach(container => {
        if (!container) return;
        container.innerHTML = '';
        EMOJI_LIST.forEach(emoji => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'emoji-btn';
            btn.textContent = emoji;
            btn.onclick = () => {
                // T√¨m √¥ input li√™n quan
                const input = container.previousElementSibling;
                if (input) {
                    input.value = emoji;
                }
            };
            container.appendChild(btn);
        });
    });
}

// ---------- QU·∫¢N L√ù MODAL (Pop-up) ----------

// Hi·ªÉn th·ªã modal chung
// (modalType: 'alert', 'confirm', 'prompt')
function showModal(title, body, modalType = 'alert', onConfirm = null, onCancel = null) {
    const modal = document.getElementById('modal');
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = body; // D√πng innerHTML ƒë·ªÉ render HTML (v√≠ d·ª•: ·∫£nh)
    
    const okBtn = document.getElementById('modal-ok-btn');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    
    // Reset c√°c n√∫t
    okBtn.classList.add('hidden');
    confirmBtn.classList.add('hidden');
    cancelBtn.classList.add('hidden');
    
    modalConfirmCallback = null;
    modalCancelCallback = null;

    if (modalType === 'confirm') {
        confirmBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
        modalConfirmCallback = onConfirm;
        modalCancelCallback = onCancel;
    } else {
        // M·∫∑c ƒë·ªãnh l√† 'alert'
        okBtn.classList.remove('hidden');
    }
    
    modal.classList.remove('hidden');
}

// ƒê√≥ng modal chung
function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    modalConfirmCallback = null;
    modalCancelCallback = null;
}

// Hi·ªÉn th·ªã modal danh s√°ch qu√†
function showGiftsModal(inventory) {
    const modal = document.getElementById('gifts-modal');
    const body = document.getElementById('gifts-modal-body');
    body.innerHTML = '';
    
    if (!inventory || inventory.length === 0) {
        body.innerHTML = '<p class="text-gray-400 text-center">B·∫°n ch∆∞a ƒë·ªïi v·∫≠t ph·∫©m n√†o.</p>';
    } else {
        const list = document.createElement('ul');
        list.className = 'space-y-3';
        
        // ƒê·∫øm s·ªë l∆∞·ª£ng v·∫≠t ph·∫©m
        const giftCounts = inventory.reduce((acc, gift) => {
            acc[gift.name] = (acc[gift.name] || 0) + 1;
            return acc;
        }, {});
        
        Object.entries(giftCounts).forEach(([name, count]) => {
            const li = document.createElement('li');
            li.className = 'p-3 bg-gray-700 rounded-lg flex justify-between items-center';
            li.innerHTML = `
                <span class="font-medium text-white">${name}</span>
                <span class="text-lg font-bold text-blue-400">x${count}</span>
            `;
            list.appendChild(li);
        });
        body.appendChild(list);
    }
    
    modal.classList.remove('hidden');
}

// ƒê√≥ng modal danh s√°ch qu√†
function closeGiftsModal() {
    document.getElementById('gifts-modal').classList.add('hidden');
}

// Hi·ªÉn th·ªã modal th√¥ng b√°o (chu√¥ng üîî)
function showNotificationsModal(user) {
    const modal = document.getElementById('notifications-modal');
    const body = document.getElementById('notifications-modal-body');
    body.innerHTML = '';
    
    if (!user.notifications || user.notifications.length === 0) {
        body.innerHTML = '<p class="text-gray-400 text-center">B·∫°n kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>';
    } else {
        user.notifications.forEach(notif => {
            const div = document.createElement('div');
            let borderColor = 'border-gray-600';
            if (notif.type === 'success') borderColor = 'border-green-500';
            if (notif.type === 'error') borderColor = 'border-red-500';
            
            div.className = `p-4 bg-gray-700 rounded-lg border-l-4 ${borderColor}`;
            div.innerHTML = `
                <p class="text-white">${notif.message}</p>
                <p class="text-xs text-gray-400 mt-1">${formatDateTime(notif.date)}</p>
            `;
            body.appendChild(div);
            notif.read = true; // ƒê√°nh d·∫•u l√† ƒë√£ ƒë·ªçc
        });
        saveData(); // L∆∞u l·∫°i tr·∫°ng th√°i ƒë√£ ƒë·ªçc
        document.getElementById('notification-dot').classList.add('hidden'); // ·∫®n ch·∫•m ƒë·ªè
    }
    
    modal.classList.remove('hidden');
}

// ƒê√≥ng modal th√¥ng b√°o (chu√¥ng üîî)
function closeNotificationsModal() {
    document.getElementById('notifications-modal').classList.add('hidden');
}

// Hi·ªÉn th·ªã modal ch·∫•m ƒëi·ªÉm (Admin)
function showGradingModal(logId) {
    const modal = document.getElementById('grading-modal');
    const log = state.activityLog.find(l => l.id === logId);
    
    if (!log || log.details.type !== 'challenge_submission') {
        showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y b√†i n·ªôp.");
        return;
    }
    
    const challenge = state.challenges[log.details.challengeId];
    if (!challenge) {
        showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi (c√≥ th·ªÉ ƒë√£ b·ªã x√≥a).");
        return;
    }
    
    document.getElementById('grading-username').textContent = log.details.username;
    document.getElementById('grading-question').textContent = challenge.question;
    document.getElementById('grading-answer').textContent = log.details.answer;
    
    // L∆∞u ID c·ªßa log v√†o c√°c n√∫t ƒë·ªÉ x·ª≠ l√Ω
    document.getElementById('grading-approve-btn').dataset.logId = logId;
    document.getElementById('grading-reject-btn').dataset.logId = logId;
    
    modal.classList.remove('hidden');
}

// ƒê√≥ng modal ch·∫•m ƒëi·ªÉm
function closeGradingModal() {
    document.getElementById('grading-modal').classList.add('hidden');
}

// ---------- X·ª¨ L√ù S·ª∞ KI·ªÜN CHUNG ----------

function setupEventListeners() {
    // Modal chung
    document.getElementById('modal-close-btn').onclick = closeModal;
    document.getElementById('modal-ok-btn').onclick = closeModal;
    
    document.getElementById('modal-confirm-btn').onclick = () => {
        if (typeof modalConfirmCallback === 'function') {
            modalConfirmCallback();
        }
        closeModal();
    };
    
    document.getElementById('modal-cancel-btn').onclick = () => {
        if (typeof modalCancelCallback === 'function') {
            modalCancelCallback();
        }
        closeModal();
    };
    
    // Modals kh√°c
    document.getElementById('gifts-modal-close-btn').onclick = closeGiftsModal;
    document.getElementById('notifications-modal-close-btn').onclick = closeNotificationsModal;
    document.getElementById('grading-modal-close-btn').onclick = closeGradingModal;
    
    // N√∫t ch·∫•m ƒëi·ªÉm
    document.getElementById('grading-approve-btn').onclick = handleGradeSubmission;
    document.getElementById('grading-reject-btn').onclick = handleGradeSubmission;

    // ƒêƒÉng nh·∫≠p, ƒêƒÉng xu·∫•t
    document.getElementById('login-form').onsubmit = handleLogin;
    document.getElementById('logout-btn-player').onclick = handleLogout;
    document.getElementById('logout-btn-admin').onclick = handleLogout;
    
    // N√∫t chu√¥ng üîî
    document.getElementById('notification-bell-btn').onclick = () => {
        showNotificationsModal(state.currentUser);
    };

    // ƒêi·ªÅu h∆∞·ªõng Tab (Player & Admin)
    document.getElementById('player-nav').onclick = (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.tab) {
            switchPlayerTab(e.target.dataset.tab);
        }
    };
    document.getElementById('admin-nav').onclick = (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.tab) {
            switchAdminTab(e.target.dataset.tab);
        }
    };

    // --- Tab Player ---
    // (Nhi·ªám V·ª•)
    document.getElementById('task-list-player').onclick = handleTaskActions;
    // (Th·ª≠ Th√°ch)
    document.getElementById('challenge-list-player').onclick = handleChallengeActions;
    // (C·ª≠a H√†ng)
    document.getElementById('view-my-gifts-btn').onclick = () => {
        showGiftsModal(state.currentUser.inventory);
    };
    document.getElementById('shop-list-player').onclick = handleShopActions;
    // (V√≤ng Quay)
    document.getElementById('spin-btn').onclick = handleSpinWheel;
    // (C√° Nh√¢n)
    document.getElementById('profile-form').onsubmit = handleProfileUpdate;
    document.getElementById('rank-rules-btn').onclick = () => {
        showModal("Lu·∫≠t Ch∆°i Rank", `
            <ul class="list-disc space-y-2 pl-5 text-gray-300">
                <li>Ho√†n th√†nh 1 nhi·ªám v·ª• (ƒë∆∞·ª£c Admin giao) s·∫Ω tƒÉng <strong>+1 ƒëi·ªÉm Rank</strong>.</li>
                <li>Rank c·ªßa b·∫°n ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n t·ªïng s·ªë ƒëi·ªÉm (nhi·ªám v·ª•) ƒë√£ ho√†n th√†nh.</li>
                <li class="font-semibold text-yellow-400">C√°c m·ªëc Rank:
                    <ul class="list-disc pl-5 mt-1">
                        <li>0-9: Rank S·∫Øt ‚öôÔ∏è</li>
                        <li>10-19: Rank ƒê·ªìng ü•â</li>
                        <li>20-49: Rank B·∫°c ü•à</li>
                        <li>50-99: Rank V√†ng ü•á</li>
                        <li>100+: Rank Kim C∆∞∆°ng üíé</li>
                    </ul>
                </li>
                <li class="font-bold text-red-400">C·∫¢NH B√ÅO: N·∫øu b·∫°n ƒë·ªÉ tr·ªÖ deadline (qu√° h·∫°n) b·∫•t k·ª≥ nhi·ªám v·ª• n√†o, ƒëi·ªÉm Rank c·ªßa b·∫°n s·∫Ω b·ªã <strong>RESET V·ªÄ 0</strong>.</li>
            </ul>
        `);
    };

    // --- Tab Admin ---
    // (User)
    document.getElementById('user-form').onsubmit = handleUserFormSubmit;
    document.getElementById('clear-user-form-btn').onclick = clearUserForm;
    document.getElementById('user-list-tbody').onclick = handleUserActions;
    // (Nhi·ªám V·ª•)
    document.getElementById('task-form').onsubmit = handleTaskFormSubmit;
    document.getElementById('clear-task-form-btn').onclick = clearTaskForm;
    document.getElementById('task-list-tbody').onclick = handleTaskAdminActions;
    // (Th·ª≠ Th√°ch)
    document.getElementById('challenge-type').onchange = toggleChallengeForm;
    document.getElementById('challenge-form').onsubmit = handleChallengeFormSubmit;
    document.getElementById('clear-challenge-form-btn').onclick = clearChallengeForm;
    document.getElementById('challenge-list-tbody').onclick = handleChallengeAdminActions;
    document.getElementById('delete-all-challenges-btn').onclick = () => {
        showModal("X√°c nh·∫≠n X√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ th·ª≠ th√°ch? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.", "confirm", () => {
            state.challenges = {};
            // X√≥a lu√¥n c√°c b√†i ƒë√£ n·ªôp c·ªßa user
            Object.values(state.users).forEach(user => {
                user.challengesDone = {};
            });
            logActivity("Admin ƒë√£ x√≥a t·∫•t c·∫£ th·ª≠ th√°ch.");
            saveData();
            renderChallengeListAdmin();
        });
    };
    // (C·ª≠a H√†ng)
    document.getElementById('shop-form').onsubmit = handleShopFormSubmit;
    document.getElementById('clear-shop-form-btn').onclick = clearShopForm;
    document.getElementById('shop-list-tbody').onclick = handleShopAdminActions;
    // (V√≤ng Quay)
    document.getElementById('wheel-form').onsubmit = handleWheelFormSubmit;
    document.getElementById('clear-wheel-form-btn').onclick = clearWheelForm;
    document.getElementById('wheel-list-tbody').onclick = handleWheelAdminActions;
    document.getElementById('randomize-wheel-btn').onclick = randomizeWheelItems;
    document.getElementById('clear-wheel-btn').onclick = () => {
        showModal("X√°c nh·∫≠n X√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ ph·∫ßn th∆∞·ªüng kh·ªèi v√≤ng quay?", "confirm", () => {
            state.wheelItems = [];
            logActivity("Admin ƒë√£ x√≥a t·∫•t c·∫£ ph·∫ßn th∆∞·ªüng v√≤ng quay.");
            saveData();
            renderWheelListAdmin();
        });
    };
    setupDragDrop(); // K√≠ch ho·∫°t K√©o/Th·∫£
    // (Th√¥ng B√°o)
    document.getElementById('notification-form').onsubmit = handleNotificationSubmit;
    // (L·ªãch S·ª≠)
    document.getElementById('clear-activity-log-btn').onclick = () => {
        showModal("X√°c nh·∫≠n X√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ L·ªãch S·ª≠ Ho·∫°t ƒê·ªông?", "confirm", () => {
            state.activityLog = [];
            saveData();
            renderActivityLog();
        });
    };
    document.getElementById('clear-purchase-log-btn').onclick = () => {
        showModal("X√°c nh·∫≠n X√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a L·ªãch S·ª≠ ƒê·ªïi Qu√† V√Ä kho ƒë·ªì c·ªßa T·∫§T C·∫¢ user?", "confirm", () => {
            // X√≥a log ƒë·ªïi qu√†
            state.activityLog = state.activityLog.filter(log => log.details.type !== 'shop_purchase');
            // X√≥a kho ƒë·ªì (inventory) c·ªßa t·∫•t c·∫£ user
            Object.values(state.users).forEach(user => {
                user.inventory = [];
            });
            logActivity("Admin ƒë√£ x√≥a l·ªãch s·ª≠ ƒë·ªïi qu√† v√† kho ƒë·ªì c·ªßa user.");
            saveData();
            renderActivityLog();
        });
    };
    document.getElementById('clear-notifications-btn').onclick = () => {
        showModal("X√°c nh·∫≠n X√≥a", "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ th√¥ng b√°o (chu√¥ng üîî) c·ªßa T·∫§T C·∫¢ user?", "confirm", () => {
            // X√≥a th√¥ng b√°o (notifications) c·ªßa t·∫•t c·∫£ user
            Object.values(state.users).forEach(user => {
                user.notifications = [];
            });
            logActivity("Admin ƒë√£ x√≥a t·∫•t c·∫£ th√¥ng b√°o (chu√¥ng üîî) c·ªßa user.");
            saveData();
            renderActivityLog(); // Ch·ªâ c·∫ßn render l·∫°i log
        });
    };
    document.getElementById('activity-log-list').onclick = handleActivityLogClick;
}

// ---------- X·ª¨ L√ù ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T ----------

// Hi·ªÉn th·ªã m·ªôt trang (view) v√† ·∫©n c√°c trang kh√°c
function showView(viewId) {
    // ·∫®n t·∫•t c·∫£ c√°c view ch√≠nh
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('player-view').classList.add('hidden');
    document.getElementById('admin-view').classList.add('hidden');
    
    // Hi·ªÉn th·ªã view ƒë∆∞·ª£c y√™u c·∫ßu
    const view = document.getElementById(viewId);
    if (view) {
        view.classList.remove('hidden');
    }
}

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
function handleLogin(e) {
    e.preventDefault();
    const username = e.target.username.value.trim();
    const password = e.target.password.value;
    const rememberMe = document.getElementById('remember-me').checked;
    
    const user = state.users[username];

    if (user && user.password === password) {
        state.currentUser = user;
        
        // X·ª≠ l√Ω "Nh·ªõ m·∫≠t kh·∫©u"
        if (rememberMe) {
            localStorage.setItem('kin_remember_me', JSON.stringify({ username, password }));
        } else {
            localStorage.removeItem('kin_remember_me');
        }
        
        if (username === 'admin') {
            initAdminView();
            showView('admin-view');
        } else {
            // Khi user ƒëƒÉng nh·∫≠p, ki·ªÉm tra c√°c nhi·ªám v·ª• qu√° h·∫°n
            checkTaskDeadlines(user);
            initPlayerView(user);
            showView('player-view');
        }
    } else {
        showModal("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", "T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.");
    }
}

// X·ª≠ l√Ω ƒëƒÉng xu·∫•t
function handleLogout() {
    state.currentUser = null;
    document.getElementById('login-form').reset();
    checkRememberMe(); // T·∫£i l·∫°i th√¥ng tin n·∫øu c√≥
    showView('login-view');
}

// Ki·ªÉm tra "Nh·ªõ m·∫≠t kh·∫©u"
function checkRememberMe() {
    const rememberMeData = localStorage.getItem('kin_remember_me');
    if (rememberMeData) {
        try {
            const { username, password } = JSON.parse(rememberMeData);
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            document.getElementById('remember-me').checked = true;
        } catch (e) {
            localStorage.removeItem('kin_remember_me');
        }
    }
}

// ---------- KHU V·ª∞C NG∆Ø·ªúI CH∆†I (PLAYER) ----------

// Kh·ªüi t·∫°o giao di·ªán Player
function initPlayerView(user) {
    // Render header
    updatePlayerHeader(user);
    
    // Render c√°c tab
    renderTaskListPlayer(user);
    renderChallengeListPlayer(user);
    renderShopListPlayer(user);
    renderWheelPlayer(user); // Render v√≤ng quay
    renderProfile(user);
    
    // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã tab Nhi·ªám V·ª•
    switchPlayerTab('tasks');
}

// C·∫≠p nh·∫≠t Header (Icon, T√™n, Ti·ªÅn)
function updatePlayerHeader(user) {
    document.getElementById('player-header-icon').textContent = user.icon || 'üë§';
    document.getElementById('player-displayname').textContent = user.displayName || user.username;
    document.getElementById('player-username').textContent = user.username;
    document.getElementById('player-balance').textContent = formatCurrency(user.balance);
    
    // C·∫≠p nh·∫≠t ch·∫•m ƒë·ªè th√¥ng b√°o
    const hasUnread = user.notifications.some(n => !n.read);
    document.getElementById('notification-dot').classList.toggle('hidden', !hasUnread);
}

// Chuy·ªÉn tab Player
const playerTabs = {
    tasks: document.getElementById('tasks-tab'),
    challenges: document.getElementById('challenges-tab'),
    shop: document.getElementById('shop-tab'),
    wheel: document.getElementById('wheel-tab'),
    profile: document.getElementById('profile-tab')
};

function switchPlayerTab(tabName) {
    // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
    Object.values(playerTabs).forEach(tab => tab.classList.add('hidden'));
    
    // B·ªè active t·∫•t c·∫£ n√∫t tab
    document.querySelectorAll('#player-nav .player-tab').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
    });
    
    // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
    const tabContent = playerTabs[tabName];
    const tabButton = document.querySelector(`#player-nav .player-tab[data-tab="${tabName}"]`);
    
    if (tabContent) {
        tabContent.classList.remove('hidden');
    }
    if (tabButton) {
        tabButton.classList.add('bg-blue-600', 'text-white');
        tabButton.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
    }
}

// --- Tab 1: Nhi·ªám V·ª• (Player) ---

// Ki·ªÉm tra deadline nhi·ªám v·ª• (Khi ƒëƒÉng nh·∫≠p)
function checkTaskDeadlines(user) {
    let tasksReset = 0;
    const now = new Date();
    
    // L·∫•y c√°c nhi·ªám v·ª• chung
    const availableTasks = Object.values(state.tasks);
    
    availableTasks.forEach(task => {
        const deadline = new Date(task.deadline);
        const taskStatus = user.tasks[task.id];
        
        // N·∫øu nhi·ªám v·ª• t·ªìn t·∫°i V√Ä ch∆∞a ho√†n th√†nh V√Ä ƒë√£ qu√° deadline
        if (deadline < now && taskStatus !== 'completed') {
            // ƒê√°nh d·∫•u l√† ƒë√£ l·ª°
            user.tasks[task.id] = 'missed';
            
            // Tr·ª´ ti·ªÅn ph·∫°t (n·∫øu ch∆∞a b·ªã ph·∫°t)
            if (taskStatus !== 'penalized') {
                user.balance = Math.max(0, user.balance - task.penalty);
                user.tasks[task.id] = 'penalized'; // ƒê√°nh d·∫•u ƒë√£ ph·∫°t
                tasksReset++;
                logActivity(
                    `User ${user.username} ƒë√£ b·ªã ph·∫°t ${formatCurrency(task.penalty)}üí∞ v√¨ tr·ªÖ deadline`,
                    { type: 'task_penalty', username: user.username, taskName: task.name }
                );
            }
        }
    });
    
    // N·∫øu c√≥ √≠t nh·∫•t 1 nhi·ªám v·ª• b·ªã ph·∫°t -> RESET RANK
    if (tasksReset > 0 && user.tasksCompleted > 0) {
        const oldRank = getRankInfo(user.tasksCompleted).name;
        user.tasksCompleted = 0; // Reset rank
        
        const message = `B·∫°n ƒë√£ b·ªã RESET Rank v·ªÅ 0 (Rank S·∫Øt) v√¨ tr·ªÖ deadline ${tasksReset} nhi·ªám v·ª•!`;
        showModal("Rank ƒê√£ B·ªã Reset!", message);
        sendNotification(user.username, message, 'error');
        logActivity(
            `User ${user.username} ƒë√£ b·ªã RESET Rank (t·ª´ ${oldRank}) v√¨ tr·ªÖ deadline.`,
            { type: 'rank_reset', username: user.username }
        );
    }
    
    saveData();
}

// Render danh s√°ch nhi·ªám v·ª•
function renderTaskListPlayer(user) {
    const container = document.getElementById('task-list-player');
    container.innerHTML = '';
    
    const now = new Date();
    // L·ªçc ra c√°c nhi·ªám v·ª• m√† user ch∆∞a ho√†n th√†nh/ch∆∞a l·ª° v√† c√≤n h·∫°n
    const tasksToDo = Object.values(state.tasks).filter(task => {
        const userTaskStatus = user.tasks[task.id];
        const deadline = new Date(task.deadline);
        return userTaskStatus !== 'completed' && userTaskStatus !== 'missed' && userTaskStatus !== 'penalized' && deadline > now;
    });
    
    if (tasksToDo.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh h·∫øt nhi·ªám v·ª•.</p>';
        return;
    }
    
    tasksToDo.sort((a, b) => new Date(a.deadline) - new Date(b.deadline)); // S·∫Øp x·∫øp theo deadline g·∫ßn nh·∫•t
    
    tasksToDo.forEach(task => {
        const div = document.createElement('div');
        div.className = 'p-5 bg-gray-700 rounded-lg shadow-md flex flex-col sm:flex-row justify-between sm:items-center gap-4';
        div.innerHTML = `
            <div>
                <h3 class="text-xl font-bold text-white">${task.name}</h3>
                <p class="text-sm text-gray-300">Th∆∞·ªüng: <span class="font-semibold text-green-400">+${formatCurrency(task.reward)}üí∞</span></p>
                <p class="text-sm text-gray-300">Ph·∫°t (n·∫øu tr·ªÖ): <span class="font-semibold text-red-400">-${formatCurrency(task.penalty)}üí∞</span></p>
                <p class="text-sm text-yellow-400">Deadline: ${formatDateTime(task.deadline)}</p>
            </div>
            <button data-task-id="${task.id}" class="complete-task-btn w-full sm:w-auto text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-6 py-3 transition duration-200">
                Ho√†n Th√†nh
            </button>
        `;
        container.appendChild(div);
    });
}

// X·ª≠ l√Ω khi nh·∫•n n√∫t "Ho√†n Th√†nh"
function handleTaskActions(e) {
    if (e.target.classList.contains('complete-task-btn')) {
        const taskId = e.target.dataset.taskId;
        const task = state.tasks[taskId];
        const user = state.currentUser;
        
        if (task && user) {
            showModal("X√°c nh·∫≠n Ho√†n Th√†nh", `B·∫°n c√≥ ch·∫Øc ƒë√£ ho√†n th√†nh nhi·ªám v·ª•: "${task.name}"?`, "confirm", () => {
                // ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh
                user.tasks[taskId] = 'completed';
                // C·ªông th∆∞·ªüng
                user.balance += task.reward;
                // TƒÉng ƒëi·ªÉm Rank
                user.tasksCompleted += 1;
                
                logActivity(
                    `User ${user.username} ƒë√£ ho√†n th√†nh nhi·ªám v·ª• "${task.name}" v√† nh·∫≠n ${formatCurrency(task.reward)}üí∞.`,
                    { type: 'task_complete', username: user.username, taskName: task.name }
                );
                
                showModal("ƒê√£ Ho√†n Th√†nh!", `B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• v√† nh·∫≠n ƒë∆∞·ª£c <span class="font-bold text-green-400">+${formatCurrency(task.reward)}üí∞</span>. Rank c·ªßa b·∫°n ƒë√£ tƒÉng!`);
                
                saveData();
                
                // Render l·∫°i
                renderTaskListPlayer(user);
                updatePlayerHeader(user);
            });
        }
    }
}

// --- Tab 2: Th·ª≠ Th√°ch (Player) ---

// Render danh s√°ch th·ª≠ th√°ch
function renderChallengeListPlayer(user) {
    const container = document.getElementById('challenge-list-player');
    container.innerHTML = '';
    
    // L·ªçc ra c√°c c√¢u h·ªèi user ch∆∞a l√†m
    const challengesToDo = Object.values(state.challenges).filter(challenge => {
        return !user.challengesDone[challenge.id];
    });
    
    if (challengesToDo.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center">Ch∆∞a c√≥ th·ª≠ th√°ch n√†o h√¥m nay.</p>';
        return;
    }
    
    challengesToDo.forEach(challenge => {
        const div = document.createElement('div');
        div.className = 'p-5 bg-gray-700 rounded-lg shadow-md';
        div.dataset.challengeId = challenge.id;
        
        let content = `
            <h3 class="text-xl font-bold text-white mb-3">${challenge.question}</h3>
            <p class="text-sm text-gray-300 mb-4">Ph·∫ßn th∆∞·ªüng: <span class="font-semibold text-green-400">+${formatCurrency(challenge.reward)}üí∞</span></p>
        `;
        
        if (challenge.type === 'mcq') {
            // Tr·∫Øc nghi·ªám
            content += `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button data-answer="1" class="challenge-answer-btn text-left w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">${challenge.op1}</button>
                    <button data-answer="2" class="challenge-answer-btn text-left w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">${challenge.op2}</button>
                    <button data-answer="3" class="challenge-answer-btn text-left w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">${challenge.op3}</button>
                    <button data-answer="4" class="challenge-answer-btn text-left w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">${challenge.op4}</button>
                </div>
            `;
        } else {
            // T·ª± lu·∫≠n
            content += `
                <div class="space-y-3">
                    <textarea class="challenge-text-answer bg-gray-600 border border-gray-500 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>
                    <button class="challenge-submit-btn w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">N·ªôp B√†i T·ª± Lu·∫≠n</button>
                </div>
            `;
        }
        
        // N√∫t xem gi·∫£i th√≠ch (·∫©n)
        content += `<button class="view-explanation-btn hidden w-full mt-3 text-white bg-gray-500 hover:bg-gray-600 font-medium rounded-lg text-sm px-5 py-3 transition duration-200">Xem Gi·∫£i Th√≠ch</button>`;
        
        div.innerHTML = content;
        container.appendChild(div);
    });
}

// X·ª≠ l√Ω c√°c h√†nh ƒë·ªông trong tab Th·ª≠ Th√°ch (click n√∫t)
function handleChallengeActions(e) {
    const user = state.currentUser;
    const challengeCard = e.target.closest('.p-5[data-challenge-id]');
    if (!challengeCard) return;
    
    const challengeId = challengeCard.dataset.challengeId;
    const challenge = state.challenges[challengeId];
    if (!challenge) return;

    // 1. Nh·∫•n n√∫t Tr·∫£ L·ªùi Tr·∫Øc Nghi·ªám
    if (e.target.classList.contains('challenge-answer-btn')) {
        const selectedAnswer = e.target.dataset.answer;
        
        // V√¥ hi·ªáu h√≥a c√°c n√∫t
        challengeCard.querySelectorAll('.challenge-answer-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            // T√¥ m√†u
            if (btn.dataset.answer === challenge.answer) {
                btn.classList.add('bg-green-600', 'hover:bg-green-600'); // ƒê√°p √°n ƒë√∫ng
            }
        });
        
        if (selectedAnswer === challenge.answer) {
            // Tr·∫£ l·ªùi ƒê√öNG
            user.balance += challenge.reward;
            user.challengesDone[challenge.id] = 'correct';
            showModal("ƒê√∫ng r·ªìi!", `Tuy·ªát v·ªùi! B·∫°n nh·∫≠n ƒë∆∞·ª£c <span class="font-bold text-green-400">+${formatCurrency(challenge.reward)}üí∞</span>.`);
            
            logActivity(
                `User ${user.username} tr·∫£ l·ªùi ƒë√∫ng th·ª≠ th√°ch "${challenge.question}" v√† nh·∫≠n ${formatCurrency(challenge.reward)}üí∞.`,
                { type: 'challenge_correct', username: user.username, challengeId: challenge.id }
            );
            
            saveData();
            updatePlayerHeader(user);
            renderShopListPlayer(user); // C·∫≠p nh·∫≠t shop (n·∫øu ƒë·ªß ti·ªÅn)
            
            // Hi·ªán n√∫t xem gi·∫£i th√≠ch
            challengeCard.querySelector('.view-explanation-btn').classList.remove('hidden');
            
        } else {
            // Tr·∫£ l·ªùi SAI
            e.target.classList.add('bg-red-600', 'hover:bg-red-600'); // ƒê√°p √°n sai
            challengeCard.classList.add('shake-error');
            setTimeout(() => challengeCard.classList.remove('shake-error'), 500);
            
            const penalty = 5;
            if (user.balance >= penalty) {
                // H·ªèi th·ª≠ l·∫°i
                showModal("Sai r·ªìi!", `B·∫°n c√≥ mu·ªën d√πng 5üí∞ ƒë·ªÉ th·ª≠ l·∫°i kh√¥ng?`, "confirm",
                    // OK (Th·ª≠ l·∫°i)
                    () => {
                        user.balance -= penalty;
                        // K√≠ch ho·∫°t l·∫°i c√°c n√∫t
                        challengeCard.querySelectorAll('.challenge-answer-btn').forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-green-600', 'hover:bg-green-600', 'bg-red-600', 'hover:bg-red-600');
                        });
                        saveData();
                        updatePlayerHeader(user);
                    },
                    // Cancel (Kh√¥ng th·ª≠ l·∫°i)
                    () => {
                        user.challengesDone[challenge.id] = 'wrong';
                        saveData();
                        // Hi·ªán n√∫t xem gi·∫£i th√≠ch
                        challengeCard.querySelector('.view-explanation-btn').classList.remove('hidden');
                    }
                );
            } else {
                // Kh√¥ng ƒë·ªß ti·ªÅn th·ª≠ l·∫°i
                showModal("Sai r·ªìi!", "B·∫°n ƒë√£ tr·∫£ l·ªùi sai v√† kh√¥ng ƒë·ªß ti·ªÅn (5üí∞) ƒë·ªÉ th·ª≠ l·∫°i.");
                user.challengesDone[challenge.id] = 'wrong';
                saveData();
                // Hi·ªán n√∫t xem gi·∫£i th√≠ch
                challengeCard.querySelector('.view-explanation-btn').classList.remove('hidden');
            }
        }
    }
    
    // 2. Nh·∫•n n√∫t N·ªôp B√†i T·ª± Lu·∫≠n
    if (e.target.classList.contains('challenge-submit-btn')) {
        const answerText = challengeCard.querySelector('.challenge-text-answer').value;
        if (!answerText.trim()) {
            showModal("L·ªói", "Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.");
            return;
        }
        
        // ƒê√°nh d·∫•u ƒë√£ l√†m v√† ch·ªù ch·∫•m
        user.challengesDone[challenge.id] = 'pending_grading';
        
        // G·ª≠i log cho Admin
        logActivity(
            `User ${user.username} ƒë√£ n·ªôp b√†i t·ª± lu·∫≠n cho c√¢u: "${challenge.question}"`,
            { 
                type: 'challenge_submission', 
                username: user.username, 
                challengeId: challenge.id,
                answer: answerText
            }
        );
        
        saveData();
        showModal("ƒê√£ N·ªôp B√†i!", "C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. Vui l√≤ng ch·ªù Admin ch·∫•m ƒëi·ªÉm.");
        
        // ·∫®n c√¢u h·ªèi n√†y ƒëi
        renderChallengeListPlayer(user);
    }
    
    // 3. Nh·∫•n n√∫t Xem Gi·∫£i Th√≠ch
    if (e.target.classList.contains('view-explanation-btn')) {
        let explanationBody = '';
        
        if (challenge.explanationText) {
            explanationBody += `<p class="mb-4">${challenge.explanationText}</p>`;
        }
        if (challenge.explanationImg) {
            explanationBody += `<img src="${challenge.explanationImg}" alt="H√¨nh ·∫£nh gi·∫£i th√≠ch" class="w-full h-auto rounded-lg" onerror="this.alt='Kh√¥ng th·ªÉ t·∫£i ·∫£nh'; this.src='';">`;
        }
        if (!explanationBody) {
            explanationBody = '<p>Admin ch∆∞a cung c·∫•p gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y.</p>';
        }
        
        showModal("Gi·∫£i Th√≠ch ƒê√°p √Ån", explanationBody, "alert", 
            // Callback khi nh·∫•n OK
            () => {
                // T·ª± ƒë·ªông ·∫©n c√¢u h·ªèi sau khi xem
                renderChallengeListPlayer(user);
            }
        );
        
        // Thay ƒë·ªïi n√∫t OK (n·∫øu d√πng modal 'alert')
        const okBtn = document.getElementById('modal-ok-btn');
        okBtn.onclick = () => {
            closeModal();
            renderChallengeListPlayer(user);
        };
    }
}

// --- Tab 3: C·ª≠a H√†ng (Player) ---

// Render danh s√°ch c·ª≠a h√†ng
function renderShopListPlayer(user) {
    const container = document.getElementById('shop-list-player');
    container.innerHTML = '';
    
    const items = Object.values(state.shopItems);
    
    if (items.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t.</p>';
        return;
    }
    
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'p-5 bg-gray-700 rounded-lg shadow-md flex flex-col justify-between';
        
        const isSale = item.salePercent > 0;
        const finalPrice = Math.round(item.price * (1 - (item.salePercent || 0) / 100));
        const canAfford = user.balance >= finalPrice;
        
        let priceHtml = '';
        if (isSale) {
            priceHtml = `
                <div class="flex items-center gap-2">
                    <span class="text-xl text-gray-400 line-through">üí∞ ${formatCurrency(item.price)}</span>
                    <span class="text-2xl font-bold text-green-400">üí∞ ${formatCurrency(finalPrice)}</span>
                </div>
            `;
        } else {
            priceHtml = `<p class="text-2xl font-bold text-green-400">üí∞ ${formatCurrency(finalPrice)}</p>`;
        }
        
        div.innerHTML = `
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-white">${item.name}</h3>
                    ${isSale ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">-${item.salePercent}%</span>` : ''}
                </div>
                ${priceHtml}
            </div>
            <button data-item-id="${item.id}" 
                class="buy-item-btn w-full text-white font-medium rounded-lg text-sm px-5 py-3 transition duration-200 
                ${canAfford ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-500 cursor-not-allowed opacity-50'}"
                ${canAfford ? '' : 'disabled'}>
                Mua Ngay
            </button>
        `;
        container.appendChild(div);
    });
}

// X·ª≠ l√Ω khi nh·∫•n "Mua Ngay"
function handleShopActions(e) {
    if (e.target.classList.contains('buy-item-btn')) {
        const itemId = e.target.dataset.itemId;
        const item = state.shopItems[itemId];
        const user = state.currentUser;
        
        if (item && user) {
            const finalPrice = Math.round(item.price * (1 - (item.salePercent || 0) / 100));
            
            if (user.balance >= finalPrice) {
                user.balance -= finalPrice;
                user.inventory.push({
                    id: item.id,
                    name: item.name,
                    purchaseDate: getCurrentISOTime()
                });
                
                logActivity(
                    `User ${user.username} ƒë√£ ƒë·ªïi v·∫≠t ph·∫©m "${item.name}" v·ªõi gi√° ${formatCurrency(finalPrice)}üí∞.`,
                    { type: 'shop_purchase', username: user.username, itemName: item.name, price: finalPrice }
                );
                
                saveData();
                
                // C·∫≠p nh·∫≠t giao di·ªán
                updatePlayerHeader(user);
                renderShopListPlayer(user); // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
                
                // Hi·ªÉn th·ªã th√¥ng b√°o v√† m≈©i t√™n
                showModal("ƒê·ªïi Qu√† Th√†nh C√¥ng!", `B·∫°n ƒë√£ ƒë·ªïi th√†nh c√¥ng "${item.name}".`);
                const pointer = document.getElementById('view-gifts-pointer');
                pointer.classList.remove('hidden');
                setTimeout(() => pointer.classList.add('hidden'), 5000); // T·ª± ·∫©n sau 5s
                
            } else {
                showModal("Kh√¥ng ƒê·ªß Ti·ªÅn", "B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ ƒë·ªïi v·∫≠t ph·∫©m n√†y.");
            }
        }
    }
}

// --- Tab 4: V√≤ng Quay (Player) ---

// Render v√≤ng quay
function renderWheelPlayer(user) {
    const wheel = document.getElementById('wheel');
    const spinBtn = document.getElementById('spin-btn');
    const spinTimer = document.getElementById('spin-timer');
    wheel.innerHTML = '';
    
    const items = state.wheelItems;
    if (items.length === 0) {
        wheel.style.background = '#374151'; // gray-700
        spinBtn.disabled = true;
        spinTimer.textContent = 'V√≤ng quay ƒëang ƒë∆∞·ª£c b·∫£o tr√¨.';
        return;
    }
    
    // Ki·ªÉm tra th·ªùi gian ch·ªù
    const now = Date.now();
    const lastSpin = user.lastSpin || 0;
    const cooldownMs = WHEEL_COOLDOWN_HOURS * 60 * 60 * 1000;
    const timeRemaining = lastSpin + cooldownMs - now;
    
    if (timeRemaining > 0) {
        spinBtn.disabled = true;
        const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        spinTimer.textContent = `Vui l√≤ng quay l·∫°i sau ${hours} gi·ªù ${minutes} ph√∫t.`;
    } else {
        spinBtn.disabled = false;
        spinTimer.textContent = 'B·∫°n c√≥ 1 l∆∞·ª£t quay mi·ªÖn ph√≠!';
    }
    
    // T√≠nh to√°n g√≥c
    const numItems = items.length;
    const degree = 360 / numItems;
    const skew = numItems > 2 ? 90 - degree : 0;
    
    // C·∫∑p m√†u ƒë·ªÉ xen k·∫Ω
    const colors = ['#60a5fa', '#a78bfa', '#f87171', '#fbbf24', '#34d399', '#f472b6'];
    
    items.forEach((item, i) => {
        const slice = document.createElement('div');
        slice.className = 'wheel-slice';
        slice.style.setProperty('--i', i);
        slice.style.setProperty('--degree', `${degree}deg`);
        slice.style.setProperty('--skew', skew);
        
        let color = colors[i % colors.length];
        // ƒê·ªïi m√†u cho C·ªông/Tr·ª´ ti·ªÅn
        if (item.type === 'add_money') color = '#22c55e'; // green-500
        if (item.type === 'subtract_money') color = '#ef4444'; // red-500
        
        slice.style.background = color;
        
        // Hi·ªÉn th·ªã t√™n (ng·∫Øn)
        const name = item.name.length > 15 ? item.name.substring(0, 13) + '...' : item.name;
        slice.textContent = name;
        
        wheel.appendChild(slice);
    });
}

// X·ª≠ l√Ω quay v√≤ng quay
function handleSpinWheel() {
    const user = state.currentUser;
    const items = state.wheelItems;
    if (items.length === 0) return;
    
    // Ki·ªÉm tra l·∫°i th·ªùi gian (ph√≤ng tr∆∞·ªùng h·ª£p click nhanh)
    const now = Date.now();
    const lastSpin = user.lastSpin || 0;
    const cooldownMs = WHEEL_COOLDOWN_HOURS * 60 * 60 * 1000;
    
    if (now - lastSpin < cooldownMs) {
        showModal("Ch∆∞a ƒê·∫øn L∆∞·ª£t", "B·∫°n c·∫ßn ch·ªù ƒë·ªß 24 gi·ªù ƒë·ªÉ quay l·∫°i.");
        return;
    }
    
    // B·∫Øt ƒë·∫ßu quay
    user.lastSpin = now; // ƒê·∫∑t th·ªùi gian ch·ªù ngay l·∫≠p t·ª©c
    saveData();
    
    const spinBtn = document.getElementById('spin-btn');
    const wheel = document.getElementById('wheel');
    spinBtn.disabled = true;
    
    // T√≠nh to√°n k·∫øt qu·∫£
    const numItems = items.length;
    const degreePerItem = 360 / numItems;
    
    // Ch·ªçn 1 √¥ ng·∫´u nhi√™n
    const randomIndex = Math.floor(Math.random() * numItems);
    const resultItem = items[randomIndex];
    
    // T√≠nh g√≥c quay:
    // 5-10 v√≤ng quay ƒë·∫ßy ƒë·ªß (360 ƒë·ªô)
    const randomRotations = (Math.floor(Math.random() * 6) + 5) * 360;
    // G√≥c ƒë·ªÉ tr·ªè v√†o ƒë√∫ng √¥ (tr·ª´ ƒëi 1 n·ª≠a √¥ ƒë·ªÉ cƒÉn gi·ªØa)
    // Ph·∫£i quay ng∆∞·ª£c (d·∫•u tr·ª´)
    const resultAngle = (randomIndex * degreePerItem) + (degreePerItem / 2);
    // T·ªïng g√≥c quay (quay ng∆∞·ª£c)
    const totalRotation = -(randomRotations + resultAngle);
    
    // Reset g√≥c quay (n·∫øu c√≥)
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';
    
    // B·∫Øt ƒë·∫ßu animation
    setTimeout(() => {
        wheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
        wheel.style.transform = `rotate(${totalRotation}deg)`;
    }, 100);
    
    // X·ª≠ l√Ω k·∫øt qu·∫£ sau khi quay xong
    setTimeout(() => {
        handleWheelResult(user, resultItem);
        // C·∫≠p nh·∫≠t l·∫°i giao di·ªán n√∫t quay (hi·ªÉn th·ªã timer)
        renderWheelPlayer(user);
    }, 5500); // 500ms sau khi animation 5s k·∫øt th√∫c
}

// X·ª≠ l√Ω k·∫øt qu·∫£ V√≤ng Quay
function handleWheelResult(user, item) {
    let title = "Ch√∫c m·ª´ng!";
    let message = `B·∫°n ƒë√£ quay tr√∫ng: <span class="font-bold text-yellow-400">${item.name}</span>!`;

    switch (item.type) {
        case 'add_money':
            const amountAdd = parseInt(item.value, 10);
            if (!isNaN(amountAdd)) {
                user.balance += amountAdd;
                title = "ƒê∆∞·ª£c C·ªông Ti·ªÅn!";
                message = `B·∫°n ƒë√£ quay tr√∫ng "${item.name}" v√† ƒë∆∞·ª£c c·ªông <span class="font-bold text-green-400">+${formatCurrency(amountAdd)}üí∞</span>!`;
                logActivity(`User ${user.username} quay tr√∫ng C·ªòNG TI·ªÄN: +${formatCurrency(amountAdd)}üí∞`, { type: 'wheel_win' });
            }
            break;
            
        case 'subtract_money':
            const amountSub = parseInt(item.value, 10);
            if (!isNaN(amountSub)) {
                user.balance = Math.max(0, user.balance - amountSub);
                title = "B·ªã Tr·ª´ Ti·ªÅn!";
                message = `B·∫°n ƒë√£ quay tr√∫ng "${item.name}" v√† b·ªã tr·ª´ <span class="font-bold text-red-400">-${formatCurrency(amountSub)}üí∞</span>!`;
                logActivity(`User ${user.username} quay tr√∫ng TR·ª™ TI·ªÄN: -${formatCurrency(amountSub)}üí∞`, { type: 'wheel_lose' });
            }
            break;
            
        case 'item':
            user.inventory.push({
                id: generateId(), // ƒê√¢y l√† v·∫≠t ph·∫©m t·ª´ v√≤ng quay, kh√¥ng ph·∫£i t·ª´ shop
                name: item.value, // Gi√° tr·ªã l√† t√™n v·∫≠t ph·∫©m
                purchaseDate: getCurrentISOTime()
            });
            message = `B·∫°n ƒë√£ quay tr√∫ng v·∫≠t ph·∫©m: <span class="font-bold text-blue-400">${item.value}</span>! V·∫≠t ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o kho (Xem ·ªü C·ª≠a H√†ng).`;
            logActivity(`User ${user.username} quay tr√∫ng V·∫¨T PH·∫®M: ${item.value}`, { type: 'wheel_win' });
            break;
            
        case 'text':
        default:
            // Ch·ªâ hi·ªán th√¥ng b√°o
            logActivity(`User ${user.username} quay tr√∫ng: ${item.name}`, { type: 'wheel_spin' });
            break;
    }
    
    showModal(title, message);
    saveData();
    updatePlayerHeader(user); // C·∫≠p nh·∫≠t ti·ªÅn (n·∫øu c√≥)
    renderShopListPlayer(user); // C·∫≠p nh·∫≠t shop (n·∫øu user ƒë·ªß ti·ªÅn mua g√¨ ƒë√≥)
}

// --- Tab 5: C√° Nh√¢n (Player) ---

// Render trang c√° nh√¢n
function renderProfile(user) {
    document.getElementById('profile-icon-display').textContent = user.icon || 'üë§';
    document.getElementById('profile-displayname').value = user.displayName || '';
    document.getElementById('profile-icon').value = user.icon || '';
    document.getElementById('profile-password').value = ''; // Lu√¥n tr·ªëng
    
    // Render Rank
    const rankInfo = getRankInfo(user.tasksCompleted);
    document.getElementById('profile-rank-icon').textContent = rankInfo.icon;
    document.getElementById('profile-rank-name').textContent = rankInfo.name;
    document.getElementById('profile-rank-name').className = `text-3xl font-bold mt-2 ${rankInfo.color}`;
    document.getElementById('profile-rank-tasks').textContent = `${user.tasksCompleted} nhi·ªám v·ª• ƒë√£ ho√†n th√†nh`;

    // Render Cooldowns
    renderCooldownMessage('name', user.cooldowns.displayName);
    renderCooldownMessage('icon', user.cooldowns.icon);
    renderCooldownMessage('password', user.cooldowns.password);
}

// Hi·ªÉn th·ªã th√¥ng b√°o cooldown
function renderCooldownMessage(type, cooldownDate) {
    const el = document.getElementById(`cooldown-${type}`);
    const inputEl = document.getElementById(`profile-${type === 'name' ? 'displayname' : type}`);
    
    if (cooldownDate && new Date(cooldownDate) > new Date()) {
        const remainingDays = Math.ceil((new Date(cooldownDate) - new Date()) / (1000 * 60 * 60 * 24));
        el.textContent = `B·∫°n c·∫ßn ch·ªù ${remainingDays} ng√†y n·ªØa ƒë·ªÉ ƒë·ªïi l·∫°i.`;
        el.classList.remove('hidden');
        if (inputEl) inputEl.disabled = true;
        if(type === 'password') inputEl.placeholder = "ƒêang trong th·ªùi gian ch·ªù...";
    } else {
        el.textContent = '';
        el.classList.add('hidden');
        if (inputEl) inputEl.disabled = false;
        if(type === 'password') inputEl.placeholder = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    }
}

// X·ª≠ l√Ω c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n
function handleProfileUpdate(e) {
    e.preventDefault();
    const user = state.currentUser;
    const now = new Date();
    
    const newDisplayName = document.getElementById('profile-displayname').value;
    const newIcon = document.getElementById('profile-icon').value;
    const newPassword = document.getElementById('profile-password').value;
    
    let changed = false;
    
    // T√≠nh ng√†y h·∫øt h·∫°n cooldown
    const cooldownEndDate = new Date(now.getTime() + COOLDOWN_DAYS * 24 * 60 * 60 * 1000).toISOString();

    // 1. ƒê·ªïi T√™n Hi·ªÉn Th·ªã
    if (newDisplayName && newDisplayName !== (user.displayName || '')) {
        user.displayName = newDisplayName;
        user.cooldowns.displayName = cooldownEndDate;
        changed = true;
    }
    
    // 2. ƒê·ªïi Icon
    if (newIcon && newIcon !== (user.icon || '')) {
        user.icon = newIcon;
        user.cooldowns.icon = cooldownEndDate;
        changed = true;
    }
    
    // 3. ƒê·ªïi M·∫≠t Kh·∫©u
    if (newPassword) {
        user.password = newPassword;
        user.cooldowns.password = cooldownEndDate;
        changed = true;
    }
    
    if (changed) {
        saveData();
        renderProfile(user);
        updatePlayerHeader(user); // C·∫≠p nh·∫≠t icon/t√™n ·ªü header
        showModal("Th√†nh C√¥ng", "Th√¥ng tin c√° nh√¢n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
    } else {
        showModal("Kh√¥ng Thay ƒê·ªïi", "B·∫°n ch∆∞a thay ƒë·ªïi th√¥ng tin n√†o.");
    }
}


// ---------- KHU V·ª∞C QU·∫¢N TR·ªä (ADMIN) ----------

// Kh·ªüi t·∫°o giao di·ªán Admin
function initAdminView() {
    // Render c√°c tab
    renderUserList();
    renderTaskListAdmin();
    renderChallengeListAdmin();
    renderShopListAdmin();
    renderWheelListAdmin();
    renderActivityLog();
    
    // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã tab User
    switchAdminTab('userMgmt');
}

// Chuy·ªÉn tab Admin
const adminTabs = {
    userMgmt: document.getElementById('user-mgmt-tab'),
    taskMgmt: document.getElementById('task-mgmt-tab'),
    challengeMgmt: document.getElementById('challenge-mgmt-tab'),
    shopMgmt: document.getElementById('shop-mgmt-tab'),
    wheelMgmt: document.getElementById('wheel-mgmt-tab'),
    notifyMgmt: document.getElementById('notify-mgmt-tab'),
    activityLog: document.getElementById('activity-log-tab')
};

function switchAdminTab(tabName) {
    // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
    Object.values(adminTabs).forEach(tab => tab.classList.add('hidden'));
    
    // B·ªè active t·∫•t c·∫£ n√∫t tab
    document.querySelectorAll('#admin-nav .admin-tab').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
    });
    
    // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
    const tabContent = adminTabs[tabName];
    const tabButton = document.querySelector(`#admin-nav .admin-tab[data-tab="${tabName}"]`);
    
    if (tabContent) {
        tabContent.classList.remove('hidden');
    }
    if (tabButton) {
        tabButton.classList.add('bg-blue-600', 'text-white');
        tabButton.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
    }
}

// --- Tab 1: Qu·∫£n L√≠ Ng∆∞·ªùi D√πng (Admin) ---

// X√≥a form user
function clearUserForm() {
    document.getElementById('user-form').reset();
    document.getElementById('user-username').readOnly = false;
    document.getElementById('user-username').classList.remove('bg-gray-500', 'cursor-not-allowed');
}

// Render danh s√°ch user
function renderUserList() {
    const tbody = document.getElementById('user-list-tbody');
    tbody.innerHTML = '';
    
    Object.values(state.users).forEach(user => {
        if (user.username === 'admin') return; // Kh√¥ng hi·ªÉn th·ªã admin
        
        const rankInfo = getRankInfo(user.tasksCompleted);
        
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700';
        tr.innerHTML = `
            <td class="py-4 px-6">
                <div class="user-icon user-icon-sm">${user.icon || 'üë§'}</div>
            </td>
            <td class="py-4 px-6 font-medium text-white">${user.displayName || '(ch∆∞a ƒë·∫∑t)'}</td>
            <td class="py-4 px-6 text-gray-400">${user.username}</td>
            <td class="py-4 px-6">üí∞ ${formatCurrency(user.balance)}</td>
            <td class="py-4 px-6">
                <span class="${rankInfo.color} font-semibold">${rankInfo.icon} ${user.tasksCompleted}</span>
            </td>
            <td class="py-4 px-6 space-x-2">
                <button type="button" data-username="${user.username}" class="edit-user-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                <button type="button" data-username="${user.username}" class="delete-user-btn text-red-400 hover:text-red-300 font-medium">X√≥a</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// X·ª≠ l√Ω Th√™m/S·ª≠a User
function handleUserFormSubmit(e) {
    e.preventDefault();
    const username = document.getElementById('user-username').value.trim();
    const displayName = document.getElementById('user-displayname').value;
    const icon = document.getElementById('user-icon').value;
    const password = document.getElementById('user-password').value;
    const balance = parseInt(document.getElementById('user-balance').value, 10);
    const tasksCompleted = parseInt(document.getElementById('user-tasks-completed').value, 10);
    
    if (!username || !password) {
        showModal("L·ªói", "T√†i kho·∫£n v√† M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc.");
        return;
    }
    
    // Ki·ªÉm tra xem ƒëang S·ª≠a hay Th√™m
    const isEditing = document.getElementById('user-username').readOnly;
    
    if (isEditing) {
        // S·ª≠a User
        const user = state.users[username];
        if (user) {
            user.displayName = displayName;
            user.icon = icon;
            user.password = password;
            user.balance = isNaN(balance) ? user.balance : balance;
            user.tasksCompleted = isNaN(tasksCompleted) ? user.tasksCompleted : tasksCompleted;
            logActivity(`Admin ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin user: ${username}`);
            showModal("Th√†nh C√¥ng", `ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin cho user ${username}.`);
        }
    } else {
        // Th√™m User
        if (state.users[username]) {
            showModal("L·ªói", "T√†i kho·∫£n n√†y ƒë√£ t·ªìn t·∫°i.");
            return;
        }
        state.users[username] = {
            username: username,
            password: password,
            displayName: displayName || username, // M·∫∑c ƒë·ªãnh l√† username
            icon: icon || 'üë§',
            balance: isNaN(balance) ? 0 : balance,
            inventory: [],
            notifications: [],
            cooldowns: {}, // { displayName, icon, password }
            tasksCompleted: isNaN(tasksCompleted) ? 0 : tasksCompleted,
            tasks: {}, // { taskId: 'completed' | 'missed' | 'penalized' }
            challengesDone: {}, // { challengeId: 'correct' | 'wrong' | 'pending_grading' }
            lastSpin: 0,
        };
        logActivity(`Admin ƒë√£ t·∫°o user m·ªõi: ${username}`);
        showModal("Th√†nh C√¥ng", `ƒê√£ t·∫°o user m·ªõi: ${username}.`);
    }
    
    saveData();
    renderUserList();
    clearUserForm();
}

// X·ª≠ l√Ω click S·ª≠a/X√≥a User
function handleUserActions(e) {
    const username = e.target.dataset.username;
    if (!username) return;
    
    const user = state.users[username];
    if (!user) return;
    
    if (e.target.classList.contains('edit-user-btn')) {
        // S·ª≠a User
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-username').readOnly = true; // Kh√≥a username
        document.getElementById('user-username').classList.add('bg-gray-500', 'cursor-not-allowed');
        
        document.getElementById('user-displayname').value = user.displayName || '';
        document.getElementById('user-icon').value = user.icon || '';
        document.getElementById('user-password').value = user.password;
        document.getElementById('user-balance').value = user.balance;
        document.getElementById('user-tasks-completed').value = user.tasksCompleted;
        
        window.scrollTo(0, 0); // Cu·ªôn l√™n ƒë·∫ßu trang
        
    } else if (e.target.classList.contains('delete-user-btn')) {
        // X√≥a User
        showModal("X√°c nh·∫≠n X√≥a", `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn user ${username}?`, "confirm", () => {
            delete state.users[username];
            logActivity(`Admin ƒë√£ x√≥a user: ${username}`);
            saveData();
            renderUserList();
        });
    }
}

// --- Tab 2: Qu·∫£n L√≠ Nhi·ªám V·ª• (Admin) ---

// X√≥a form nhi·ªám v·ª•
function clearTaskForm() {
    document.getElementById('task-form').reset();
    document.getElementById('task-id').value = '';
}

// Render danh s√°ch nhi·ªám v·ª•
function renderTaskListAdmin() {
    const tbody = document.getElementById('task-list-tbody');
    tbody.innerHTML = '';
    
    Object.values(state.tasks).forEach(task => {
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700';
        tr.innerHTML = `
            <td class="py-4 px-6 font-medium text-white">${task.name}</td>
            <td class="py-4 px-6">
                <span class="text-green-400">+${formatCurrency(task.reward)}</span> / 
                <span class="text-red-400">-${formatCurrency(task.penalty)}</span>
            </td>
            <td class="py-4 px-6">${formatDateTime(task.deadline)}</td>
            <td class="py-4 px-6 space-x-2">
                <button type="button" data-task-id="${task.id}" class="edit-task-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                <button type="button" data-task-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-300 font-medium">X√≥a</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// X·ª≠ l√Ω Th√™m/S·ª≠a Nhi·ªám V·ª•
function handleTaskFormSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('task-id').value;
    const name = document.getElementById('task-name').value.trim();
    const reward = parseInt(document.getElementById('task-reward').value, 10);
    const penalty = parseInt(document.getElementById('task-penalty').value, 10);
    const deadline = document.getElementById('task-deadline').value;
    
    if (!name || isNaN(reward) || isNaN(penalty) || !deadline) {
        showModal("L·ªói", "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
        return;
    }
    
    if (id) {
        // S·ª≠a
        state.tasks[id] = { ...state.tasks[id], name, reward, penalty, deadline };
        logActivity(`Admin ƒë√£ c·∫≠p nh·∫≠t nhi·ªám v·ª•: ${name}`);
    } else {
        // Th√™m
        const newId = generateId();
        state.tasks[newId] = { id: newId, name, reward, penalty, deadline };
        logActivity(`Admin ƒë√£ t·∫°o nhi·ªám v·ª• m·ªõi: ${name}`);
    }
    
    saveData();
    renderTaskListAdmin();
    clearTaskForm();
}

// X·ª≠ l√Ω click S·ª≠a/X√≥a Nhi·ªám V·ª•
function handleTaskAdminActions(e) {
    const taskId = e.target.dataset.taskId;
    if (!taskId) return;
    
    const task = state.tasks[taskId];
    if (!task) return;
    
    if (e.target.classList.contains('edit-task-btn')) {
        // S·ª≠a
        document.getElementById('task-id').value = task.id;
        document.getElementById('task-name').value = task.name;
        document.getElementById('task-reward').value = task.reward;
        document.getElementById('task-penalty').value = task.penalty;
        document.getElementById('task-deadline').value = task.deadline;
        window.scrollTo(0, 0);
        
    } else if (e.target.classList.contains('delete-task-btn')) {
        // X√≥a
        showModal("X√°c nh·∫≠n X√≥a", `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nhi·ªám v·ª• "${task.name}"?`, "confirm", () => {
            delete state.tasks[taskId];
            // X√≥a lu√¥n nhi·ªám v·ª• n√†y kh·ªèi user
            Object.values(state.users).forEach(user => {
                delete user.tasks[taskId];
            });
            logActivity(`Admin ƒë√£ x√≥a nhi·ªám v·ª•: ${task.name}`);
            saveData();
            renderTaskListAdmin();
        });
    }
}

// --- Tab 3: Qu·∫£n L√≠ Th·ª≠ Th√°ch (Admin) ---

// X√≥a form th·ª≠ th√°ch
function clearChallengeForm() {
    document.getElementById('challenge-form').reset();
    document.getElementById('challenge-id').value = '';
    toggleChallengeForm(); // ƒê·∫∑t v·ªÅ tr·∫°ng th√°i tr·∫Øc nghi·ªám m·∫∑c ƒë·ªãnh
}

// ·∫®n/Hi·ªán c√°c √¥ tr·∫Øc nghi·ªám
function toggleChallengeForm() {
    const type = document.getElementById('challenge-type').value;
    const mcqOptions = document.getElementById('mcq-options');
    if (type === 'mcq') {
        mcqOptions.classList.remove('hidden');
    } else {
        mcqOptions.classList.add('hidden');
    }
}

// Render danh s√°ch th·ª≠ th√°ch
function renderChallengeListAdmin() {
    const tbody = document.getElementById('challenge-list-tbody');
    tbody.innerHTML = '';
    
    Object.values(state.challenges).forEach(challenge => {
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700';
        tr.innerHTML = `
            <td class="py-4 px-6 font-medium text-white">${challenge.question.substring(0, 50)}...</td>
            <td class="py-4 px-6">${challenge.type === 'mcq' ? 'Tr·∫Øc nghi·ªám' : 'T·ª± lu·∫≠n'}</td>
            <td class="py-4 px-6">üí∞ ${formatCurrency(challenge.reward)}</td>
            <td class="py-4 px-6 space-x-2">
                <button type="button" data-challenge-id="${challenge.id}" class="edit-challenge-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                <button type="button" data-challenge-id="${challenge.id}" class="delete-challenge-btn text-red-400 hover:text-red-300 font-medium">X√≥a</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// X·ª≠ l√Ω Th√™m/S·ª≠a Th·ª≠ Th√°ch
function handleChallengeFormSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('challenge-id').value;
    const type = document.getElementById('challenge-type').value;
    const question = document.getElementById('challenge-question').value.trim();
    const reward = parseInt(document.getElementById('challenge-reward').value, 10);
    const explanationText = document.getElementById('challenge-explanation-text').value.trim();
    const explanationImg = document.getElementById('challenge-explanation-img').value.trim();
    
    if (!question || isNaN(reward)) {
        showModal("L·ªói", "Vui l√≤ng ƒëi·ªÅn C√¢u h·ªèi v√† Ti·ªÅn th∆∞·ªüng.");
        return;
    }
    
    let challengeData = {
        question,
        reward,
        type,
        explanationText,
        explanationImg
    };
    
    if (type === 'mcq') {
        // Tr·∫Øc nghi·ªám
        const op1 = document.getElementById('challenge-op1').value.trim();
        const op2 = document.getElementById('challenge-op2').value.trim();
        const op3 = document.getElementById('challenge-op3').value.trim();
        const op4 = document.getElementById('challenge-op4').value.trim();
        const answer = document.getElementById('challenge-answer').value;
        
        if (!op1 || !op2 || !op3 || !op4 || !answer) {
            showModal("L·ªói", "Vui l√≤ng ƒëi·ªÅn ƒë·ªß 4 l·ª±a ch·ªçn v√† ƒë√°p √°n ƒë√∫ng cho c√¢u tr·∫Øc nghi·ªám.");
            return;
        }
        challengeData = { ...challengeData, op1, op2, op3, op4, answer };
    }
    
    if (id) {
        // S·ª≠a
        state.challenges[id] = { ...state.challenges[id], ...challengeData };
        logActivity(`Admin ƒë√£ c·∫≠p nh·∫≠t th·ª≠ th√°ch: ${question.substring(0, 20)}...`);
    } else {
        // Th√™m
        const newId = generateId();
        state.challenges[newId] = { id: newId, ...challengeData };
        logActivity(`Admin ƒë√£ t·∫°o th·ª≠ th√°ch m·ªõi: ${question.substring(0, 20)}...`);
    }
    
    saveData();
    renderChallengeListAdmin();
    clearChallengeForm();
}

// X·ª≠ l√Ω click S·ª≠a/X√≥a Th·ª≠ Th√°ch
function handleChallengeAdminActions(e) {
    const challengeId = e.target.dataset.challengeId;
    if (!challengeId) return;
    
    const challenge = state.challenges[challengeId];
    if (!challenge) return;
    
    if (e.target.classList.contains('edit-challenge-btn')) {
        // S·ª≠a
        document.getElementById('challenge-id').value = challenge.id;
        document.getElementById('challenge-type').value = challenge.type;
        document.getElementById('challenge-question').value = challenge.question;
        document.getElementById('challenge-reward').value = challenge.reward;
        document.getElementById('challenge-explanation-text').value = challenge.explanationText || '';
        document.getElementById('challenge-explanation-img').value = challenge.explanationImg || '';
        
        if (challenge.type === 'mcq') {
            document.getElementById('challenge-op1').value = challenge.op1;
            document.getElementById('challenge-op2').value = challenge.op2;
            document.getElementById('challenge-op3').value = challenge.op3;
            document.getElementById('challenge-op4').value = challenge.op4;
            document.getElementById('challenge-answer').value = challenge.answer;
        }
        
        toggleChallengeForm(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã form
        window.scrollTo(0, 0);
        
    } else if (e.target.classList.contains('delete-challenge-btn')) {
        // X√≥a
        showModal("X√°c nh·∫≠n X√≥a", `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ª≠ th√°ch "${challenge.question.substring(0, 30)}..."?`, "confirm", () => {
            delete state.challenges[challengeId];
            // X√≥a lu√¥n tr·∫°ng th√°i ƒë√£ l√†m c·ªßa user
            Object.values(state.users).forEach(user => {
                delete user.challengesDone[challengeId];
            });
            logActivity(`Admin ƒë√£ x√≥a th·ª≠ th√°ch: ${challenge.question.substring(0, 20)}...`);
            saveData();
            renderChallengeListAdmin();
        });
    }
}

// --- Tab 4: Qu·∫£n L√≠ C·ª≠a H√†ng (Admin) ---

// X√≥a form c·ª≠a h√†ng
function clearShopForm() {
    document.getElementById('shop-form').reset();
    document.getElementById('shop-item-id').value = '';
}

// Render danh s√°ch c·ª≠a h√†ng
function renderShopListAdmin() {
    const tbody = document.getElementById('shop-list-tbody');
    tbody.innerHTML = '';
    
    Object.values(state.shopItems).forEach(item => {
        const finalPrice = Math.round(item.price * (1 - (item.salePercent || 0) / 100));
        const tr = document.createElement('tr');
        tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700';
        tr.innerHTML = `
            <td class="py-4 px-6 font-medium text-white">${item.name}</td>
            <td class="py-4 px-6">üí∞ ${formatCurrency(item.price)}</td>
            <td class="py-4 px-6">${item.salePercent || 0}%</td>
            <td class="py-4 px-6 font-semibold text-green-400">üí∞ ${formatCurrency(finalPrice)}</td>
            <td class="py-4 px-6 space-x-2">
                <button type="button" data-item-id="${item.id}" class="edit-shop-item-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                <button type="button" data-item-id="${item.id}" class="delete-shop-item-btn text-red-400 hover:text-red-300 font-medium">X√≥a</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// X·ª≠ l√Ω Th√™m/S·ª≠a V·∫≠t Ph·∫©m
function handleShopFormSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('shop-item-id').value;
    const name = document.getElementById('shop-item-name').value.trim();
    const price = parseInt(document.getElementById('shop-item-price').value, 10);
    const salePercent = parseInt(document.getElementById('shop-item-sale').value, 10) || 0;
    
    if (!name || isNaN(price)) {
        showModal("L·ªói", "Vui l√≤ng ƒëi·ªÅn T√™n v√† Gi√° v·∫≠t ph·∫©m.");
        return;
    }
    
    if (id) {
        // S·ª≠a
        state.shopItems[id] = { ...state.shopItems[id], name, price, salePercent };
        logActivity(`Admin ƒë√£ c·∫≠p nh·∫≠t v·∫≠t ph·∫©m: ${name}`);
    } else {
        // Th√™m
        const newId = generateId();
        state.shopItems[newId] = { id: newId, name, price, salePercent };
        logActivity(`Admin ƒë√£ t·∫°o v·∫≠t ph·∫©m m·ªõi: ${name}`);
    }
    
    saveData();
    renderShopListAdmin();
    clearShopForm();
}

// X·ª≠ l√Ω click S·ª≠a/X√≥a V·∫≠t Ph·∫©m
function handleShopAdminActions(e) {
    const itemId = e.target.dataset.itemId;
    if (!itemId) return;
    
    const item = state.shopItems[itemId];
    if (!item) return;
    
    if (e.target.classList.contains('edit-shop-item-btn')) {
        // S·ª≠a
        document.getElementById('shop-item-id').value = item.id;
        document.getElementById('shop-item-name').value = item.name;
        document.getElementById('shop-item-price').value = item.price;
        document.getElementById('shop-item-sale').value = item.salePercent || 0;
        window.scrollTo(0, 0);
        
    } else if (e.target.classList.contains('delete-shop-item-btn')) {
        // X√≥a
        showModal("X√°c nh·∫≠n X√≥a", `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v·∫≠t ph·∫©m "${item.name}"?`, "confirm", () => {
            delete state.shopItems[itemId];
            logActivity(`Admin ƒë√£ x√≥a v·∫≠t ph·∫©m: ${item.name}`);
            saveData();
            renderShopListAdmin();
        });
    }
}

// --- Tab 5: Qu·∫£n L√≠ V√≤ng Quay (Admin) ---

// X√≥a form v√≤ng quay
function clearWheelForm() {
    document.getElementById('wheel-form').reset();
    document.getElementById('wheel-item-id').value = '';
}

// Render danh s√°ch (k√©o/th·∫£)
function renderWheelListAdmin() {
    const tbody = document.getElementById('wheel-list-tbody');
    tbody.innerHTML = ''; // X√≥a n·ªôi dung c≈©
    
    if (state.wheelItems.length === 0) {
        tbody.innerHTML = '<p class="text-gray-400 text-center p-4">Ch∆∞a c√≥ ph·∫ßn th∆∞·ªüng n√†o.</p>';
        return;
    }
    
    state.wheelItems.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'draggable bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 hover:bg-gray-700';
        div.dataset.index = index; // S·ª≠ d·ª•ng index
        div.dataset.itemId = item.id;
        div.draggable = true;
        
        let typeText = '';
        let valueText = '';
        switch(item.type) {
            case 'add_money':
                typeText = '<span class="text-green-400">C·ªông Ti·ªÅn</span>';
                valueText = `+${formatCurrency(item.value)}üí∞`;
                break;
            case 'subtract_money':
                typeText = '<span class="text-red-400">Tr·ª´ Ti·ªÅn</span>';
                valueText = `-${formatCurrency(item.value)}üí∞`;
                break;
            case 'item':
                typeText = '<span class="text-blue-400">V·∫≠t Ph·∫©m</span>';
                valueText = item.value;
                break;
            case 'text':
            default:
                typeText = '<span class="text-gray-400">Ch·ªØ</span>';
                valueText = item.value;
                break;
        }

        div.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-gray-500 cursor-move">‚ò∞</span>
                <div>
                    <p class="font-medium text-white">${item.name}</p>
                    <p class="text-sm">${typeText}: ${valueText}</p>
                </div>
            </div>
            <div class="space-x-3">
                <button type="button" data-item-id="${item.id}" class="edit-wheel-item-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                <button type="button" data-item-id="${item.id}" class="delete-wheel-item-btn text-red-400 hover:text-red-300 font-medium">X√≥a</button>
            </div>
        `;
        tbody.appendChild(div);
    });
}

// Thi·∫øt l·∫≠p K√©o/Th·∫£
function setupDragDrop() {
    const container = document.getElementById('wheel-list-tbody');

    container.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('draggable')) {
            draggingElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.itemId);
            setTimeout(() => {
                draggingElement.classList.add('dragging');
            }, 0);
        }
    });

    container.addEventListener('dragend', (e) => {
        if (draggingElement) {
            draggingElement.classList.remove('dragging');
            draggingElement = null;
        }
    });

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            container.appendChild(draggingElement);
        } else {
            container.insertBefore(draggingElement, afterElement);
        }
    });

    container.addEventListener('drop', (e) => {
        e.preventDefault();
        if (draggingElement) {
            // C·∫≠p nh·∫≠t l·∫°i m·∫£ng state.wheelItems d·ª±a tr√™n th·ª© t·ª± DOM m·ªõi
            const newOrder = [];
            container.querySelectorAll('.draggable').forEach(el => {
                const id = el.dataset.itemId;
                const item = state.wheelItems.find(i => i.id === id);
                if (item) {
                    newOrder.push(item);
                }
            });
            state.wheelItems = newOrder;
            saveData();
            logActivity("Admin ƒë√£ thay ƒë·ªïi th·ª© t·ª± v√≤ng quay.");
            // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t data-index (n·∫øu c·∫ßn)
            renderWheelListAdmin();
        }
    });
}

// H√†m h·ªó tr·ª£ t√¨m v·ªã tr√≠ th·∫£
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// S·∫Øp x·∫øp ng·∫´u nhi√™n
function randomizeWheelItems() {
    // Thu·∫≠t to√°n Fisher-Yates Shuffle
    for (let i = state.wheelItems.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.wheelItems[i], state.wheelItems[j]] = [state.wheelItems[j], state.wheelItems[i]];
    }
    saveData();
    logActivity("Admin ƒë√£ s·∫Øp x·∫øp ng·∫´u nhi√™n v√≤ng quay.");
    renderWheelListAdmin();
}

// X·ª≠ l√Ω Th√™m/S·ª≠a Ph·∫ßn Th∆∞·ªüng
function handleWheelFormSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('wheel-item-id').value;
    const name = document.getElementById('wheel-item-name').value.trim();
    const type = document.getElementById('wheel-item-type').value;
    const value = document.getElementById('wheel-item-value').value.trim();
    
    if (!name || !value) {
        showModal("L·ªói", "Vui l√≤ng ƒëi·ªÅn T√™n v√† Gi√° tr·ªã.");
        return;
    }
    
    // Ki·ªÉm tra n·∫øu l√† C·ªông/Tr·ª´ ti·ªÅn th√¨ gi√° tr·ªã ph·∫£i l√† s·ªë
    if ((type === 'add_money' || type === 'subtract_money') && isNaN(parseInt(value, 10))) {
        showModal("L·ªói", "V·ªõi lo·∫°i C·ªông/Tr·ª´ Ti·ªÅn, Gi√° tr·ªã ph·∫£i l√† m·ªôt con s·ªë.");
        return;
    }
    
    const itemData = { name, type, value };
    
    if (id) {
        // S·ª≠a
        const index = state.wheelItems.findIndex(item => item.id === id);
        if (index > -1) {
            state.wheelItems[index] = { ...state.wheelItems[index], ...itemData };
            logActivity(`Admin ƒë√£ c·∫≠p nh·∫≠t ph·∫ßn th∆∞·ªüng v√≤ng quay: ${name}`);
        }
    } else {
        // Th√™m
        state.wheelItems.push({ id: generateId(), ...itemData });
        logActivity(`Admin ƒë√£ th√™m ph·∫ßn th∆∞·ªüng v√≤ng quay: ${name}`);
    }
    
    saveData();
    renderWheelListAdmin();
    clearWheelForm();
}

// X·ª≠ l√Ω click S·ª≠a/X√≥a Ph·∫ßn Th∆∞·ªüng
function handleWheelAdminActions(e) {
    const itemId = e.target.dataset.itemId;
    if (!itemId) return;
    
    const item = state.wheelItems.find(i => i.id === itemId);
    if (!item) return;
    
    if (e.target.classList.contains('edit-wheel-item-btn')) {
        // S·ª≠a
        document.getElementById('wheel-item-id').value = item.id;
        document.getElementById('wheel-item-name').value = item.name;
        document.getElementById('wheel-item-type').value = item.type;
        document.getElementById('wheel-item-value').value = item.value;
        
    } else if (e.target.classList.contains('delete-wheel-item-btn')) {
        // X√≥a
        showModal("X√°c nh·∫≠n X√≥a", `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph·∫ßn th∆∞·ªüng "${item.name}"?`, "confirm", () => {
            state.wheelItems = state.wheelItems.filter(i => i.id !== itemId);
            logActivity(`Admin ƒë√£ x√≥a ph·∫ßn th∆∞·ªüng v√≤ng quay: ${item.name}`);
            saveData();
            renderWheelListAdmin();
        });
    }
}

// --- Tab 6: G·ª≠i Th√¥ng B√°o (Admin) ---

// X·ª≠ l√Ω g·ª≠i th√¥ng b√°o
function handleNotificationSubmit(e) {
    e.preventDefault();
    const message = document.getElementById('notification-message').value.trim();
    if (!message) {
        showModal("L·ªói", "Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o.");
        return;
    }
    
    broadcastNotification(message, 'info'); // G·ª≠i cho t·∫•t c·∫£ user
    logActivity(`Admin ƒë√£ g·ª≠i th√¥ng b√°o: "${message.substring(0, 30)}..."`);
    
    document.getElementById('notification-form').reset();
    showModal("Th√†nh C√¥ng", "ƒê√£ g·ª≠i th√¥ng b√°o ƒë·∫øn t·∫•t c·∫£ ng∆∞·ªùi ch∆°i.");
}

// --- Tab 7: L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (Admin) ---

// Render L·ªãch S·ª≠ Ho·∫°t ƒê·ªông
function renderActivityLog() {
    const container = document.getElementById('activity-log-list');
    container.innerHTML = '';
    
    if (state.activityLog.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>';
        return;
    }
    
    state.activityLog.forEach(log => {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center animate-slide-in';
        
        let buttonHtml = '';
        // N·∫øu l√† b√†i n·ªôp t·ª± lu·∫≠n, th√™m n√∫t Ch·∫•m ƒêi·ªÉm
        if (log.details.type === 'challenge_submission') {
            buttonHtml = `<button data-log-id="${log.id}" class="grade-submission-btn ml-4 text-white bg-yellow-600 hover:bg-yellow-700 font-medium rounded-lg text-sm px-4 py-2 transition duration-200">Ch·∫•m ƒêi·ªÉm</button>`;
        }
        
        div.innerHTML = `
            <div>
                <p class="text-white">${log.message}</p>
                <p class="text-xs text-gray-400">${formatDateTime(log.date)}</p>
            </div>
            ${buttonHtml}
        `;
        container.appendChild(div);
    });
}

// X·ª≠ l√Ω click v√†o L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (ƒë·ªÉ ch·∫•m ƒëi·ªÉm)
function handleActivityLogClick(e) {
    if (e.target.classList.contains('grade-submission-btn')) {
        const logId = e.target.dataset.logId;
        showGradingModal(logId);
    }
}

// X·ª≠ l√Ω Ch·∫•m ƒêi·ªÉm (Duy·ªát/T·ª´ ch·ªëi)
function handleGradeSubmission(e) {
    const logId = e.target.dataset.logId;
    const isApprove = e.target.id === 'grading-approve-btn';
    
    const log = state.activityLog.find(l => l.id === logId);
    if (!log) {
        showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y log.");
        return;
    }
    
    const user = state.users[log.details.username];
    const challenge = state.challenges[log.details.challengeId];
    
    if (!user || !challenge) {
        showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y User ho·∫∑c C√¢u h·ªèi (c√≥ th·ªÉ ƒë√£ b·ªã x√≥a).");
        return;
    }
    
    if (isApprove) {
        // DUY·ªÜT
        user.balance += challenge.reward;
        user.challengesDone[challenge.id] = 'correct'; // ƒê√°nh d·∫•u ƒë√£ ƒë√∫ng
        
        const message = `B√†i t·ª± lu·∫≠n c·ªßa b·∫°n cho c√¢u: "${challenge.question.substring(0, 30)}..." ƒë√£ ƒë∆∞·ª£c DUY·ªÜT! B·∫°n nh·∫≠n ƒë∆∞·ª£c +${formatCurrency(challenge.reward)}üí∞.`;
        sendNotification(user.username, message, 'success');
        
        // C·∫≠p nh·∫≠t log
        log.message = `(ƒê√É DUY·ªÜT) ${log.message}`;
        log.details.type = 'challenge_graded'; // Thay ƒë·ªïi type ƒë·ªÉ kh√¥ng ch·∫•m l·∫°i
    } else {
        // T·ª™ CH·ªêI
        user.challengesDone[challenge.id] = 'wrong'; // ƒê√°nh d·∫•u l√† sai
        
        const message = `B√†i t·ª± lu·∫≠n c·ªßa b·∫°n cho c√¢u: "${challenge.question.substring(0, 30)}..." ƒë√£ b·ªã T·ª™ CH·ªêI.`;
        sendNotification(user.username, message, 'error');
        
        // C·∫≠p nh·∫≠t log
        log.message = `(ƒê√É T·ª™ CH·ªêI) ${log.message}`;
        log.details.type = 'challenge_graded';
    }
    
    saveData();
    closeGradingModal();
    renderActivityLog(); // Render l·∫°i log
}


// ---------- B·∫ÆT ƒê·∫¶U ·ª®NG D·ª§NG ----------
// Ch·∫°y h√†m init khi trang ƒë√£ t·∫£i xong
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>