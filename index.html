<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kin - C√¥ng C·ª• Nhi·ªám V·ª•</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Inter t·ª´ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* S·ª≠ d·ª•ng font Inter l√†m font ch·ªØ m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }

        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* N√∫t b·∫•m gradient */
        .btn-gradient {
            background-image: linear-gradient(to right, #3b82f6, #6366f1);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            background-image: linear-gradient(to right, #2563eb, #4f46e5);
            box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.3);
        }

        /* Animation cho modal */
        @keyframes slide-in {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-content {
            animation: slide-in 0.3s ease-out forwards;
        }

        /* Animation cho pop-up th√¥ng b√°o */
        @keyframes pop-up {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-up {
            animation: pop-up 0.3s ease-out forwards;
        }

        /* Animation khi tr·∫£ l·ªùi sai */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
        }
        .shake-error {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Animation cho log */
        @keyframes slide-in-log {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .animate-slide-in {
            animation: slide-in-log 0.3s ease-out forwards;
        }

        /* Icon ng∆∞·ªùi d√πng */
        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background-color: #374151; /* gray-700 */
            color: white;
            border: 2px solid #4b5563; /* gray-600 */
            flex-shrink: 0;
        }
        .user-icon-sm {
            width: 28px;
            height: 28px;
            font-size: 1rem;
            border-width: 1px;
        }
        
        /* N√∫t ch·ªçn Emoji */
        .emoji-btn {
            background-color: #4b5563; /* gray-600 */
            border: none;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-btn:hover {
            background-color: #6b7280; /* gray-500 */
            transform: scale(1.1);
        }
        
        /* Style cho chu√¥ng th√¥ng b√°o */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid #1f2937; /* gray-800 */
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .notification-bell.has-new .notification-dot {
            display: block;
        }
        
        /* Style cho input datetime-local */
        input[type="datetime-local"] {
            color-scheme: dark;
        }

        /* (M·ªöI) Style cho Rank */
        .rank-icon {
            font-size: 5rem; /* 80px */
            line-height: 1;
        }
        .rank-name-S·∫Øt { color: #a1a1aa; } /* zinc-400 */
        .rank-name-ƒê·ªìng { color: #f59e0b; } /* amber-500 */
        .rank-name-B·∫°c { color: #d1d5db; } /* gray-300 */
        .rank-name-V√†ng { color: #fde047; } /* yellow-300 */
        .rank-name-B·∫°chKim { color: #67e8f9; } /* cyan-300 */
        .rank-name-KimC∆∞∆°ng { color: #a7f3d0; } /* emerald-200 */
        .rank-name-TinhAnh { color: #f472b6; } /* pink-400 */
        .rank-name-Th√°chƒê·∫•u { color: #f87171; } /* red-400 */
        .rank-name-V√¥H·∫°n { color: #c084fc; } /* purple-400 */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-inter antialiased">

    <!-- 1. Trang ƒêƒÉng Nh·∫≠p (Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h1 class="text-5xl font-extrabold text-center mb-4 text-white">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Kin</span>
            </h1>
            <p class="text-center text-gray-400 mb-8">C√¥ng c·ª• qu·∫£n l√Ω nhi·ªám v·ª•</p>
            
            <form id="login-form">
                <div class="mb-5">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                    <input type="text" id="username" name="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="Nh·∫≠p t√†i kho·∫£n" required>
                </div>
                <div class="mb-5">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="flex items-center mb-6">
                    <input id="remember-me" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                    <label for="remember-me" class="ml-2 text-sm font-medium text-gray-300">Nh·ªõ m·∫≠t kh·∫©u</label>
                </div>
                
                <button type="submit" class="w-full text-white btn-gradient font-medium rounded-lg text-sm px-5 py-3.5 text-center shadow-lg transition duration-300 transform hover:scale-105">
                    ƒêƒÉng Nh·∫≠p
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Trang Ng∆∞·ªùi Ch∆°i (·∫®n ban ƒë·∫ßu) -->
    <div id="player-view" class="container mx-auto p-4 hidden">
        <!-- Header Ng∆∞·ªùi Ch∆°i -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div id="player-header-icon" class="user-icon">üë§</div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Ch√†o, <span id="player-displayname" class="text-blue-400"></span>!</h1>
                    <p class="text-sm text-gray-400 -mt-1">(@<span id="player-username"></span>)</p>
                </div>
                <div class="flex items-center gap-2 text-lg bg-yellow-400 text-gray-900 px-4 py-1 rounded-full font-semibold shadow-md">
                    <span class="text-xl">üí∞</span>
                    <span id="player-balance">0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Chu√¥ng Th√¥ng B√°o -->
                <div id="notification-bell" class="notification-bell text-gray-400 hover:text-white transition">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <div class="notification-dot"></div>
                </div>
                <button id="logout-btn-player" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Player (4 tab) -->
        <nav id="player-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="tasks" class="player-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">üöÄ Nhi·ªám V·ª•</button>
                    <button data-tab="challenges" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üéØ Th·ª≠ Th√°ch</button>
                    <button data-tab="shop" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üõçÔ∏è C·ª≠a H√†ng</button>
                    <button data-tab="profile" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üë§ C√° Nh√¢n</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Player -->
        <div class="p-4 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[60vh]">
            
            <!-- Tab Nhi·ªám V·ª• -->
            <div id="tasks-tab" class="player-tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Nhi·ªám V·ª• C·ªßa B·∫°n</h2>
                <div id="task-list-player" class="space-y-4">
                    <p class="text-gray-400">Kh√¥ng c√≥ nhi·ªám v·ª• n√†o ƒë∆∞·ª£c giao.</p>
                </div>
            </div>
            
            <!-- Tab Th·ª≠ Th√°ch -->
            <div id="challenges-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Th·ª≠ Th√°ch H√†ng Ng√†y</h2>
                <div id="challenge-list-player" class="space-y-4">
                    <p class="text-gray-400">Ch∆∞a c√≥ th·ª≠ th√°ch n√†o h√¥m nay.</p>
                </div>
            </div>

            <!-- Tab C·ª≠a H√†ng -->
            <div id="shop-tab" class="player-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 sm:mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">C·ª≠a H√†ng ƒê·ªïi Th∆∞·ªüng</h2>
                    <button id="view-my-gifts-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 self-start sm:self-center">
                        üéÅ Xem Qu√† ƒê√£ ƒê·ªïi
                    </button>
                </div>
                <div id="view-gifts-pointer" class="hidden text-right text-green-400 font-semibold mb-4 animate-bounce">
                    H√£y xem qu√† c·ªßa m√¨nh nh√©! &nearr;
                </div>
                
                <div id="shop-list-player" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-400">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t.</p>
                </div>
            </div>
            
            <!-- (C·∫¨P NH·∫¨T) Tab C√° Nh√¢n (Th√™m Rank) -->
            <div id="profile-tab" class="player-tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-3xl font-bold text-white">Th√¥ng Tin C√° Nh√¢n</h2>
                     <button id="view-rules-btn" class="text-sm text-blue-400 hover:text-blue-300">Xem lu·∫≠t ch∆°i</button>
                </div>
               
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- C·ªôt Rank -->
                    <div class="md:col-span-1 text-center bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 flex flex-col items-center justify-center">
                        <div id="rank-icon" class="rank-icon mb-4">‚öôÔ∏è</div>
                        <h3 id="rank-name" class="text-3xl font-bold mb-2 rank-name-S·∫Øt">Rank S·∫Øt</h3>
                        <p class="text-gray-400">T·ªïng nhi·ªám v·ª•: <span id="rank-tasks-completed" class="font-bold text-white">0</span></p>
                    </div>
                    
                    <!-- C·ªôt Form -->
                    <div class="md:col-span-2 bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700">
                        <div class="text-center mb-6">
                            <div id="profile-icon-display" class="user-icon text-5xl w-24 h-24 mx-auto mb-4 border-4 border-blue-500">üë§</div>
                        </div>
                        <form id="profile-form" class="space-y-4">
                            <div>
                                <label for="profile-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                                <input type="text" id="profile-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                <p id="cooldown-name" class="text-xs text-yellow-500 mt-1"></p>
                            </div>
                            <div>
                                <label for="profile-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (ch·ªâ 1 emoji, v√≠ d·ª•: üòä)</label>
                                <input type="text" id="profile-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                <!-- B·ªô ch·ªçn Emoji -->
                                <div id="profile-emoji-list" class="flex flex-wrap gap-2 mt-2">
                                    <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                                </div>
                                <p id="cooldown-icon" class="text-xs text-yellow-500 mt-1"></p>
                            </div>
                            <div>
                                <label for="profile-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t Kh·∫©u M·ªõi (b·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                                <input type="password" id="profile-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <p id="cooldown-password" class="text-xs text-yellow-500 mt-1"></p>
                            </div>
                            <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                                L∆∞u Thay ƒê·ªïi
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 3. Trang Admin (·∫®n ban ƒë·∫ßu) -->
    <div id="admin-view" class="container mx-auto p-4 hidden">
        <!-- Header Admin -->
        <header class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <h1 class="text-3xl font-bold text-white">Admin Panel</h1>
            <button id="logout-btn-admin" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                ƒêƒÉng Xu·∫•t
            </button>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Admin (Th√™m tab Nhi·ªám V·ª•) -->
        <nav id="admin-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="userMgmt" class="admin-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</button>
                    <button data-tab="taskMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üöÄ Qu·∫£n L√≠ Nhi·ªám V·ª•</button>
                    <button data-tab="challengeMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üéØ Qu·∫£n L√≠ Th·ª≠ Th√°ch</button>
                    <button data-tab="shopMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üõçÔ∏è Qu·∫£n L√≠ C·ª≠a H√†ng</button>
                    <button data-tab="notifyMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">G·ª≠i Th√¥ng B√°o</button>
                    <button data-tab="activityLog" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Admin -->
        <div class="p-6 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[70vh]">

            <!-- (C·∫¨P NH·∫¨T) Tab Qu·∫£n L√≠ Ng∆∞·ªùi D√πng (Th√™m Rank) -->
            <div id="user-mgmt-tab" class="admin-tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</h2>
                <!-- (C·∫¨P NH·∫¨T) Form (Th√™m Rank) -->
                <form id="user-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                        <input type="text" id="user-username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                        <input type="text" id="user-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="user-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</M·∫≠t kh·∫©u>
                        <input type="text" id="user-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-balance" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                        <input type="number" id="user-balance" value="0" min="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                     <!-- (M·ªöI) Tr∆∞·ªùng Rank -->
                    <div>
                        <label for="user-tasks-completed" class="block mb-2 text-sm font-medium text-gray-300">Nhi·ªám V·ª• HT (Rank) üöÄ</label>
                        <input type="number" id="user-tasks-completed" value="0" min="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="lg:col-span-2">
                        <label for="user-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (Emoji)</label>
                        <input type="text" id="user-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- B·ªô ch·ªçn Emoji (Admin) -->
                        <div id="admin-emoji-list" class="flex flex-wrap gap-2 mt-2">
                            <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                        </div>
                    </div>
                    <div class="lg:col-span-5 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u</button>
                        <button type="button" id="clear-user-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>

                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <!-- (C·∫¨P NH·∫¨T) B·∫£ng (Th√™m Rank) -->
                                <th scope="col" class="py-3 px-6">Icon</th>
                                <th scope="col" class="py-3 px-6">T√™n Hi·ªÉn Th·ªã</th>
                                <th scope="col" class="py-3 px-6">T√†i kho·∫£n</th>
                                <th scope="col" class="py-3 px-6">Ti·ªÅn th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">Rank (NV)</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Qu·∫£n L√≠ Nhi·ªám V·ª• -->
            <div id="task-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Nhi·ªám V·ª•</h2>
                <form id="task-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 space-y-4">
                    <input type="hidden" id="task-id">
                    <div>
                        <label for="task-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n nhi·ªám v·ª•</label>
                        <input type="text" id="task-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="task-reward" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                            <input type="number" id="task-reward" min="0" value="50" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="task-penalty" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn ph·∫°t (n·∫øu tr·ªÖ) üí∏</label>
                            <input type="number" id="task-penalty" min="0" value="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="task-deadline" class="block mb-2 text-sm font-medium text-gray-300">Deadline</label>
                            <input type="datetime-local" id="task-deadline" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u Nhi·ªám V·ª•</button>
                        <button type="button" id="clear-task-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">T√™n nhi·ªám v·ª•</th>
                                <th scope="col" class="py-3 px-6">Th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">Ph·∫°t</th>
                                <th scope="col" class="py-3 px-6">Deadline</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ Th·ª≠ Th√°ch -->
            <div id="challenge-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Th·ª≠ Th√°ch</h2>
                <form id="challenge-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 space-y-4">
                    <input type="hidden" id="challenge-id">
                    <div>
                        <label for="challenge-question" class="block mb-2 text-sm font-medium text-gray-300">C√¢u h·ªèi</label>
                        <textarea id="challenge-question" rows="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-op1" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 1</label>
                            <input type="text" id="challenge-op1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-op2" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 2</label>
                            <input type="text" id="challenge-op2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-op3" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 3</label>
                            <input type="text" id="challenge-op3" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="challenge-op4" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 4</label>
                            <input type="text" id="challenge-op4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-answer" class="block mb-2 text-sm font-medium text-gray-300">ƒê√°p √°n ƒë√∫ng (1-4)</label>
                            <input type="number" id="challenge-answer" min="1" max="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-reward" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                            <input type="number" id="challenge-reward" min="0" value="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                    
                    <!-- Ph·∫ßn Gi·∫£i Th√≠ch -->
                    <hr class="border-gray-600">
                    <div>
                        <label for="challenge-explanation-text" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch ƒë√°p √°n (Text)</label>
                        <textarea id="challenge-explanation-text" rows="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n n√†y l·∫°i ƒë√∫ng..."></textarea>
                    </div>
                    <div>
                        <label for="challenge-explanation-img" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch (Link ·∫£nh, kh√¥ng b·∫Øt bu·ªôc)</label>
                        <input type="text" id="challenge-explanation-img" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="https://example.com/image.png">
                    </div>
                    <hr class="border-gray-600">
                    
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u Th·ª≠ Th√°ch</button>
                        <button type="button" id="clear-challenge-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">C√¢u h·ªèi</th>
                                <th scope="col" class="py-3 px-6">Th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="challenge-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ C·ª≠a H√†ng -->
            <div id="shop-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ C·ª≠a H√†ng</h2>
                <!-- Form C·ª≠a H√†ng (Th√™m Gi·∫£m Gi√°) -->
                <form id="shop-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <input type="hidden" id="shop-item-id">
                    <div>
                        <label for="shop-item-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n v·∫≠t ph·∫©m</label>
                        <input type="text" id="shop-item-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-price" class="block mb-2 text-sm font-medium text-gray-300">Gi√° üí∞</label>
                        <input type="number" id="shop-item-price" min="0" value="100" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-sale" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£m gi√° (%)</label>
                        <input type="number" id="shop-item-sale" min="0" max="100" value="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="md:col-span-3 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u V·∫≠t Ph·∫©m</button>
                        <button type="button" id="clear-shop-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">T√™n v·∫≠t ph·∫©m</th>
                                <th scope="col" class="py-3 px-6">Gi√° G·ªëc</th>
                                <th scope="col" class="py-3 px-C·∫¨P NH·∫¨T">Gi·∫£m Gi√°</th>
                                <th scope="col" class="py-3 px-6">Gi√° M·ªõi</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="shop-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab G·ª≠i Th√¥ng B√°o -->
            <div id="notify-mgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">G·ª≠i Th√¥ng B√°o</h2>
                <form id="notification-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 max-w-lg mx-auto">
                    <div class="mb-4">
                        <label for="notification-message" class="block mb-2 text-sm font-medium text-gray-300">N·ªôi dung th√¥ng b√°o</label>
                        <textarea id="notification-message" rows="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Vi·∫øt th√¥ng b√°o c·ªßa b·∫°n..." required></textarea>
                    </div>
                    <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                        G·ª≠i T·ªõi T·∫•t C·∫£ Ng∆∞·ªùi Ch∆°i
                    </button>
                </form>
            </div>
            
            <!-- Tab L·ªãch S·ª≠ Ho·∫°t ƒê·ªông -->
            <div id="activity-log-tab" class="admin-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (M·ªõi nh·∫•t)</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <!-- N√∫t x√≥a l·ªãch s·ª≠ ƒë·ªïi qu√† -->
                        <button id="clear-purchase-log-btn" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a L·ªãch S·ª≠ ƒê·ªïi Qu√†
                        </button>
                        <!-- N√∫t x√≥a th√¥ng b√°o user -->
                        <button id="clear-user-notifications-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a H·∫øt Th√¥ng B√°o (User)
                        </button>
                        <button id="clear-activity-log-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a To√†n B·ªô L·ªãch S·ª≠
                        </button>
                    </div>
                </div>
                <div id="activity-log-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- 4. Modal Th√¥ng B√°o Chung (·∫®n ban ƒë·∫ßu) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Th√¥ng B√°o</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="p-6 text-gray-300 text-lg">
                <!-- N·ªôi dung modal s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>
            <div class="p-5 border-t border-gray-700 text-right space-x-3">
                <button id="modal-cancel-btn" class="hidden text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                <button id="modal-ok-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal Chu√¥ng Th√¥ng B√°o (·∫®n ban ƒë·∫ßu) -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[51] hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-white">Th√¥ng B√°o C·ªßa B·∫°n</h3>
                <button id="notification-modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="notification-modal-body" class="p-6 text-gray-300 max-h-[60vh] overflow-y-auto space-y-3">
                <!-- Danh s√°ch th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>
            <div class="p-5 border-t border-gray-700 text-right">
                <button id="notification-modal-ok-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                    ƒê√£ ƒê·ªçc
                </button>
            </div>
        </div>
    </div>

    <!-- 6. Toast (Pop-up nh·ªè) (·∫®n ban ƒë·∫ßu) -->
    <div id="toast" class="hidden fixed bottom-5 right-5 md:bottom-10 md:right-10 z-[100] bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg pop-up max-w-sm">
        <p id="toast-message">ƒê√¢y l√† th√¥ng b√°o!</p>
    </div>

    <!-- 7. Script ch√≠nh c·ªßa ·ª©ng d·ª•ng -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Elements ---
        const views = {
            login: document.getElementById('login-view'),
            player: document.getElementById('player-view'),
            admin: document.getElementById('admin-view'),
        };
        
        // General Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // Notification Modal (Bell)
        const notificationModal = document.getElementById('notification-modal');
        const notificationModalBody = document.getElementById('notification-modal-body');
        const notificationModalCloseBtn = document.getElementById('notification-modal-close-btn');
        const notificationModalOkBtn = document.getElementById('notification-modal-ok-btn');
        const notificationBell = document.getElementById('notification-bell');

        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // Login
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const rememberMeInput = document.getElementById('remember-me');

        // Player Header
        const playerUsername = document.getElementById('player-username');
        const playerDisplayname = document.getElementById('player-displayname');
        const playerHeaderIcon = document.getElementById('player-header-icon');
        const playerBalance = document.getElementById('player-balance');
        const logoutBtnPlayer = document.getElementById('logout-btn-player');
        
        // Player Nav
        const playerNav = document.getElementById('player-nav');
        const playerTabs = {
            tasks: document.getElementById('tasks-tab'),
            challenges: document.getElementById('challenges-tab'),
            shop: document.getElementById('shop-tab'),
            profile: document.getElementById('profile-tab'),
        };
        
        // Player: Tasks
        const tasksTab = document.getElementById('tasks-tab');
        const taskListPlayer = document.getElementById('task-list-player');
        
        // Player: Challenges
        const challengeListPlayer = document.getElementById('challenge-list-player');

        // Player: Shop
        const shopListPlayer = document.getElementById('shop-list-player');
        const viewMyGiftsBtn = document.getElementById('view-my-gifts-btn');
        const viewGiftsPointer = document.getElementById('view-gifts-pointer');

        // Player: Profile
        const profileForm = document.getElementById('profile-form');
        const profileIconDisplay = document.getElementById('profile-icon-display');
        const profileDisplaynameInput = document.getElementById('profile-displayname');
        const profileIconInput = document.getElementById('profile-icon');
        const profilePasswordInput = document.getElementById('profile-password');
        const profileEmojiList = document.getElementById('profile-emoji-list');
        const cooldownName = document.getElementById('cooldown-name');
        const cooldownIcon = document.getElementById('cooldown-icon');
        const cooldownPassword = document.getElementById('cooldown-password');
        const viewRulesBtn = document.getElementById('view-rules-btn'); // M·ªõi
        const rankIcon = document.getElementById('rank-icon'); // M·ªõi
        const rankName = document.getElementById('rank-name'); // M·ªõi
        const rankTasksCompleted = document.getElementById('rank-tasks-completed'); // M·ªõi


        // Admin
        const logoutBtnAdmin = document.getElementById('logout-btn-admin');
        const adminNav = document.getElementById('admin-nav');
        const adminTabs = {
            userMgmt: document.getElementById('user-mgmt-tab'),
            taskMgmt: document.getElementById('task-mgmt-tab'),
            challengeMgmt: document.getElementById('challenge-mgmt-tab'),
            shopMgmt: document.getElementById('shop-mgmt-tab'),
            notifyMgmt: document.getElementById('notify-mgmt-tab'),
            activityLog: document.getElementById('activity-log-tab'),
        };
        
        // Admin: User Mgmt
        const userForm = document.getElementById('user-form');
        const userUsernameInput = document.getElementById('user-username');
        const userDisplaynameInput = document.getElementById('user-displayname');
        const userIconInput = document.getElementById('user-icon');
        const adminEmojiList = document.getElementById('admin-emoji-list');
        const userPasswordInput = document.getElementById('user-password');
        const userBalanceInput = document.getElementById('user-balance');
        const userTasksCompletedInput = document.getElementById('user-tasks-completed'); // M·ªõi
        const clearUserFormBtn = document.getElementById('clear-user-form-btn');
        const userListTbody = document.getElementById('user-list-tbody');
        
        // Admin: Task Mgmt
        const taskForm = document.getElementById('task-form');
        const taskIdInput = document.getElementById('task-id');
        const taskNameInput = document.getElementById('task-name');
        const taskRewardInput = document.getElementById('task-reward');
        const taskPenaltyInput = document.getElementById('task-penalty');
        const taskDeadlineInput = document.getElementById('task-deadline');
        const clearTaskFormBtn = document.getElementById('clear-task-form-btn');
        const taskListTbody = document.getElementById('task-list-tbody');
        
        // Admin: Challenge Mgmt
        const challengeForm = document.getElementById('challenge-form');
        const challengeIdInput = document.getElementById('challenge-id');
        const challengeQuestionInput = document.getElementById('challenge-question');
        const challengeOp1Input = document.getElementById('challenge-op1');
        const challengeOp2Input = document.getElementById('challenge-op2');
        const challengeOp3Input = document.getElementById('challenge-op3');
        const challengeOp4Input = document.getElementById('challenge-op4');
        const challengeAnswerInput = document.getElementById('challenge-answer');
        const challengeRewardInput = document.getElementById('challenge-reward');
        const challengeExplanationTextInput = document.getElementById('challenge-explanation-text');
        const challengeExplanationImgInput = document.getElementById('challenge-explanation-img');
        const clearChallengeFormBtn = document.getElementById('clear-challenge-form-btn');
        const challengeListTbody = document.getElementById('challenge-list-tbody');

        // Admin: Shop Mgmt
        const shopForm = document.getElementById('shop-form');
        const shopItemIdInput = document.getElementById('shop-item-id');
        const shopItemNameInput = document.getElementById('shop-item-name');
        const shopItemPriceInput = document.getElementById('shop-item-price');
        const shopItemSaleInput = document.getElementById('shop-item-sale');
        const clearShopFormBtn = document.getElementById('clear-shop-form-btn');
        const shopListTbody = document.getElementById('shop-list-tbody');
        
        // Admin: Notify Mgmt
        const notificationForm = document.getElementById('notification-form');
        const notificationMessageInput = document.getElementById('notification-message');

        // Admin: Activity Log
        const activityLogList = document.getElementById('activity-log-list');
        const clearActivityLogBtn = document.getElementById('clear-activity-log-btn');
        const clearPurchaseLogBtn = document.getElementById('clear-purchase-log-btn');
        const clearUserNotificationsBtn = document.getElementById('clear-user-notifications-btn');

        // --- State ---
        let state = {
            currentUser: null,
            users: {},
            tasks: [],
            challenges: [],
            shopItems: [],
            activityLog: [],
            editingTaskId: null,
            editingChallengeId: null,
            editingShopItemId: null,
            modalOkCallback: null,
            modalCancelCallback: null
        };
        
        // Danh s√°ch emoji ƒë·ªÉ ch·ªçn
        const EMOJI_LIST = ['üòä', 'üòÇ', 'üî•', 'üöÄ', 'üåü', '‚ù§Ô∏è', 'üéâ', 'üòé', 'üëë', 'üíé', 'üí™', 'üéØ'];

        // (M·ªöI) ƒê·ªãnh nghƒ©a c√°c m·ªëc Rank
        const RANKS = [
            { threshold: 0, name: 'S·∫Øt', icon: '‚öôÔ∏è' },
            { threshold: 10, name: 'ƒê·ªìng', icon: 'ü•â' },
            { threshold: 20, name: 'B·∫°c', icon: 'ü•à' },
            { threshold: 30, name: 'V√†ng', icon: 'ü•á' },
            { threshold: 50, name: 'B·∫°ch Kim', icon: 'üíé' },
            { threshold: 75, name: 'Kim C∆∞∆°ng', icon: 'üí†' },
            { threshold: 100, name: 'Tinh Anh', icon: 'üåü' },
            { threshold: 150, name: 'Th√°ch ƒê·∫•u', icon: 'üî•' },
            { threshold: 200, name: 'V√¥ H·∫°n', icon: 'üöÄ' }
        ];

        // --- Database (localStorage) ---
        const db = {
            _get: (key, defaultValue) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            },
            _save: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            
            getUsers: () => db._get('kin_users', {}),
            saveUsers: (users) => db._save('kin_users', users),
            
            getTasks: () => db._get('kin_tasks', []),
            saveTasks: (tasks) => db._save('kin_tasks', tasks),
            
            getChallenges: () => db._get('kin_challenges', []),
            saveChallenges: (challenges) => db._save('kin_challenges', challenges),
            
            getShopItems: () => db._get('kin_shopItems', []),
            saveShopItems: (items) => db._save('kin_shopItems', items),
            
            getActivityLog: () => db._get('kin_activityLog', []),
            saveActivityLog: (log) => db._save('kin_activityLog', log),
            
            getRememberedUser: () => db._get('kin_rememberedUser', null),
            saveRememberedUser: (user) => db._save('kin_rememberedUser', user),
            clearRememberedUser: () => localStorage.removeItem('kin_rememberedUser'),
        };

        // --- Helper Functions ---

        // Hi·ªÉn th·ªã m·ªôt view v√† ·∫©n c√°c view kh√°c
        const showView = (viewName) => {
            Object.keys(views).forEach(key => {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            });
            window.scrollTo(0, 0);
        };

        // Hi·ªÉn th·ªã Toast
        let toastTimer;
        const showToast = (message, isError = false) => {
            clearTimeout(toastTimer);
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 md:bottom-10 md:right-10 z-[100] text-white py-3 px-6 rounded-lg shadow-lg pop-up max-w-sm ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            
            toastTimer = setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        };
        
        // Hi·ªÉn th·ªã Modal
        const showModal = (title, body, okText = 'OK', showCancel = false, cancelText = 'H·ªßy') => {
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            modalOkBtn.textContent = okText;
            
            if (showCancel) {
                modalCancelBtn.textContent = cancelText;
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            
            return new Promise((resolve) => {
                state.modalOkCallback = () => resolve(true);
                state.modalCancelCallback = () => resolve(false);
            });
        };

        // ·∫®n Modal
        const hideModal = () => {
            modal.classList.add('hidden');
            state.modalOkCallback = null;
            state.modalCancelCallback = null;
        };
        
        modalCloseBtn.onclick = () => {
            if (state.modalCancelCallback) state.modalCancelCallback();
            hideModal();
        };
        modalOkBtn.onclick = () => {
            if (state.modalOkCallback) state.modalOkCallback();
            hideModal();
        };
        modalCancelBtn.onclick = () => {
            if (state.modalCancelCallback) state.modalCancelCallback();
            hideModal();
        };
        
        // (M·ªöI) Th√™m th√¥ng b√°o v√†o chu√¥ng
        const addNotification = (user, message) => {
            const notification = {
                id: `notif_${Date.now()}`,
                timestamp: Date.now(),
                message: message,
            };
            user.notifications.push(notification);
            user.hasNewNotification = true;
            
            // C·∫≠p nh·∫≠t UI n·∫øu user ƒëang online
            if(state.currentUser && state.currentUser.username === user.username) {
                 notificationBell.classList.add('has-new');
            }
        };

        // Hi·ªÉn th·ªã Modal Chu√¥ng Th√¥ng B√°o
        const showNotificationModal = (user) => {
            notificationModalBody.innerHTML = '';
            if (!user.notifications || user.notifications.length === 0) {
                notificationModalBody.innerHTML = '<p class="text-gray-400">B·∫°n kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>';
            } else {
                user.notifications.sort((a, b) => b.timestamp - a.timestamp).forEach(notif => {
                    const date = new Date(notif.timestamp).toLocaleString('vi-VN');
                    notificationModalBody.innerHTML += `
                        <div class="p-4 bg-gray-700 rounded-lg">
                            <p class="text-white">${notif.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${date}</p>
                        </div>
                    `;
                });
            }
            notificationModal.classList.remove('hidden');
            
            user.hasNewNotification = false;
            notificationBell.classList.remove('has-new');
            db.saveUsers(state.users);
        };
        
        const hideNotificationModal = () => {
            notificationModal.classList.add('hidden');
        };
        notificationBell.onclick = () => showNotificationModal(state.currentUser);
        notificationModalCloseBtn.onclick = hideNotificationModal;
        notificationModalOkBtn.onclick = hideNotificationModal;

        // Th√™m v√†o Activity Log
        const addActivityLog = (message, type, user) => {
            const logEntry = {
                id: Date.now(),
                timestamp: Date.now(),
                message,
                type, // 'challenge', 'purchase', 'task_success', 'task_fail'
                user: user.username
            };
            state.activityLog.unshift(logEntry);
            if (state.activityLog.length > 100) state.activityLog.pop();
            db.saveActivityLog(state.activityLog);
            
            if (views.admin.classList.contains('hidden') === false) {
                renderActivityLog();
            }
        };

        // H√†m render b·ªô ch·ªçn Emoji
        const renderEmojiPicker = (container, inputElement) => {
            container.innerHTML = '';
            EMOJI_LIST.forEach(emoji => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => {
                    inputElement.value = emoji;
                };
                container.appendChild(btn);
            });
        };
        
        // --- Task & Rank Logic ---
        
        // (M·ªöI) L·∫•y Rank theo s·ªë nhi·ªám v·ª•
        const getRank = (tasksCompleted) => {
            let currentRank = RANKS[0];
            for (const rank of RANKS) {
                if (tasksCompleted >= rank.threshold) {
                    currentRank = rank;
                } else {
                    break; 
                }
            }
            return currentRank;
        };
        
        // (M·ªöI) Render Rank UI
        const renderRankProfile = (user) => {
            const rank = getRank(user.tasksCompleted);
            rankIcon.textContent = rank.icon;
            rankName.textContent = `Rank ${rank.name}`;
            rankTasksCompleted.textContent = user.tasksCompleted;
            
            // X√≥a h·∫øt class m√†u c≈©
            rankName.classList.forEach(c => {
                if(c.startsWith('rank-name-')) {
                    rankName.classList.remove(c);
                }
            });
            // Th√™m class m√†u m·ªõi
            rankName.classList.add(`rank-name-${rank.name}`);
        };
        
        // (M·ªöI) Hi·ªÉn th·ªã lu·∫≠t ch∆°i
        viewRulesBtn.onclick = () => {
            let rulesBody = `
                <ul class="list-disc list-inside space-y-2">
                    <li>Ho√†n th√†nh nhi·ªám v·ª• (NV) ƒë·ªÉ tƒÉng ƒëi·ªÉm Rank.</li>
                    <li>
                        <strong class="text-red-400">QUAN TR·ªåNG:</strong> N·∫øu b·∫°n tr·ªÖ deadline b·∫•t k·ª≥ nhi·ªám v·ª• n√†o, 
                        ƒëi·ªÉm Rank (t·ªïng s·ªë NV) s·∫Ω b·ªã <strong class="text-red-400">RESET V·ªÄ 0</strong>.
                    </li>
                    <li>B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o (chu√¥ng üîî) khi b·ªã reset.</li>
                </ul>
                <h4 class="font-bold text-white mt-4 mb-2">C√°c M·ªëc Rank:</h4>
                <ul class="list-none space-y-1 text-sm">
            `;
            RANKS.forEach(rank => {
                rulesBody += `<li><span class="font-bold text-lg">${rank.icon}</span> (Rank ${rank.name}): ${rank.threshold} NV</li>`;
            });
            rulesBody += '</ul>';
            
            showModal('Lu·∫≠t Ch∆°i Rank', rulesBody);
        };

        // (C·∫¨P NH·∫¨T) Ki·ªÉm tra deadline (Th√™m logic Reset Rank)
        const checkTaskDeadlines = (user) => {
            const now = Date.now();
            let changed = false;
            let didFail = false; // (M·ªõi)
            
            state.tasks.forEach(task => {
                // N·∫øu task ƒë√£ qua deadline V√Ä user ch∆∞a ho√†n th√†nh
                if (now > task.deadline && !user.completedTasksHistory.includes(task.id)) {
                    // (C·∫¨P NH·∫¨T) Reset Rank
                    user.tasksCompleted = 0; // Reset v·ªÅ 0
                    didFail = true;
                    
                    // Th√™m v√†o l·ªãch s·ª≠ (ƒë·ªÉ ·∫©n ƒëi)
                    user.completedTasksHistory.push(task.id); 
                    
                    user.balance = Math.max(0, user.balance - task.penalty); // Tr·ª´ ti·ªÅn ph·∫°t
                    
                    addActivityLog(
                        `ƒë√£ TR·ªÑ DEADLINE nhi·ªám v·ª• "${task.name}", b·ªã ph·∫°t üí∏ ${task.penalty} v√† RESET RANK V·ªÄ 0`, 
                        'task_fail', 
                        user
                    );
                    changed = true;
                }
            });
            
            if (didFail) {
                addNotification(user, `üö® B·∫°n ƒë√£ b·ªã RESET RANK v·ªÅ 0 do tr·ªÖ deadline nhi·ªám v·ª•!`);
            }
            
            if (changed) {
                db.saveUsers(state.users);
            }
        };
        
        // Render danh s√°ch nhi·ªám v·ª• (Player)
        const renderTasksPlayer = (user) => {
            taskListPlayer.innerHTML = '';
            const now = Date.now();
            
            const userTasks = state.tasks.filter(task => 
                !user.completedTasksHistory.includes(task.id) && now < task.deadline // Ch·ªâ hi·ªán task ch∆∞a ho√†n th√†nh V√Ä c√≤n h·∫°n
            );
            
            if (userTasks.length === 0) {
                taskListPlayer.innerHTML = '<p class="text-gray-400 text-center">B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ nhi·ªám v·ª•, ho·∫∑c ch∆∞a c√≥ nhi·ªám v·ª• m·ªõi.</p>';
                return;
            }
            
            // S·∫Øp x·∫øp: deadline g·∫ßn nh·∫•t l√™n tr√™n
            userTasks.sort((a, b) => a.deadline - b.deadline);
            
            userTasks.forEach(task => {
                const deadlineDate = new Date(task.deadline);
                const isNearDeadline = (task.deadline - now) < (24 * 60 * 60 * 1000); // C√≤n d∆∞·ªõi 1 ng√†y
                
                taskListPlayer.innerHTML += `
                    <div class="bg-gray-700 p-5 rounded-lg shadow-md border ${isNearDeadline ? 'border-red-500' : 'border-gray-600'} flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h3 class="text-xl font-semibold text-white mb-1">${task.name}</h3>
                            <p class="text-sm ${isNearDeadline ? 'text-red-400 font-medium' : 'text-gray-400'}">
                                ‚è∞ Deadline: ${deadlineDate.toLocaleString('vi-VN')}
                            </p>
                            <div class="flex gap-4 mt-2 text-sm">
                                <span class="text-green-400">Th∆∞·ªüng: üí∞ ${task.reward}</span>
                                <span class="text-yellow-400">Ph·∫°t: üí∏ ${task.penalty}</span>
                            </div>
                        </div>
                        <button data-id="${task.id}" class="complete-task-btn w-full md:w-auto text-white bg-green-600 hover:bg-green-700 font-medium py-3 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                            ‚úÖ Ho√†n Th√†nh
                        </button>
                    </div>
                `;
            });
        };
        
        // (C·∫¨P NH·∫¨T) X·ª≠ l√Ω Ho√†n Th√†nh Nhi·ªám V·ª• (Th√™m logic Rank)
        const handleTaskCompletion = (e) => {
            const btn = e.target.closest('.complete-task-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const task = state.tasks.find(t => t.id === id);
            const user = state.currentUser;
            
            if (!task) return;
            
            // X√°c nh·∫≠n
            showModal(
                'X√°c nh·∫≠n ho√†n th√†nh',
                `B·∫°n c√≥ ch·∫Øc ƒë√£ ho√†n th√†nh nhi·ªám v·ª•: "${task.name}"?`,
                'ƒê√£ Ho√†n Th√†nh',
                true
            ).then(confirmed => {
                if (confirmed) {
                    user.balance += task.reward;
                    user.completedTasksHistory.push(id); // Th√™m v√†o l·ªãch s·ª≠ (ƒë·ªÉ ·∫©n ƒëi)
                    user.tasksCompleted += 1; // (M·ªöI) TƒÉng ƒëi·ªÉm Rank
                    
                    db.saveUsers(state.users);
                    
                    addActivityLog(
                        `ƒë√£ HO√ÄN TH√ÄNH nhi·ªám v·ª• "${task.name}" (T·ªïng NV: ${user.tasksCompleted}), nh·∫≠n üí∞ ${task.reward}`, 
                        'task_success', 
                        user
                    );
                    
                    showToast(`Ho√†n th√†nh nhi·ªám v·ª•! +üí∞ ${task.reward}`);
                    
                    // Render l·∫°i
                    playerBalance.textContent = user.balance;
                    renderTasksPlayer(user);
                    renderShopPlayer(user); // C·∫≠p nh·∫≠t shop
                    renderRankProfile(user); // (M·ªöI) C·∫≠p nh·∫≠t Rank
                }
            });
        };

        // --- Core Logic Functions ---

        // Render Th·ª≠ Th√°ch (Player)
        const renderChallengesPlayer = (user) => {
            challengeListPlayer.innerHTML = '';
            const userChallenges = state.challenges.filter(c => 
                !user.answeredChallenges.includes(c.id)
            );

            if (userChallenges.length === 0) {
                challengeListPlayer.innerHTML = '<p class="text-gray-400 text-center">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ th·ª≠ th√°ch!</p>';
                return;
            }

            userChallenges.forEach(challenge => {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-white mb-4">${challenge.question}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <button data-id="${challenge.id}" data-answer="1" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">1. ${challenge.options[0]}</button>
                        <button data-id="${challenge.id}" data-answer="2" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">2. ${challenge.options[1]}</button>
                        <button data-id="${challenge.id}" data-answer="3" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">3. ${challenge.options[2]}</button>
                        <button data-id="${challenge.id}" data-answer="4" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">4. ${challenge.options[3]}</button>
                    </div>
                    <!-- N√∫t xem gi·∫£i th√≠ch (·∫©n) -->
                    <button data-id="${challenge.id}" class="show-explanation-btn hidden mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Xem Gi·∫£i Th√≠ch
                    </button>
                    <p class="text-sm text-yellow-400 mt-2 text-right">Ph·∫ßn th∆∞·ªüng: üí∞ ${challenge.reward}</p>
                `;
                challengeListPlayer.appendChild(card);
            });
        };

        // X·ª≠ l√Ω tr·∫£ l·ªùi Th·ª≠ Th√°ch
        const handleChallengeAnswer = async (e) => {
            const btn = e.target.closest('.challenge-answer-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const answer = parseInt(btn.dataset.answer);
            const challenge = state.challenges.find(c => c.id === id);
            const user = state.currentUser;
            const card = btn.closest('.bg-gray-700');
            const allButtons = card.querySelectorAll('.challenge-answer-btn');
            
            if (!challenge) return;

            const disableButtons = () => {
                allButtons.forEach(b => {
                    b.disabled = true;
                    b.classList.add('opacity-50', 'cursor-not-allowed');
                    if (parseInt(b.dataset.answer) === challenge.answer) {
                        b.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                        b.classList.add('bg-green-600');
                    }
                });
                const explanationBtn = card.querySelector('.show-explanation-btn');
                if (explanationBtn) {
                    explanationBtn.classList.remove('hidden');
                }
            };
            
            const handleCorrectAnswer = () => {
                user.balance += challenge.reward;
                user.answeredChallenges.push(id);
                db.saveUsers(state.users);
                
                showToast(`Ch√≠nh x√°c! B·∫°n nh·∫≠n ƒë∆∞·ª£c üí∞ ${challenge.reward}!`);
                addActivityLog(`ƒë√£ tr·∫£ l·ªùi ƒë√∫ng th·ª≠ th√°ch "${challenge.question}"`, 'challenge', user);

                playerBalance.textContent = user.balance;
                renderShopPlayer(user);
                
                btn.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                btn.classList.add('bg-green-600');
                
                disableButtons();
            };
            
            const handleWrongAnswer = async () => {
                btn.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                btn.classList.add('bg-red-600', 'shake-error');
                setTimeout(() => btn.classList.remove('shake-error'), 500);

                if (user.balance >= 5) {
                    const retry = await showModal(
                        'B·∫°n c√≥ mu·ªën th·ª≠ l·∫°i?',
                        `B·∫°n ƒë√£ tr·∫£ l·ªùi sai! B·∫°n c√≥ mu·ªën d√πng üí∞ 5 ƒë·ªÉ th·ª≠ l·∫°i kh√¥ng? (B·∫°n ƒëang c√≥ üí∞ ${user.balance})`,
                        'D√πng üí∞ 5',
                        true,
                        'Kh√¥ng, b·ªè qua'
                    );
                    
                    if (retry) {
                        user.balance -= 5;
                        db.saveUsers(state.users);
                        playerBalance.textContent = user.balance;
                        showToast('B·∫°n ƒë√£ b·ªã tr·ª´ üí∞ 5. H√£y ch·ªçn l·∫°i!', true);
                        
                        btn.classList.add('bg-gray-600', 'hover:bg-blue-500');
                        btn.classList.remove('bg-red-600');
                    } else {
                        user.answeredChallenges.push(id);
                        db.saveUsers(state.users);
                        disableButtons();
                    }
                } else {
                    showToast('B·∫°n ƒë√£ tr·∫£ l·ªùi sai v√† kh√¥ng ƒë·ªß üí∞ 5 ƒë·ªÉ th·ª≠ l·∫°i.', true);
                    user.answeredChallenges.push(id);
                    db.saveUsers(state.users);
                    disableButtons();
                }
            };

            if (answer === challenge.answer) {
                handleCorrectAnswer();
            } else {
                await handleWrongAnswer();
            }
        };
        
        // X·ª≠ l√Ω xem Gi·∫£i Th√≠ch
        const handleShowExplanation = (e) => {
            const btn = e.target.closest('.show-explanation-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const challenge = state.challenges.find(c => c.id === id);
            
            if (!challenge) return;
            
            let body = `<p class="text-lg">${challenge.explanationText || 'Admin ch∆∞a cung c·∫•p gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y.'}</p>`;
            
            if (challenge.explanationImg) {
                body += `<img src="${challenge.explanationImg}" alt="H√¨nh ·∫£nh gi·∫£i th√≠ch" class="mt-4 rounded-lg w-full object-contain" onerror="this.style.display='none'">`;
            }
            
            showModal('Gi·∫£i Th√≠ch ƒê√°p √Ån', body).then(() => {
                const card = btn.closest('.bg-gray-700');
                if (card) {
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        if (challengeListPlayer.children.length === 0) {
                            renderChallengesPlayer(state.currentUser);
                        }
                    }, 500);
                }
            });
        };

        // Render C·ª≠a H√†ng (Player)
        const renderShopPlayer = (user) => {
            shopListPlayer.innerHTML = '';
            if (state.shopItems.length === 0) {
                shopListPlayer.innerHTML = '<p class="text-gray-400 text-center col-span-full">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t v·∫≠t ph·∫©m.</p>';
                return;
            }

            state.shopItems.forEach(item => {
                const isOwned = user.inventory.some(invItem => invItem.id === item.id);
                
                let priceHtml = '';
                let finalPrice = item.price;
                
                if (item.sale > 0 && item.sale <= 100) {
                    finalPrice = Math.round(item.price * (1 - item.sale / 100));
                    priceHtml = `
                        <span class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">-${item.sale}%</span>
                        <div class="text-3xl font-bold text-green-400 mb-2">üí∞ ${finalPrice}</div>
                        <div class="text-sm text-gray-400 line-through mb-4">Gi√° g·ªëc: üí∞ ${item.price}</div>
                    `;
                } else {
                    priceHtml = `<div class="text-3xl font-bold text-green-400 mb-4">üí∞ ${item.price}</div>`;
                }
                
                const canAfford = user.balance >= finalPrice;

                shopListPlayer.innerHTML += `
                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 flex flex-col justify-between relative">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-2">${item.name}</h3>
                            ${priceHtml}
                        </div>
                        <button 
                            data-id="${item.id}" 
                            data-price="${finalPrice}" 
                            class="buy-item-btn w-full text-white font-medium py-3 px-4 rounded-lg transition duration-200 ${isOwned ? 'bg-gray-500 cursor-not-allowed' : (canAfford ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-500 cursor-not-allowed')}"
                            ${(isOwned || !canAfford) ? 'disabled' : ''}
                        >
                            ${isOwned ? 'ƒê√£ S·ªü H·ªØu' : (canAfford ? 'Mua Ngay' : 'Kh√¥ng ƒê·ªß Ti·ªÅn')}
                        </button>
                    </div>
                `;
            });
        };

        // X·ª≠ l√Ω Mua V·∫≠t Ph·∫©m
        const handleBuyItem = (e) => {
            const btn = e.target.closest('.buy-item-btn');
            if (!btn) return;

            const id = btn.dataset.id;
            const price = parseInt(btn.dataset.price);
            const item = state.shopItems.find(i => i.id === id);
            const user = state.currentUser;

            if (!item || user.balance < price || user.inventory.some(invItem => invItem.id === item.id)) {
                showToast('Kh√¥ng th·ªÉ mua v·∫≠t ph·∫©m!', true);
                return;
            }

            user.balance -= price;
            user.inventory.push({ id: item.id, name: item.name, boughtAt: Date.now() });
            db.saveUsers(state.users);
            
            showToast(`B·∫°n ƒë√£ mua ${item.name}!`, false);
            addActivityLog(`ƒë√£ ƒë·ªïi v·∫≠t ph·∫©m "${item.name}"`, 'purchase', user);
            
            playerBalance.textContent = user.balance;
            renderShopPlayer(user);
            renderTasksPlayer(user); // C·∫≠p nh·∫≠t c·∫£ nhi·ªám v·ª•
            
            viewGiftsPointer.classList.remove('hidden');
            setTimeout(() => {
                viewGiftsPointer.classList.add('hidden');
            }, 5000);
        };
        
        // X·ª≠ l√Ω xem Qu√† ƒê√£ ƒê·ªïi
        viewMyGiftsBtn.onclick = () => {
            const user = state.currentUser;
            let body = '';
            if (user.inventory.length === 0) {
                body = '<p>B·∫°n ch∆∞a s·ªü h·ªØu v·∫≠t ph·∫©m n√†o.</p>';
            } else {
                body = '<ul class="list-disc list-inside space-y-2">';
                user.inventory.forEach(item => {
                    body += `<li><span class="font-semibold">${item.name}</span> (ƒê·ªïi ng√†y ${new Date(item.boughtAt).toLocaleDateString('vi-VN')})</li>`;
                });
                body += '</ul>';
            }
            showModal('V·∫≠t Ph·∫©m C·ªßa B·∫°n', body);
        };
        
        // X·ª≠ l√Ω C·∫≠p nh·∫≠t Profile
        const handleProfileUpdate = (e) => {
            e.preventDefault();
            const user = state.currentUser;
            const now = Date.now();
            const COOLDOWN_DAYS = 15;
            const COOLDOWN_MS = COOLDOWN_DAYS * 24 * 60 * 60 * 1000;
            
            const newName = profileDisplaynameInput.value.trim();
            const newIcon = profileIconInput.value.trim();
            const newPassword = profilePasswordInput.value.trim();
            
            let canUpdate = true;
            
            if (newName !== user.displayName) {
                if (user.cooldowns.name && now < user.cooldowns.name) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi t√™n sau ${new Date(user.cooldowns.name).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.displayName = newName;
                    user.cooldowns.name = now + COOLDOWN_MS;
                }
            }
            
            if (newIcon !== user.icon) {
                if (user.cooldowns.icon && now < user.cooldowns.icon) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi icon sau ${new Date(user.cooldowns.icon).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.icon = newIcon;
                    user.cooldowns.icon = now + COOLDOWN_MS;
                }
            }
            
            if (newPassword) {
                if (user.cooldowns.password && now < user.cooldowns.password) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau ${new Date(user.cooldowns.password).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.password = newPassword;
                    user.cooldowns.password = now + COOLDOWN_MS;
                }
            }
            
            if (canUpdate) {
                db.saveUsers(state.users);
                showToast('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                initPlayerView(user); 
            }
        };

        // --- Admin Functions ---

        // (C·∫¨P NH·∫¨T) Render Danh s√°ch User (Admin) (Th√™m Rank)
        const renderUserList = () => {
            userListTbody.innerHTML = '';
            Object.values(state.users).forEach(user => {
                const rank = getRank(user.tasksCompleted);
                userListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6"><div class="user-icon user-icon-sm">${user.icon || 'üë§'}</div></td>
                        <td class="py-4 px-6 font-medium">${user.displayName || '(Ch∆∞a ƒë·∫∑t)'}</td>
                        <td class="py-4 px-6">${user.username}</td>
                        <td class="py-4 px-6">üí∞ ${user.balance}</td>
                        <td class="py-4 px-6"><span class="font-bold">${rank.icon} ${user.tasksCompleted}</span></td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-username="${user.username}" class="edit-user-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-username="${user.username}" class="delete-user-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        // (C·∫¨P NH·∫¨T) X√≥a form User (Admin) (Th√™m Rank)
        const clearUserForm = () => {
            userUsernameInput.value = '';
            userDisplaynameInput.value = '';
            userIconInput.value = '';
            userPasswordInput.value = '';
            userBalanceInput.value = '0';
            userTasksCompletedInput.value = '0'; // M·ªõi
            userUsernameInput.readOnly = false;
            userForm.dataset.mode = 'add';
        };
        
        // (C·∫¨P NH·∫¨T) X·ª≠ l√Ω Form User (Th√™m/S·ª≠a) (Th√™m Rank)
        const handleUserFormSubmit = (e) => {
            e.preventDefault();
            
            const username = userUsernameInput.value.trim();
            const displayName = userDisplaynameInput.value.trim();
            const icon = userIconInput.value.trim();
            const password = userPasswordInput.value.trim();
            const balance = parseInt(userBalanceInput.value) || 0;
            const tasksCompleted = parseInt(userTasksCompletedInput.value) || 0; // M·ªõi
            
            if (!username || !password) {
                showToast('T√†i kho·∫£n v√† m·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc!', true);
                return;
            }

            const now = Date.now();
            const mode = userForm.dataset.mode || 'add';

            if (mode === 'add') {
                if (state.users[username]) {
                    showToast('T√†i kho·∫£n n√†y ƒë√£ t·ªìn t·∫°i!', true);
                    return;
                }
                // (C·∫¨P NH·∫¨T) ƒê·ªëi t∆∞·ª£ng user m·ªõi (Th√™m Rank)
                state.users[username] = {
                    username,
                    password,
                    displayName: displayName || username,
                    icon: icon || 'üë§',
                    balance,
                    tasksCompleted: tasksCompleted, // M·ªõi
                    completedTasksHistory: [], // M·ªõi
                    inventory: [],
                    answeredChallenges: [],
                    notifications: [],
                    hasNewNotification: false,
                    cooldowns: { name: null, icon: null, password: null },
                    createdAt: now
                };
                showToast('ƒê√£ th√™m ng∆∞·ªùi d√πng m·ªõi!', false);
            } else {
                const user = state.users[username];
                if (!user) {
                     showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ s·ª≠a.', true);
                     return;
                }
                user.displayName = displayName;
                user.icon = icon;
                user.password = password;
                user.balance = balance;
                user.tasksCompleted = tasksCompleted; // M·ªõi
                showToast(`ƒê√£ c·∫≠p nh·∫≠t @${username}!`, false);
            }

            db.saveUsers(state.users);
            renderUserList();
            clearUserForm();
        };

        // (C·∫¨P NH·∫¨T) X·ª≠ l√Ω n√∫t S·ª≠a/X√≥a User (Th√™m Rank)
        const handleUserActions = (e) => {
            const editBtn = e.target.closest('.edit-user-btn');
            if (editBtn) {
                const username = editBtn.dataset.username;
                const user = state.users[username];
                if (!user) return;
                
                userUsernameInput.value = user.username;
                userDisplaynameInput.value = user.displayName || '';
                userIconInput.value = user.icon || '';
                userPasswordInput.value = user.password;
                userBalanceInput.value = user.balance;
                userTasksCompletedInput.value = user.tasksCompleted || 0; // M·ªõi
                
                userUsernameInput.readOnly = true;
                userForm.dataset.mode = 'edit';
                
                window.scrollTo(0, 0);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-user-btn');
            if (deleteBtn) {
                const username = deleteBtn.dataset.username;
                if (username === 'admin') {
                    showToast('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin!', true);
                    return;
                }
                
                showModal('X√°c nh·∫≠n x√≥a', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a @${username}?`, 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        delete state.users[username];
                        db.saveUsers(state.users);
                        renderUserList();
                        showToast(`ƒê√£ x√≥a @${username}.`, false);
                    }
                });
            }
        };

        // Render Danh s√°ch Nhi·ªám V·ª• (Admin)
        const renderTaskListAdmin = () => {
            taskListTbody.innerHTML = '';
            state.tasks.sort((a, b) => a.deadline - b.deadline).forEach(task => {
                taskListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6">${task.name}</td>
                        <td class="py-4 px-6">üí∞ ${task.reward}</td>
                        <td class="py-4 px-6">üí∏ ${task.penalty}</td>
                        <td class="py-4 px-6">${new Date(task.deadline).toLocaleString('vi-VN')}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-id="${task.id}" class="edit-task-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-id="${task.id}" class="delete-task-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        // X√≥a form Nhi·ªám V·ª•
        const clearTaskForm = () => {
            state.editingTaskId = null;
            taskIdInput.value = '';
            taskNameInput.value = '';
            taskRewardInput.value = '50';
            taskPenaltyInput.value = '10';
            taskDeadlineInput.value = '';
        };

        // X·ª≠ l√Ω Form Nhi·ªám V·ª• (Th√™m/S·ª≠a)
        const handleTaskFormSubmit = (e) => {
            e.preventDefault();
            const id = state.editingTaskId || `task_${Date.now()}`;
            const deadline = new Date(taskDeadlineInput.value).getTime();
            
            if (isNaN(deadline)) {
                showToast('Deadline kh√¥ng h·ª£p l·ªá!', true);
                return;
            }
            
            const task = {
                id,
                name: taskNameInput.value,
                reward: parseInt(taskRewardInput.value),
                penalty: parseInt(taskPenaltyInput.value),
                deadline: deadline
            };

            if (state.editingTaskId) {
                const index = state.tasks.findIndex(t => t.id === id);
                state.tasks[index] = task;
                showToast('ƒê√£ c·∫≠p nh·∫≠t nhi·ªám v·ª•!', false);
            } else {
                state.tasks.push(task);
                showToast('ƒê√£ th√™m nhi·ªám v·ª• m·ªõi!', false);
            }

            db.saveTasks(state.tasks);
            renderTaskListAdmin();
            clearTaskForm();
        };

        // X·ª≠ l√Ω S·ª≠a/X√≥a Nhi·ªám V·ª•
        const handleTaskActions = (e) => {
            // S·ª≠a
            const editBtn = e.target.closest('.edit-task-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;

                state.editingTaskId = id;
                taskNameInput.value = task.name;
                taskRewardInput.value = task.reward;
                taskPenaltyInput.value = task.penalty;
                // Chuy·ªÉn ƒë·ªïi timestamp sang ƒë·ªãnh d·∫°ng YYYY-MM-DDTHH:mm
                const d = new Date(task.deadline);
                taskDeadlineInput.value = d.getFullYear() + '-' + 
                                ('0' + (d.getMonth() + 1)).slice(-2) + '-' + 
                                ('0' + d.getDate()).slice(-2) + 'T' + 
                                ('0' + d.getHours()).slice(-2) + ':' + 
                                ('0' + d.getMinutes()).slice(-2);
                
                window.scrollTo(0, 0);
                return;
            }

            // X√≥a
            const deleteBtn = e.target.closest('.delete-task-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showModal('X√°c nh·∫≠n x√≥a', 'X√≥a nhi·ªám v·ª• n√†y? (User ƒë√£ ho√†n th√†nh s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng)', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.tasks = state.tasks.filter(t => t.id !== id);
                        db.saveTasks(state.tasks);
                        renderTaskListAdmin();
                        showToast('ƒê√£ x√≥a nhi·ªám v·ª•.', false);
                    }
                });
            }
        };

        // Render Danh s√°ch Th·ª≠ Th√°ch (Admin)
        const renderChallengeListAdmin = () => {
            challengeListTbody.innerHTML = '';
            state.challenges.forEach(challenge => {
                challengeListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6">${challenge.question}</td>
                        <td class="py-4 px-6">üí∞ ${challenge.reward}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-id="${challenge.id}" class="edit-challenge-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-id="${challenge.id}" class="delete-challenge-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        // X√≥a form Th·ª≠ Th√°ch
        const clearChallengeForm = () => {
            challengeIdInput.value = '';
            challengeQuestionInput.value = '';
            challengeOp1Input.value = '';
            challengeOp2Input.value = '';
            challengeOp3Input.value = '';
            challengeOp4Input.value = '';
            challengeAnswerInput.value = '';
            challengeRewardInput.value = '10';
            challengeExplanationTextInput.value = '';
            challengeExplanationImgInput.value = '';
            state.editingChallengeId = null;
        };

        // X·ª≠ l√Ω Form Th·ª≠ Th√°ch (Th√™m/S·ª≠a)
        const handleChallengeFormSubmit = (e) => {
            e.preventDefault();
            const id = state.editingChallengeId || `challenge_${Date.now()}`;
            const challenge = {
                id,
                question: challengeQuestionInput.value,
                options: [
                    challengeOp1Input.value,
                    challengeOp2Input.value,
                    challengeOp3Input.value,
                    challengeOp4Input.value,
                ],
                answer: parseInt(challengeAnswerInput.value),
                reward: parseInt(challengeRewardInput.value),
                explanationText: challengeExplanationTextInput.value.trim(),
                explanationImg: challengeExplanationImgInput.value.trim()
            };
            
            if (state.editingChallengeId) {
                const index = state.challenges.findIndex(c => c.id === id);
                state.challenges[index] = challenge;
                showToast('ƒê√£ c·∫≠p nh·∫≠t th·ª≠ th√°ch!', false);
            } else {
                state.challenges.push(challenge);
                showToast('ƒê√£ th√™m th·ª≠ th√°ch m·ªõi!', false);
            }
            
            db.saveChallenges(state.challenges);
            renderChallengeListAdmin();
            clearChallengeForm();
        };

        // X·ª≠ l√Ω S·ª≠a/X√≥a Th·ª≠ Th√°ch
        const handleChallengeActions = (e) => {
            const editBtn = e.target.closest('.edit-challenge-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const challenge = state.challenges.find(c => c.id === id);
                if (!challenge) return;
                
                state.editingChallengeId = id;
                challengeQuestionInput.value = challenge.question;
                challengeOp1Input.value = challenge.options[0];
                challengeOp2Input.value = challenge.options[1];
                challengeOp3Input.value = challenge.options[2];
                challengeOp4Input.value = challenge.options[3];
                challengeAnswerInput.value = challenge.answer;
                challengeRewardInput.value = challenge.reward;
                challengeExplanationTextInput.value = challenge.explanationText || '';
                challengeExplanationImgInput.value = challenge.explanationImg || '';
                
                window.scrollTo(0, 0);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-challenge-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ª≠ th√°ch n√†y?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.challenges = state.challenges.filter(c => c.id !== id);
                        db.saveChallenges(state.challenges);
                        renderChallengeListAdmin();
                        showToast('ƒê√£ x√≥a th·ª≠ th√°ch.', false);
                    }
                });
            }
        };

        // Render Danh s√°ch C·ª≠a H√†ng (Admin)
        const renderShopListAdmin = () => {
            shopListTbody.innerHTML = '';
            state.shopItems.forEach(item => {
                const finalPrice = item.sale > 0 ? Math.round(item.price * (1 - item.sale / 100)) : item.price;
                shopListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6">${item.name}</td>
                        <td class="py-4 px-6">üí∞ ${item.price}</td>
                        <td class="py-4 px-6">${item.sale || 0}%</td>
                        <td class="py-4 px-6">üí∞ ${finalPrice}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-id="${item.id}" class="edit-shop-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-id="${item.id}" class="delete-shop-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };

        // X√≥a form C·ª≠a H√†ng
        const clearShopForm = () => {
            state.editingShopItemId = null;
            shopItemIdInput.value = '';
            shopItemNameInput.value = '';
            shopItemPriceInput.value = '100';
            shopItemSaleInput.value = '0';
        };

        // X·ª≠ l√Ω Form C·ª≠a H√†ng (Th√™m/S·ª≠a)
        const handleShopFormSubmit = (e) => {
            e.preventDefault();
            const id = state.editingShopItemId || `item_${Date.now()}`;
            const item = {
                id,
                name: shopItemNameInput.value,
                price: parseInt(shopItemPriceInput.value),
                sale: parseInt(shopItemSaleInput.value) || 0
            };

            if (state.editingShopItemId) {
                const index = state.shopItems.findIndex(i => i.id === id);
                state.shopItems[index] = item;
                showToast('ƒê√£ c·∫≠p nh·∫≠t v·∫≠t ph·∫©m!', false);
            } else {
                state.shopItems.push(item);
                showToast('ƒê√£ th√™m v·∫≠t ph·∫©m m·ªõi!', false);
            }

            db.saveShopItems(state.shopItems);
            renderShopListAdmin();
            clearShopForm();
        };

        // X·ª≠ l√Ω S·ª≠a/X√≥a C·ª≠a H√†ng
        const handleShopActions = (e) => {
            const editBtn = e.target.closest('.edit-shop-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const item = state.shopItems.find(i => i.id === id);
                if (!item) return;

                state.editingShopItemId = id;
                shopItemNameInput.value = item.name;
                shopItemPriceInput.value = item.price;
                shopItemSaleInput.value = item.sale || 0;
                
                window.scrollTo(0, 0);
                return;
            }

            const deleteBtn = e.target.closest('.delete-shop-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showModal('X√°c nh·∫≠n x√≥a', 'X√≥a v·∫≠t ph·∫©m n√†y?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.shopItems = state.shopItems.filter(i => i.id !== id);
                        db.saveShopItems(state.shopItems);
                        renderShopListAdmin();
                        showToast('ƒê√£ x√≥a v·∫≠t ph·∫©m.', false);
                    }
                });
            }
        };
        
        // X·ª≠ l√Ω G·ª≠i Th√¥ng B√°o (Admin)
        const handleNotificationSubmit = (e) => {
            e.preventDefault();
            const message = notificationMessageInput.value.trim();
            if (!message) return;
            
            Object.values(state.users).forEach(user => {
                addNotification(user, message); // (C·∫¨P NH·∫¨T) S·ª≠ d·ª•ng h√†m helper
            });
            
            db.saveUsers(state.users);
            showToast('ƒê√£ g·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ ng∆∞·ªùi d√πng!', false);
            notificationMessageInput.value = '';
        };

        // Render L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (Admin)
        const renderActivityLog = () => {
            activityLogList.innerHTML = '';
            if (state.activityLog.length === 0) {
                activityLogList.innerHTML = '<p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>';
                return;
            }
            
            state.activityLog.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('vi-VN');
                let colorClass = 'text-blue-400';
                if (log.type === 'purchase') colorClass = 'text-green-400';
                if (log.type === 'task_success') colorClass = 'text-cyan-400';
                if (log.type === 'task_fail') colorClass = 'text-red-400';
                
                activityLogList.innerHTML += `
                    <div class="bg-gray-700 p-4 rounded-lg animate-slide-in">
                        <p class="text-sm">
                            <span class="font-bold ${colorClass}">@${log.user}</span>
                            <span>${log.message}</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                `;
            });
        };

        // X·ª≠ l√Ω c√°c n√∫t X√≥a L·ªãch S·ª≠
        const handleLogClearing = (e) => {
            if (e.target === clearActivityLogBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a TO√ÄN B·ªò l·ªãch s·ª≠ ho·∫°t ƒë·ªông?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.activityLog = [];
                        db.saveActivityLog([]);
                        renderActivityLog();
                        showToast('ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠.', false);
                    }
                });
            }
            
            if (e.target === clearPurchaseLogBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'X√≥a l·ªãch s·ª≠ ƒê·ªîI QU√Ä? (S·∫Ω X√ìA S·∫†CH KHO ƒê·ªí c·ªßa user)', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.activityLog = state.activityLog.filter(log => log.type !== 'purchase');
                        db.saveActivityLog(state.activityLog);
                        renderActivityLog();
                        
                        Object.values(state.users).forEach(user => {
                            user.inventory = [];
                        });
                        db.saveUsers(state.users);
                        
                        showToast('ƒê√£ x√≥a l·ªãch s·ª≠ ƒë·ªïi qu√† v√† kho ƒë·ªì c·ªßa user.', false);
                    }
                });
            }
            
            if (e.target === clearUserNotificationsBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'X√≥a t·∫•t c·∫£ th√¥ng b√°o (chu√¥ng üîî) c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        Object.values(state.users).forEach(user => {
                            user.notifications = [];
                            user.hasNewNotification = false;
                        });
                        db.saveUsers(state.users);
                        showToast('ƒê√£ x√≥a h·∫øt th√¥ng b√°o c·ªßa ng∆∞·ªùi d√πng.', false);
                    }
                });
            }
        };

        // --- Navigation Handlers ---

        // Chuy·ªÉn tab Player
        const switchPlayerTab = (tabName) => {
            Object.values(playerTabs).forEach(tab => tab.classList.add('hidden'));
            playerTabs[tabName].classList.remove('hidden');

            playerNav.querySelectorAll('.player-tab').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                }
            });
            
            if (tabName === 'tasks') renderTasksPlayer(state.currentUser);
            if (tabName === 'challenges') renderChallengesPlayer(state.currentUser);
            if (tabName === 'shop') renderShopPlayer(state.currentUser);
            if (tabName === 'profile') renderRankProfile(state.currentUser); // (M·ªöI)
        };
        
        // Chuy·ªÉn tab Admin
        const switchAdminTab = (tabName) => {
            Object.values(adminTabs).forEach(tab => tab.classList.add('hidden'));
            adminTabs[tabName].classList.remove('hidden');

            adminNav.querySelectorAll('.admin-tab').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                }
            });
            
            if (tabName === 'userMgmt') renderUserList();
            if (tabName === 'taskMgmt') renderTaskListAdmin();
            if (tabName === 'challengeMgmt') renderChallengeListAdmin();
            if (tabName === 'shopMgmt') renderShopListAdmin();
            if (tabName === 'activityLog') renderActivityLog();
        };
        
        playerNav.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.player-tab');
            if (tabBtn) switchPlayerTab(tabBtn.dataset.tab);
        });
        adminNav.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.admin-tab');
            if (tabBtn) switchAdminTab(tabBtn.dataset.tab);
        });

        // --- Initialization ---

        // Kh·ªüi t·∫°o trang Player
        const initPlayerView = (user) => {
            // (C·∫¨P NH·∫¨T) Ki·ªÉm tra deadline (ƒë·ªÉ reset rank n·∫øu c·∫ßn)
            checkTaskDeadlines(user);
        
            state.currentUser = user;
            
            playerUsername.textContent = user.username;
            playerDisplayname.textContent = user.displayName || user.username;
            playerHeaderIcon.textContent = user.icon || 'üë§';
            playerBalance.textContent = user.balance;
            
            if (user.hasNewNotification) {
                notificationBell.classList.add('has-new');
            } else {
                notificationBell.classList.remove('has-new');
            }
            
            profileDisplaynameInput.value = user.displayName || user.username;
            profileIconInput.value = user.icon || 'üë§';
            profileIconDisplay.textContent = user.icon || 'üë§';
            profilePasswordInput.value = '';
            
            // (M·ªöI) Render Rank khi v√†o trang c√° nh√¢n
            renderRankProfile(user);
            
            const now = Date.now();
            const renderCooldown = (elem, cdTimestamp) => {
                if (cdTimestamp && now < cdTimestamp) {
                    const date = new Date(cdTimestamp).toLocaleDateString('vi-VN');
                    elem.textContent = `C√≥ th·ªÉ ƒë·ªïi l·∫°i sau: ${date}`;
                } else {
                    elem.textContent = '';
                }
            };
            renderCooldown(cooldownName, user.cooldowns.name);
            renderCooldown(cooldownIcon, user.cooldowns.icon);
            renderCooldown(cooldownPassword, user.cooldowns.password);

            // M·ªü tab ƒë·∫ßu ti√™n
            switchPlayerTab('tasks');
            showView('player');
        };

        // Kh·ªüi t·∫°o trang Admin
        const initAdminView = () => {
            switchAdminTab('userMgmt');
            showView('admin');
        };

        // X·ª≠ l√Ω ƒêƒÉng Nh·∫≠p
        const handleLogin = (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === 'admin' && password === '123') {
                if (rememberMeInput.checked) {
                    db.saveRememberedUser({ username, password });
                } else {
                    db.clearRememberedUser();
                }
                initAdminView();
                return;
            }

            const user = state.users[username];
            if (user && user.password === password) {
                if (rememberMeInput.checked) {
                    db.saveRememberedUser({ username, password });
                } else {
                    db.clearRememberedUser();
                }
                initPlayerView(user);
            } else {
                showToast('T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', true);
            }
        };

        // X·ª≠ l√Ω ƒêƒÉng Xu·∫•t
        const handleLogout = () => {
            state.currentUser = null;
            showView('login');
            const rememberedUser = db.getRememberedUser();
            if (rememberedUser) {
                usernameInput.value = rememberedUser.username;
                passwordInput.value = rememberedUser.password;
                rememberMeInput.checked = true;
            } else {
                usernameInput.value = '';
                passwordInput.value = '';
                rememberMeInput.checked = false;
            }
        };

        // --- Main Init Function ---
        const init = () => {
            // Load t·∫•t c·∫£ d·ªØ li·ªáu
            state.users = db.getUsers();
            state.tasks = db.getTasks();
            state.challenges = db.getChallenges();
            state.shopItems = db.getShopItems();
            state.activityLog = db.getActivityLog();
            
            // G√°n s·ª± ki·ªán Player
            tasksTab.addEventListener('click', handleTaskCompletion);
            challengeListPlayer.addEventListener('click', (e) => {
                handleChallengeAnswer(e);
                handleShowExplanation(e);
            });
            shopListPlayer.addEventListener('click', handleBuyItem);
            profileForm.addEventListener('submit', handleProfileUpdate);

            // G√°n s·ª± ki·ªán ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t
            loginForm.addEventListener('submit', handleLogin);
            logoutBtnPlayer.addEventListener('click', handleLogout);
            logoutBtnAdmin.addEventListener('click', handleLogout);
            
            // G√°n s·ª± ki·ªán Admin
            userForm.addEventListener('submit', handleUserFormSubmit);
            clearUserFormBtn.addEventListener('click', clearUserForm);
            userListTbody.addEventListener('click', handleUserActions);
            
            taskForm.addEventListener('submit', handleTaskFormSubmit);
            clearTaskFormBtn.addEventListener('click', clearTaskForm);
            taskListTbody.addEventListener('click', handleTaskActions);
            
            challengeForm.addEventListener('submit', handleChallengeFormSubmit);
            clearChallengeFormBtn.addEventListener('click', clearChallengeForm);
            challengeListTbody.addEventListener('click', handleChallengeActions);

            shopForm.addEventListener('submit', handleShopFormSubmit);
            clearShopFormBtn.addEventListener('click', clearShopForm);
            shopListTbody.addEventListener('click', handleShopActions);
            
            notificationForm.addEventListener('submit', handleNotificationSubmit);
            
            clearActivityLogBtn.addEventListener('click', handleLogClearing);
            clearPurchaseLogBtn.addEventListener('click', handleLogClearing);
            clearUserNotificationsBtn.addEventListener('click', handleLogClearing);
            
            renderEmojiPicker(profileEmojiList, profileIconInput);
            renderEmojiPicker(adminEmojiList, userIconInput);
            
            setTimeout(() => {
                if (views.login.classList.contains('hidden') === false) {
                    showToast('Nh·ªõ h√£y l∆∞u m·∫≠t kh·∫©u c·ªßa b·∫°n nh√©!', false);
                }
            }, 1000);

            handleLogout();
        };

        // Ch·∫°y ·ª©ng d·ª•ng
        init();
    });
    </script>
</body>
</html>