<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kin - C√¥ng C·ª• Reo Chu·ªói</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Font Inter t·ª´ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* S·ª≠ d·ª•ng font Inter l√†m font ch·ªØ m·∫∑c ƒë·ªãnh */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }

        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* N√∫t b·∫•m gradient */
        .btn-gradient {
            background-image: linear-gradient(to right, #3b82f6, #6366f1);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            background-image: linear-gradient(to right, #2563eb, #4f46e5);
            box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.3);
        }
        
        /* Animation cho chu·ªói */
        @keyframes pulse-light {
            0%, 100% {
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.5), 0 0 20px rgba(99, 102, 241, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 1), 0 0 40px rgba(99, 102, 241, 0.7);
            }
        }

        /* Animation cho modal */
        @keyframes slide-in {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-content {
            animation: slide-in 0.3s ease-out forwards;
        }

        /* Animation cho pop-up th√¥ng b√°o */
        @keyframes pop-up {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-up {
            animation: pop-up 0.3s ease-out forwards;
        }

        /* Animation khi tr·∫£ l·ªùi sai */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
        }
        .shake-error {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Animation cho log */
        @keyframes slide-in-log {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .animate-slide-in {
            animation: slide-in-log 0.3s ease-out forwards;
        }

        /* Icon ng∆∞·ªùi d√πng */
        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background-color: #374151; /* gray-700 */
            color: white;
            border: 2px solid #4b5563; /* gray-600 */
            flex-shrink: 0;
        }
        .user-icon-sm {
            width: 28px;
            height: 28px;
            font-size: 1rem;
            border-width: 1px;
        }
        
        /* N√∫t ch·ªçn Emoji */
        .emoji-btn {
            background-color: #4b5563; /* gray-600 */
            border: none;
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-btn:hover {
            background-color: #6b7280; /* gray-500 */
            transform: scale(1.1);
        }
        
        /* Style cho chu√¥ng th√¥ng b√°o */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid #1f2937; /* gray-800 */
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .notification-bell.has-new .notification-dot {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-inter antialiased">

    <!-- 1. Trang ƒêƒÉng Nh·∫≠p (Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh) -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h1 class="text-5xl font-extrabold text-center mb-4 text-white">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500">Kin</span>
            </h1>
            <p class="text-center text-gray-400 mb-8">C√¥ng c·ª• reo chu·ªói c·ªßa b·∫°n</p>
            
            <form id="login-form">
                <div class="mb-5">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                    <input type="text" id="username" name="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="Nh·∫≠p t√†i kho·∫£n" required>
                </div>
                <div class="mb-5">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 transition duration-200" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="flex items-center mb-6">
                    <input id="remember-me" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-600 ring-offset-gray-800 focus:ring-2">
                    <label for="remember-me" class="ml-2 text-sm font-medium text-gray-300">Nh·ªõ m·∫≠t kh·∫©u</label>
                </div>
                
                <button type="submit" class="w-full text-white btn-gradient font-medium rounded-lg text-sm px-5 py-3.5 text-center shadow-lg transition duration-300 transform hover:scale-105">
                    ƒêƒÉng Nh·∫≠p
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Trang Ng∆∞·ªùi Ch∆°i (·∫®n ban ƒë·∫ßu) -->
    <div id="player-view" class="container mx-auto p-4 hidden">
        <!-- Header Ng∆∞·ªùi Ch∆°i -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div id="player-header-icon" class="user-icon">üë§</div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Ch√†o, <span id="player-displayname" class="text-blue-400"></span>!</h1>
                    <p class="text-sm text-gray-400 -mt-1">(@<span id="player-username"></span>)</p>
                </div>
                <div class="flex items-center gap-2 text-lg bg-yellow-400 text-gray-900 px-4 py-1 rounded-full font-semibold shadow-md">
                    <span class="text-xl">üí∞</span>
                    <span id="player-balance">0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Chu√¥ng Th√¥ng B√°o -->
                <div id="notification-bell" class="notification-bell text-gray-400 hover:text-white transition">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                    <div class="notification-dot"></div>
                </div>
                <button id="logout-btn-player" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                    ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Player (4 tab) -->
        <nav id="player-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="friends" class="player-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">üî• Chu·ªói Chung</button>
                    <button data-tab="challenges" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üéØ Th·ª≠ Th√°ch</button>
                    <button data-tab="shop" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üõçÔ∏è C·ª≠a H√†ng</button>
                    <button data-tab="profile" class="player-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">üë§ C√° Nh√¢n</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Player -->
        <div class="p-4 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[60vh]">
            
            <!-- Tab Chu·ªói Chung (B·∫°n B√®) -->
            <div id="friends-tab" class="player-tab-content">
                
                <!-- Giao di·ªán 1: Danh s√°ch b·∫°n b√® -->
                <div id="friend-list-view">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- C·ªôt b√™n tr√°i: Th√™m b·∫°n v√† Danh s√°ch b·∫°n b√® -->
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-6">B·∫°n B√® & Chu·ªói Chung</h2>
                            <!-- Th√™m B·∫°n B√® -->
                            <form id="add-friend-form" class="mb-6">
                                <label for="add-friend-username" class="block mb-2 text-sm font-medium text-gray-300">Th√™m b·∫°n m·ªõi (b·∫±ng t√†i kho·∫£n)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="add-friend-username" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Nh·∫≠p username" required>
                                    <button type="submit" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">G·ª≠i Y√™u C·∫ßu</button>
                                </div>
                            </form>
                            
                            <!-- Danh S√°ch B·∫°n B√® (Chu·ªói chung) -->
                            <div id="friend-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <p class="text-gray-400">B·∫°n ch∆∞a c√≥ ng∆∞·ªùi b·∫°n n√†o.</p>
                            </div>
                        </div>

                        <!-- C·ªôt b√™n ph·∫£i: Y√™u c·∫ßu k·∫øt b·∫°n -->
                        <div class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700">
                            <h3 class="text-2xl font-bold text-white mb-4">Y√™u C·∫ßu K·∫øt B·∫°n</h3>
                            <div id="friend-requests-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <p class="text-gray-400">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Giao di·ªán 2: Chi ti·∫øt Rep Chu·ªói Chung -->
                <div id="mutual-streak-detail-view" class="hidden">
                    <button id="back-to-friend-list" class="text-sm text-blue-400 hover:text-blue-300 mb-4">&larr; Quay l·∫°i danh s√°ch</button>
                    <div class="text-center p-6 md:p-12 bg-gray-900 rounded-2xl shadow-inner border border-gray-700">
                        <div class="flex justify-center items-center gap-4 mb-4">
                            <div id="mutual-user-icon" class="user-icon text-4xl w-16 h-16"></div>
                            <span class="text-4xl font-bold text-gray-400">&harr;</span>
                            <div id="mutual-friend-icon" class="user-icon text-4xl w-16 h-16"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Chu·ªói v·ªõi <span id="mutual-friend-name" class="text-blue-400"></span></h2>
                        <div class="text-8xl md:text-9xl mb-4" id="mutual-streak-icon">üöÄ</div>
                        <h2 class="text-6xl md:text-8xl font-extrabold text-white mb-2" id="mutual-streak-count">0</h2>
                        <p class="text-2xl font-semibold text-blue-400 mb-8" id="mutual-streak-milestone">M·ªëc: 0-10</p>
                        <button id="rep-mutual-streak-btn" class="text-white font-bold py-4 px-10 text-xl rounded-xl shadow-2xl transition duration-300 transform hover:scale-105" style="animation: pulse-light 2s infinite;">
                            üî• Reo Chu·ªói Chung!
                        </button>
                        <p id="mutual-streak-message" class="text-lg mt-4 h-6"></p>
                    </div>
                </div>

            </div>
            
            <!-- Tab Th·ª≠ Th√°ch -->
            <div id="challenges-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Th·ª≠ Th√°ch H√†ng Ng√†y</h2>
                <div id="challenge-list-player" class="space-y-4">
                    <p class="text-gray-400">Ch∆∞a c√≥ th·ª≠ th√°ch n√†o h√¥m nay.</p>
                </div>
            </div>

            <!-- Tab C·ª≠a H√†ng -->
            <div id="shop-tab" class="player-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 sm:mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">C·ª≠a H√†ng ƒê·ªïi Th∆∞·ªüng</h2>
                    <button id="view-my-gifts-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 self-start sm:self-center">
                        üéÅ Xem Qu√† ƒê√£ ƒê·ªïi
                    </button>
                </div>
                <div id="view-gifts-pointer" class="hidden text-right text-green-400 font-semibold mb-4 animate-bounce">
                    H√£y xem qu√† c·ªßa m√¨nh nh√©! &nearr;
                </div>
                
                <div id="shop-list-player" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-400">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t.</p>
                </div>
            </div>
            
            <!-- Tab C√° Nh√¢n -->
            <div id="profile-tab" class="player-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Th√¥ng Tin C√° Nh√¢n</h2>
                <div class="max-w-lg mx-auto bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700">
                    <div class="text-center mb-6">
                        <div id="profile-icon-display" class="user-icon text-5xl w-24 h-24 mx-auto mb-4 border-4 border-blue-500">üë§</div>
                    </div>
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label for="profile-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                            <input type="text" id="profile-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <p id="cooldown-name" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <div>
                            <label for="profile-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (ch·ªâ 1 emoji, v√≠ d·ª•: üòä)</label>
                            <input type="text" id="profile-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <!-- B·ªô ch·ªçn Emoji -->
                            <div id="profile-emoji-list" class="flex flex-wrap gap-2 mt-2">
                                <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                            </div>
                            <p id="cooldown-icon" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <div>
                            <label for="profile-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t Kh·∫©u M·ªõi (b·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                            <input type="password" id="profile-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <p id="cooldown-password" class="text-xs text-yellow-500 mt-1"></p>
                        </div>
                        <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                            L∆∞u Thay ƒê·ªïi
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- 3. Trang Admin (·∫®n ban ƒë·∫ßu) -->
    <div id="admin-view" class="container mx-auto p-4 hidden">
        <!-- Header Admin -->
        <header class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <h1 class="text-3xl font-bold text-white">Admin Panel</h1>
            <button id="logout-btn-admin" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md transform hover:scale-105">
                ƒêƒÉng Xu·∫•t
            </button>
        </header>

        <!-- Tab ƒëi·ªÅu h∆∞·ªõng Admin -->
        <nav id="admin-nav" class="bg-gray-800 border-b border-gray-700 rounded-t-lg shadow-md mb-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4 p-4">
                    <button data-tab="userMgmt" class="admin-tab text-white bg-blue-600 font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</button>
                    <button data-tab="challengeMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ Th·ª≠ Th√°ch</button>
                    <button data-tab="shopMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">Qu·∫£n L√≠ C·ª≠a H√†ng</button>
                    <button data-tab="notifyMgmt" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">G·ª≠i Th√¥ng B√°o</button>
                    <button data-tab="activityLog" class="admin-tab text-gray-300 hover:bg-gray-700 hover:text-white font-medium py-2 px-4 rounded-lg transition duration-200">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông</button>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung c√°c tab c·ªßa Admin -->
        <div class="p-6 bg-gray-800 rounded-b-lg shadow-lg border border-gray-700 border-t-0 min-h-[70vh]">

            <!-- Tab Qu·∫£n L√≠ Ng∆∞·ªùi D√πng -->
            <div id="userMgmt-tab" class="admin-tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Ng∆∞·ªùi D√πng</h2>
                <!-- Form c·∫≠p nh·∫≠t (ƒê√£ x√≥a Chu·ªói c√° nh√¢n) -->
                <form id="user-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <input type="hidden" id="user-id">
                    <div>
                        <label for="user-username" class="block mb-2 text-sm font-medium text-gray-300">T√†i kho·∫£n</label>
                        <input type="text" id="user-username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-displayname" class="block mb-2 text-sm font-medium text-gray-300">T√™n Hi·ªÉn Th·ªã</label>
                        <input type="text" id="user-displayname" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="user-password" class="block mb-2 text-sm font-medium text-gray-300">M·∫≠t kh·∫©u</M·∫≠t kh·∫©u>
                        <input type="text" id="user-password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="user-balance" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                        <input type="number" id="user-balance" value="0" min="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="user-icon" class="block mb-2 text-sm font-medium text-gray-300">Icon (Emoji)</label>
                        <input type="text" id="user-icon" maxlength="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- B·ªô ch·ªçn Emoji (Admin) -->
                        <div id="admin-emoji-list" class="flex flex-wrap gap-2 mt-2">
                            <!-- Emojis s·∫Ω ƒë∆∞·ª£c render v√†o ƒë√¢y b·∫±ng JS -->
                        </div>
                    </div>
                    <div class="md:col-span-2 lg:col-span-4 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u</u-form>
                        <button type="button" id="clear-user-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>

                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <!-- B·∫£ng (ƒê√£ x√≥a Chu·ªói c√° nh√¢n) -->
                                <th scope="col" class="py-3 px-6">Icon</th>
                                <th scope="col" class="py-3 px-6">T√™n Hi·ªÉn Th·ªã</th>
                                <th scope="col" class="py-3 px-6">T√†i kho·∫£n</th>
                                <th scope="col" class="py-3 px-6">Ti·ªÅn th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ Th·ª≠ Th√°ch -->
            <div id="challengeMgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ Th·ª≠ Th√°ch</h2>
                <form id="challenge-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 space-y-4">
                    <input type="hidden" id="challenge-id">
                    <div>
                        <label for="challenge-question" class="block mb-2 text-sm font-medium text-gray-300">C√¢u h·ªèi</label>
                        <textarea id="challenge-question" rows="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-op1" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 1</label>
                            <input type="text" id="challenge-op1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-op2" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 2</label>
                            <input type="text" id="challenge-op2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-op3" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 3</label>
                            <input type="text" id="challenge-op3" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="challenge-op4" class="block mb-2 text-sm font-medium text-gray-300">L·ª±a ch·ªçn 4</label>
                            <input type="text" id="challenge-op4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-answer" class="block mb-2 text-sm font-medium text-gray-300">ƒê√°p √°n ƒë√∫ng (1-4)</label>
                            <input type="number" id="challenge-answer" min="1" max="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="challenge-reward" class="block mb-2 text-sm font-medium text-gray-300">Ti·ªÅn th∆∞·ªüng üí∞</label>
                            <input type="number" id="challenge-reward" min="0" value="10" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                    
                    <!-- Ph·∫ßn Gi·∫£i Th√≠ch (M·ªõi) -->
                    <hr class="border-gray-600">
                    <div>
                        <label for="challenge-explanation-text" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch ƒë√°p √°n (Text)</label>
                        <textarea id="challenge-explanation-text" rows="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n n√†y l·∫°i ƒë√∫ng..."></textarea>
                    </div>
                    <div>
                        <label for="challenge-explanation-img" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£i th√≠ch (Link ·∫£nh, kh√¥ng b·∫Øt bu·ªôc)</label>
                        <input type="text" id="challenge-explanation-img" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="https://example.com/image.png">
                    </div>
                    <hr class="border-gray-600">
                    
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u Th·ª≠ Th√°ch</button>
                        <button type="button" id="clear-challenge-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">C√¢u h·ªèi</th>
                                <th scope="col" class="py-3 px-6">Th∆∞·ªüng</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="challenge-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Qu·∫£n L√≠ C·ª≠a H√†ng -->
            <div id="shopMgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Qu·∫£n L√≠ C·ª≠a H√†ng</h2>
                <!-- Form C·ª≠a H√†ng (Th√™m Gi·∫£m Gi√°) -->
                <form id="shop-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <input type="hidden" id="shop-item-id">
                    <div>
                        <label for="shop-item-name" class="block mb-2 text-sm font-medium text-gray-300">T√™n v·∫≠t ph·∫©m</label>
                        <input type="text" id="shop-item-name" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-price" class="block mb-2 text-sm font-medium text-gray-300">Gi√° üí∞</label>
                        <input type="number" id="shop-item-price" min="0" value="100" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="shop-item-sale" class="block mb-2 text-sm font-medium text-gray-300">Gi·∫£m gi√° (%)</label>
                        <input type="number" id="shop-item-sale" min="0" max="100" value="0" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="md:col-span-3 flex gap-4">
                        <button type="submit" class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">L∆∞u V·∫≠t Ph·∫©m</button>
                        <button type="button" id="clear-shop-form-btn" class="flex-1 text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</button>
                    </div>
                </form>
                <div class="overflow-x-auto relative shadow-md rounded-lg border border-gray-700">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">T√™n v·∫≠t ph·∫©m</th>
                                <th scope="col" class="py-3 px-6">Gi√° G·ªëc</th>
                                <th scope="col" class="py-3 px-6">Gi·∫£m Gi√°</th>
                                <th scope="col" class="py-3 px-6">Gi√° M·ªõi</th>
                                <th scope="col" class="py-3 px-6">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="shop-list-tbody" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab G·ª≠i Th√¥ng B√°o -->
            <div id="notifyMgmt-tab" class="admin-tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">G·ª≠i Th√¥ng B√°o</h2>
                <form id="notification-form" class="bg-gray-900 p-6 rounded-lg shadow-inner border border-gray-700 max-w-lg mx-auto">
                    <div class="mb-4">
                        <label for="notification-message" class="block mb-2 text-sm font-medium text-gray-300">N·ªôi dung th√¥ng b√°o</label>
                        <textarea id="notification-message" rows="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Vi·∫øt th√¥ng b√°o c·ªßa b·∫°n..." required></textarea>
                    </div>
                    <button type="submit" class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                        G·ª≠i T·ªõi T·∫•t C·∫£ Ng∆∞·ªùi Ch∆°i
                    </button>
                </form>
            </div>
            
            <!-- Tab L·ªãch S·ª≠ Ho·∫°t ƒê·ªông -->
            <div id="activityLog-tab" class="admin-tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                    <h2 class="text-3xl font-bold text-white mb-4 sm:mb-0">L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (M·ªõi nh·∫•t)</h2>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <!-- N√∫t x√≥a l·ªãch s·ª≠ ƒë·ªïi qu√† -->
                        <button id="clear-purchase-log-btn" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a L·ªãch S·ª≠ ƒê·ªïi Qu√†
                        </button>
                        <!-- N√∫t x√≥a th√¥ng b√°o user -->
                        <button id="clear-user-notifications-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a H·∫øt Th√¥ng B√°o (User)
                        </button>
                        <button id="clear-activity-log-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 self-start sm:self-center">
                            X√≥a To√†n B·ªô L·ªãch S·ª≠
                        </button>
                    </div>
                </div>
                <div id="activity-log-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- 4. Modal Th√¥ng B√°o Chung (·∫®n ban ƒë·∫ßu) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 id="modal-title" class="text-2xl font-bold text-white">Th√¥ng B√°o</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="p-6 text-gray-300 text-lg">
                <!-- N·ªôi dung modal s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>
            <div class="p-5 border-t border-gray-700 text-right space-x-3">
                <button id="modal-cancel-btn" class="hidden text-gray-900 bg-gray-400 hover:bg-gray-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">H·ªßy</V>
                <button id="modal-ok-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal Chu√¥ng Th√¥ng B√°o (·∫®n ban ƒë·∫ßu) -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[51] hidden">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-2xl font-bold text-white">Th√¥ng B√°o C·ªßa B·∫°n</h3>
                <button id="notification-modal-close-btn" class="text-gray-400 hover:text-white transition duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="notification-modal-body" class="p-6 text-gray-300 max-h-[60vh] overflow-y-auto space-y-3">
                <!-- Danh s√°ch th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>
            <div class="p-5 border-t border-gray-700 text-right">
                <button id="notification-modal-ok-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-200">
                    ƒê√£ ƒê·ªçc
                </button>
            </div>
        </div>
    </div>

    <!-- 6. Toast (Pop-up nh·ªè) (·∫®n ban ƒë·∫ßu) -->
    <div id="toast" class="hidden fixed bottom-5 right-5 md:bottom-10 md:right-10 z-[100] bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg pop-up max-w-sm">
        <p id="toast-message">ƒê√¢y l√† th√¥ng b√°o!</p>
    </div>

    <!-- 7. Script ch√≠nh c·ªßa ·ª©ng d·ª•ng -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Elements ---
        const views = {
            // KH√îNG C√ì loading
            login: document.getElementById('login-view'),
            player: document.getElementById('player-view'),
            admin: document.getElementById('admin-view'),
        };
        
        // General Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // Notification Modal (Bell)
        const notificationModal = document.getElementById('notification-modal');
        const notificationModalBody = document.getElementById('notification-modal-body');
        const notificationModalCloseBtn = document.getElementById('notification-modal-close-btn');
        const notificationModalOkBtn = document.getElementById('notification-modal-ok-btn');
        const notificationBell = document.getElementById('notification-bell');

        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // Login
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const rememberMeInput = document.getElementById('remember-me');

        // Player Header
        const playerUsername = document.getElementById('player-username');
        const playerDisplayname = document.getElementById('player-displayname');
        const playerHeaderIcon = document.getElementById('player-header-icon');
        const playerBalance = document.getElementById('player-balance');
        const logoutBtnPlayer = document.getElementById('logout-btn-player');
        
        // Player Nav
        const playerNav = document.getElementById('player-nav');
        const playerTabs = {
            friends: document.getElementById('friends-tab'),
            challenges: document.getElementById('challenges-tab'),
            shop: document.getElementById('shop-tab'),
            profile: document.getElementById('profile-tab'),
        };
        
        // Player: Challenges
        const challengeListPlayer = document.getElementById('challenge-list-player');

        // Player: Shop
        const shopListPlayer = document.getElementById('shop-list-player');
        const viewMyGiftsBtn = document.getElementById('view-my-gifts-btn');
        const viewGiftsPointer = document.getElementById('view-gifts-pointer');

        // Player: Profile
        const profileForm = document.getElementById('profile-form');
        const profileIconDisplay = document.getElementById('profile-icon-display');
        const profileDisplaynameInput = document.getElementById('profile-displayname');
        const profileIconInput = document.getElementById('profile-icon');
        const profilePasswordInput = document.getElementById('profile-password');
        const profileEmojiList = document.getElementById('profile-emoji-list');
        const cooldownName = document.getElementById('cooldown-name');
        const cooldownIcon = document.getElementById('cooldown-icon');
        const cooldownPassword = document.getElementById('cooldown-password');
        
        // Player: Friends (Chu·ªói Chung)
        const friendListView = document.getElementById('friend-list-view');
        const mutualStreakDetailView = document.getElementById('mutual-streak-detail-view');
        const addFriendForm = document.getElementById('add-friend-form');
        const addFriendUsernameInput = document.getElementById('add-friend-username');
        const friendListContainer = document.getElementById('friend-list-container');
        const friendRequestsList = document.getElementById('friend-requests-list');
        const backToFriendListBtn = document.getElementById('back-to-friend-list');
        
        // Player: Mutual Streak Detail
        const mutualUserIcon = document.getElementById('mutual-user-icon');
        const mutualFriendIcon = document.getElementById('mutual-friend-icon');
        const mutualFriendName = document.getElementById('mutual-friend-name');
        const mutualStreakIcon = document.getElementById('mutual-streak-icon');
        const mutualStreakCount = document.getElementById('mutual-streak-count');
        const mutualStreakMilestone = document.getElementById('mutual-streak-milestone');
        const repMutualStreakBtn = document.getElementById('rep-mutual-streak-btn');
        const mutualStreakMessage = document.getElementById('mutual-streak-message');

        // Admin
        const logoutBtnAdmin = document.getElementById('logout-btn-admin');
        const adminNav = document.getElementById('admin-nav');
        const adminTabs = {
            userMgmt: document.getElementById('userMgmt-tab'),
            challengeMgmt: document.getElementById('challengeMgmt-tab'),
            shopMgmt: document.getElementById('shopMgmt-tab'),
            notifyMgmt: document.getElementById('notifyMgmt-tab'),
            activityLog: document.getElementById('activityLog-tab'),
        };
        
        // Admin: User Mgmt
        const userForm = document.getElementById('user-form');
        const userUsernameInput = document.getElementById('user-username');
        const userDisplaynameInput = document.getElementById('user-displayname');
        const userIconInput = document.getElementById('user-icon');
        const adminEmojiList = document.getElementById('admin-emoji-list');
        const userPasswordInput = document.getElementById('user-password');
        const userBalanceInput = document.getElementById('user-balance');
        const clearUserFormBtn = document.getElementById('clear-user-form-btn');
        const userListTbody = document.getElementById('user-list-tbody');
        
        // Admin: Challenge Mgmt
        const challengeForm = document.getElementById('challenge-form');
        const challengeIdInput = document.getElementById('challenge-id');
        const challengeQuestionInput = document.getElementById('challenge-question');
        const challengeOp1Input = document.getElementById('challenge-op1');
        const challengeOp2Input = document.getElementById('challenge-op2');
        const challengeOp3Input = document.getElementById('challenge-op3');
        const challengeOp4Input = document.getElementById('challenge-op4');
        const challengeAnswerInput = document.getElementById('challenge-answer');
        const challengeRewardInput = document.getElementById('challenge-reward');
        const challengeExplanationTextInput = document.getElementById('challenge-explanation-text');
        const challengeExplanationImgInput = document.getElementById('challenge-explanation-img');
        const clearChallengeFormBtn = document.getElementById('clear-challenge-form-btn');
        const challengeListTbody = document.getElementById('challenge-list-tbody');

        // Admin: Shop Mgmt
        const shopForm = document.getElementById('shop-form');
        const shopItemIdInput = document.getElementById('shop-item-id');
        const shopItemNameInput = document.getElementById('shop-item-name');
        const shopItemPriceInput = document.getElementById('shop-item-price');
        const shopItemSaleInput = document.getElementById('shop-item-sale');
        const clearShopFormBtn = document.getElementById('clear-shop-form-btn');
        const shopListTbody = document.getElementById('shop-list-tbody');
        
        // Admin: Notify Mgmt
        const notificationForm = document.getElementById('notification-form');
        const notificationMessageInput = document.getElementById('notification-message');

        // Admin: Activity Log
        const activityLogList = document.getElementById('activity-log-list');
        const clearActivityLogBtn = document.getElementById('clear-activity-log-btn');
        const clearPurchaseLogBtn = document.getElementById('clear-purchase-log-btn');
        const clearUserNotificationsBtn = document.getElementById('clear-user-notifications-btn');

        // --- State ---
        let state = {
            currentUser: null,
            users: {},
            challenges: [],
            shopItems: [],
            activityLog: [],
            editingChallengeId: null,
            editingShopItemId: null,
            currentFriendUsername: null, // D√πng cho trang chi ti·∫øt chu·ªói chung
            modalOkCallback: null, // Callback cho n√∫t OK c·ªßa modal
            modalCancelCallback: null // Callback cho n√∫t Cancel c·ªßa modal
        };
        
        // Danh s√°ch emoji ƒë·ªÉ ch·ªçn
        const EMOJI_LIST = ['üòä', 'üòÇ', 'üî•', 'üöÄ', 'üåü', '‚ù§Ô∏è', 'üéâ', 'üòé', 'üëë', 'üíé', 'üí™', 'üéØ'];

        // --- Database (localStorage) ---
        const db = {
            // H√†m tr·ª£ gi√∫p ƒë·ªÉ l·∫•y d·ªØ li·ªáu
            _get: (key, defaultValue) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            },
            // H√†m tr·ª£ gi√∫p ƒë·ªÉ l∆∞u d·ªØ li·ªáu
            _save: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            },
            
            getUsers: () => db._get('kin_users', {}),
            saveUsers: (users) => db._save('kin_users', users),
            
            getChallenges: () => db._get('kin_challenges', []),
            saveChallenges: (challenges) => db._save('kin_challenges', challenges),
            
            getShopItems: () => db._get('kin_shopItems', []),
            saveShopItems: (items) => db._save('kin_shopItems', items),
            
            getActivityLog: () => db._get('kin_activityLog', []),
            saveActivityLog: (log) => db._save('kin_activityLog', log),
            
            getRememberedUser: () => db._get('kin_rememberedUser', null),
            saveRememberedUser: (user) => db._save('kin_rememberedUser', user),
            clearRememberedUser: () => localStorage.removeItem('kin_rememberedUser'),
        };

        // --- Helper Functions ---

        // Hi·ªÉn th·ªã m·ªôt view v√† ·∫©n c√°c view kh√°c
        const showView = (viewName) => {
            Object.keys(views).forEach(key => {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            });
            window.scrollTo(0, 0);
        };

        // Hi·ªÉn th·ªã Toast (pop-up nh·ªè)
        let toastTimer;
        const showToast = (message, isError = false) => {
            clearTimeout(toastTimer);
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 md:bottom-10 md:right-10 z-[100] text-white py-3 px-6 rounded-lg shadow-lg pop-up max-w-sm ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            
            toastTimer = setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        };
        
        // Hi·ªÉn th·ªã Modal
        const showModal = (title, body, okText = 'OK', showCancel = false, cancelText = 'H·ªßy') => {
            modalTitle.textContent = title;
            modalBody.innerHTML = body; // D√πng innerHTML ƒë·ªÉ render ·∫£nh
            modalOkBtn.textContent = okText;
            
            if (showCancel) {
                modalCancelBtn.textContent = cancelText;
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            
            // Tr·∫£ v·ªÅ m·ªôt promise ƒë·ªÉ x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô
            return new Promise((resolve) => {
                state.modalOkCallback = () => resolve(true);
                state.modalCancelCallback = () => resolve(false);
            });
        };

        // ·∫®n Modal
        const hideModal = () => {
            modal.classList.add('hidden');
            // X√≥a callback ƒë·ªÉ tr√°nh l·ªói
            state.modalOkCallback = null;
            state.modalCancelCallback = null;
        };
        
        // X·ª≠ l√Ω s·ª± ki·ªán ƒë√≥ng Modal
        modalCloseBtn.onclick = () => {
            if (state.modalCancelCallback) state.modalCancelCallback();
            hideModal();
        };
        modalOkBtn.onclick = () => {
            if (state.modalOkCallback) state.modalOkCallback();
            hideModal();
        };
        modalCancelBtn.onclick = () => {
            if (state.modalCancelCallback) state.modalCancelCallback();
            hideModal();
        };

        // Hi·ªÉn th·ªã Modal Chu√¥ng Th√¥ng B√°o
        const showNotificationModal = (user) => {
            notificationModalBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©
            if (!user.notifications || user.notifications.length === 0) {
                notificationModalBody.innerHTML = '<p class="text-gray-400">B·∫°n kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>';
            } else {
                // S·∫Øp x·∫øp, m·ªõi nh·∫•t ·ªü tr√™n
                user.notifications.sort((a, b) => b.timestamp - a.timestamp).forEach(notif => {
                    const date = new Date(notif.timestamp).toLocaleString('vi-VN');
                    notificationModalBody.innerHTML += `
                        <div class="p-4 bg-gray-700 rounded-lg">
                            <p class="text-white">${notif.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${date}</p>
                        </div>
                    `;
                });
            }
            notificationModal.classList.remove('hidden');
            
            // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
            user.hasNewNotification = false;
            notificationBell.classList.remove('has-new');
            db.saveUsers(state.users);
        };
        
        // ·∫®n Modal Chu√¥ng Th√¥ng B√°o
        const hideNotificationModal = () => {
            notificationModal.classList.add('hidden');
        };
        notificationBell.onclick = () => showNotificationModal(state.currentUser);
        notificationModalCloseBtn.onclick = hideNotificationModal;
        notificationModalOkBtn.onclick = hideNotificationModal;

        // Th√™m v√†o Activity Log (v√† l∆∞u)
        const addActivityLog = (message, type, user) => {
            const logEntry = {
                id: Date.now(),
                timestamp: Date.now(),
                message,
                type, // 'challenge', 'purchase'
                user: user.username
            };
            state.activityLog.unshift(logEntry); // Th√™m v√†o ƒë·∫ßu m·∫£ng
            if (state.activityLog.length > 100) {
                state.activityLog.pop(); // Gi·ªõi h·∫°n 100 log
            }
            db.saveActivityLog(state.activityLog);
            
            // Render l·∫°i log n·∫øu ƒëang ·ªü trang admin
            if (views.admin.classList.contains('hidden') === false) {
                renderActivityLog();
            }
        };

        // T√≠nh to√°n m·ªëc chu·ªói v√† icon
        const getStreakMilestone = (count) => {
            if (count === 0) return { icon: 'üå±', milestone: 'M·ªëc: 0' };
            if (count >= 1 && count <= 10) return { icon: 'üöÄ', milestone: `M·ªëc: 1-10 (Ng√†y ${count})` };
            if (count >= 11 && count <= 20) return { icon: 'üî•', milestone: `M·ªëc: 11-20 (Ng√†y ${count})` };
            if (count >= 21 && count <= 50) return { icon: 'üíé', milestone: `M·ªëc: 21-50 (Ng√†y ${count})` };
            if (count >= 51 && count <= 100) return { icon: 'üëë', milestone: `M·ªëc: 51-100 (Ng√†y ${count})` };
            return { icon: 'üåå', milestone: `M·ªëc: >100 (Ng√†y ${count})` };
        };
        
        // H√†m render b·ªô ch·ªçn Emoji
        const renderEmojiPicker = (container, inputElement) => {
            container.innerHTML = '';
            EMOJI_LIST.forEach(emoji => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => {
                    inputElement.value = emoji;
                };
                container.appendChild(btn);
            });
        };

        // --- Core Logic Functions ---

        // (FIX-ADDFRIEND) T√°ch h√†m x·ª≠ l√Ω submit form
        const handleAddFriendSubmit = (e) => {
            e.preventDefault();
            const friendUsername = addFriendUsernameInput.value.trim();
            const user = state.currentUser;
            const users = state.users;

            if (!friendUsername) return;
            if (friendUsername === user.username) {
                showToast('B·∫°n kh√¥ng th·ªÉ t·ª± k·∫øt b·∫°n v·ªõi m√¨nh.', true);
                return;
            }
            
            const friendUser = users[friendUsername];
            if (!friendUser) {
                showToast('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†y.', true);
                return;
            }

            // Ki·ªÉm tra ƒë√£ l√† b·∫°n ho·∫∑c ƒë√£ g·ª≠i y√™u c·∫ßu
            if (user.friends[friendUsername]) {
                showToast('B·∫°n ƒë√£ l√† b·∫°n b√® v·ªõi ng∆∞·ªùi n√†y.', true);
                return;
            }
            if (friendUser.friendRequests.includes(user.username)) {
                showToast('B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu cho ng∆∞·ªùi n√†y r·ªìi.', true);
                return;
            }

            // G·ª≠i y√™u c·∫ßu
            friendUser.friendRequests.push(user.username);
            db.saveUsers(users);
            
            showToast(`ƒê√£ g·ª≠i y√™u c·∫ßu k·∫øt b·∫°n ƒë·∫øn @${friendUsername}.`);
            addFriendUsernameInput.value = '';
        };

        // (FIX-ADDFRIEND) T√°ch h√†m x·ª≠ l√Ω click trong danh s√°ch
        const handleFriendListClick = (e) => {
            const user = state.currentUser;
            const users = state.users;
            const now = Date.now();

            // 1. Ch·∫•p nh·∫≠n y√™u c·∫ßu
            const acceptBtn = e.target.closest('.accept-friend-btn');
            if (acceptBtn) {
                const friendUsername = acceptBtn.dataset.username;
                const friendData = users[friendUsername];
                
                // X√≥a y√™u c·∫ßu kh·ªèi danh s√°ch c·ªßa m√¨nh
                user.friendRequests = user.friendRequests.filter(u => u !== friendUsername);
                
                // Th√™m v√†o danh s√°ch b·∫°n b√® c·ªßa c·∫£ hai
                const mutualFriendData = {
                    streakCount: 0,
                    lastRep: null, // Ai l√† ng∆∞·ªùi rep cu·ªëi c√πng
                    lastRepTimestamp: now,
                    turn: friendUsername // L∆∞·ª£t c·ªßa ng∆∞·ªùi g·ª≠i y√™u c·∫ßu
                };
                
                user.friends[friendUsername] = { ...mutualFriendData };
                friendData.friends[user.username] = { ...mutualFriendData };
                
                // (FIX) Ph·∫£i c·∫≠p nh·∫≠t l·∫°i 'users' object v·ªõi 'user' ƒë√£ thay ƒë·ªïi
                users[user.username] = user;
                
                db.saveUsers(users);
                renderFriends(user);
                showToast(`B·∫°n ƒë√£ k·∫øt b·∫°n v·ªõi @${friendUsername}!`);
                return; // ƒê√£ x·ª≠ l√Ω, kh√¥ng c·∫ßn ch·∫°y ti·∫øp
            }

            // 2. T·ª´ ch·ªëi y√™u c·∫ßu
            const rejectBtn = e.target.closest('.reject-friend-btn');
            if (rejectBtn) {
                const friendUsername = rejectBtn.dataset.username;
                user.friendRequests = user.friendRequests.filter(u => u !== friendUsername);
                
                // (FIX) Ph·∫£i c·∫≠p nh·∫≠t l·∫°i 'users' object v·ªõi 'user' ƒë√£ thay ƒë·ªïi
                users[user.username] = user;
                
                db.saveUsers(users);
                renderFriends(user);
                showToast(`ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu c·ªßa @${friendUsername}.`, true);
                return; // ƒê√£ x·ª≠ l√Ω, kh√¥ng c·∫ßn ch·∫°y ti·∫øp
            }
            
            // 3. Xem chi ti·∫øt chu·ªói chung
            const friendCard = e.target.closest('.friend-card');
            if (friendCard) {
                const friendUsername = friendCard.dataset.username;
                state.currentFriendUsername = friendUsername;
                renderMutualStreakDetail(user, friendUsername);
                friendListView.classList.add('hidden');
                mutualStreakDetailView.classList.remove('hidden');
            }
        };

        // Render trang chi ti·∫øt Chu·ªói Chung
        const renderMutualStreakDetail = (user, friendUsername) => {
            const friendUser = state.users[friendUsername];
            const friendship = user.friends[friendUsername];
            
            if (!friendUser || !friendship) {
                showToast('L·ªói: Kh√¥ng t√¨m th·∫•y b·∫°n b√®.', true);
                // Quay l·∫°i danh s√°ch
                friendListView.classList.remove('hidden');
                mutualStreakDetailView.classList.add('hidden');
                return;
            }

            const now = Date.now();
            const timeSinceLastRep = (now - friendship.lastRepTimestamp) / (1000 * 60 * 60); // hours
            let isBroken = false;

            // Ki·ªÉm tra reset chu·ªói (qu√° 48h k·ªÉ t·ª´ l·∫ßn rep cu·ªëi c√πng)
            if (friendship.lastRep && timeSinceLastRep > 48) {
                friendship.streakCount = 0;
                friendship.lastRep = null;
                friendship.turn = friendUsername; // Reset v·ªÅ l∆∞·ª£t ng∆∞·ªùi b·∫°n
                isBroken = true;
            }

            // Hi·ªÉn th·ªã th√¥ng tin
            mutualUserIcon.textContent = user.icon || 'üë§';
            mutualFriendIcon.textContent = friendUser.icon || 'üë§';
            mutualFriendName.textContent = friendUser.displayName || friendUsername;
            
            const milestone = getStreakMilestone(friendship.streakCount);
            mutualStreakIcon.textContent = milestone.icon;
            mutualStreakCount.textContent = friendship.streakCount;
            mutualStreakMilestone.textContent = milestone.milestone;

            // X·ª≠ l√Ω tr·∫°ng th√°i n√∫t
            if (friendship.turn === user.username) {
                // L∆∞·ª£t c·ªßa b·∫°n
                repMutualStreakBtn.disabled = false;
                repMutualStreakBtn.textContent = 'üî• Reo Chu·ªói Chung!';
                repMutualStreakBtn.classList.add('btn-gradient');
                repMutualStreakBtn.classList.remove('bg-gray-600', 'cursor-not-allowed');
                mutualStreakMessage.textContent = 'ƒê·∫øn l∆∞·ª£t b·∫°n reo chu·ªói!';
                mutualStreakMessage.className = 'text-lg mt-4 h-6 text-green-400 animate-pulse';
            } else {
                // L∆∞·ª£t c·ªßa b·∫°n b√®
                repMutualStreakBtn.disabled = true;
                repMutualStreakBtn.textContent = 'ƒêang ch·ªù b·∫°n...';
                repMutualStreakBtn.classList.remove('btn-gradient');
                repMutualStreakBtn.classList.add('bg-gray-600', 'cursor-not-allowed');
                mutualStreakMessage.textContent = `ƒêang ch·ªù @${friendUsername} reo chu·ªói...`;
                mutualStreakMessage.className = 'text-lg mt-4 h-6 text-yellow-400';
            }
            
            if (isBroken) {
                mutualStreakMessage.textContent = 'Chu·ªói ƒë√£ b·ªã reset do qu√° 48h!';
                mutualStreakMessage.className = 'text-lg mt-4 h-6 text-red-500';
                db.saveUsers(state.users);
            }
        };
        
        // X·ª≠ l√Ω nh·∫•n n√∫t Reo Chu·ªói Chung
        const handleRepMutualStreak = () => {
            const user = state.currentUser;
            const friendUsername = state.currentFriendUsername;
            
            if (!friendUsername) return;
            
            const friendship = user.friends[friendUsername];
            const friendData = state.users[friendUsername];
            const friendFriendship = friendData.friends[user.username];
            
            if (!friendship || !friendData || !friendFriendship) {
                 showToast('L·ªói d·ªØ li·ªáu b·∫°n b√®.', true);
                 return;
            }
            
            // Ch·ªâ reo khi ƒë·∫øn l∆∞·ª£t
            if (friendship.turn !== user.username) {
                showToast('Ch∆∞a ƒë·∫øn l∆∞·ª£t c·ªßa b·∫°n.', true);
                return;
            }

            const now = Date.now();
            
            // N·∫øu ng∆∞·ªùi rep cu·ªëi l√† b·∫°n b√® (ho·∫∑c ch∆∞a ai rep), tƒÉng chu·ªói
            if (friendship.lastRep !== user.username) {
                friendship.streakCount++;
                friendFriendship.streakCount++;
            }
            
            // C·∫≠p nh·∫≠t c·∫£ 2
            friendship.lastRep = user.username;
            friendship.lastRepTimestamp = now;
            friendship.turn = friendUsername; // Chuy·ªÉn l∆∞·ª£t
            
            friendFriendship.lastRep = user.username;
            friendFriendship.lastRepTimestamp = now;
            friendFriendship.turn = friendUsername; // Chuy·ªÉn l∆∞·ª£t
            
            db.saveUsers(state.users);
            
            // Render l·∫°i trang chi ti·∫øt
            renderMutualStreakDetail(user, friendUsername);
            
            showToast(`B·∫°n ƒë√£ reo chu·ªói chung v·ªõi @${friendUsername}!`);
        };

        // Quay l·∫°i danh s√°ch b·∫°n b√®
        backToFriendListBtn.onclick = () => {
            state.currentFriendUsername = null;
            friendListView.classList.remove('hidden');
            mutualStreakDetailView.classList.add('hidden');
            // Render l·∫°i danh s√°ch b·∫°n b√® ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë chu·ªói
            renderFriends(state.currentUser);
        };

        // Render danh s√°ch b·∫°n b√® v√† y√™u c·∫ßu
        const renderFriends = (user) => {
            // Render Y√™u C·∫ßu
            friendRequestsList.innerHTML = '';
            if (user.friendRequests.length === 0) {
                friendRequestsList.innerHTML = '<p class="text-gray-400">Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</p>';
            } else {
                user.friendRequests.forEach(username => {
                    const friendUser = state.users[username];
                    const displayName = friendUser?.displayName || username;
                    const icon = friendUser?.icon || 'üë§';
                    
                    friendRequestsList.innerHTML += `
                        <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="user-icon user-icon-sm">${icon}</div>
                                <span class="font-medium">${displayName} (@${username})</span>
                            </div>
                            <div class="flex gap-2">
                                <button data-username="${username}" class="accept-friend-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded transition">Ch·∫•p Nh·∫≠n</button>
                                <button data-username="${username}" class="reject-friend-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded transition">T·ª´ Ch·ªëi</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Render Danh S√°ch B·∫°n B√®
            friendListContainer.innerHTML = '';
            const friends = Object.keys(user.friends);
            if (friends.length === 0) {
                friendListContainer.innerHTML = '<p class="text-gray-400">B·∫°n ch∆∞a c√≥ ng∆∞·ªùi b·∫°n n√†o. H√£y th√™m b·∫°n ·ªü tr√™n!</p>';
            } else {
                friends.forEach(username => {
                    const friendUser = state.users[username];
                    const friendship = user.friends[username];
                    
                    if (!friendUser) return; // B·ªè qua n·∫øu ng∆∞·ªùi d√πng b·ªã x√≥a
                    
                    const displayName = friendUser.displayName || username;
                    const icon = friendUser.icon || 'üë§';
                    
                    // L·∫•y icon m·ªëc chu·ªói chung
                    const milestone = getStreakMilestone(friendship.streakCount);
                    
                    // Ki·ªÉm tra tr·∫°ng th√°i l∆∞·ª£t
                    let statusText = '';
                    let statusClass = '';
                    if (friendship.turn === user.username) {
                        statusText = 'ƒê·∫øn l∆∞·ª£t b·∫°n!';
                        statusClass = 'text-green-400 animate-pulse';
                    } else {
                        statusText = `ƒêang ch·ªù @${username}`;
                        statusClass = 'text-yellow-400';
                    }

                    friendListContainer.innerHTML += `
                        <div data-username="${username}" class="friend-card flex items-center justify-between bg-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-600 transition duration-200">
                            <div class="flex items-center gap-3">
                                <div class="user-icon user-icon-sm">${icon}</div>
                                <div>
                                    <span class="font-bold text-lg text-white">${displayName}</span>
                                    <p class="text-sm ${statusClass}">${statusText}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-2xl font-bold text-white">
                                <span>${milestone.icon}</span>
                                <span>${friendship.streakCount}</span>
                            </div>
                        </div>
                    `;
                });
            }
        };

        // Render Th·ª≠ Th√°ch (Player)
        const renderChallengesPlayer = (user) => {
            challengeListPlayer.innerHTML = '';
            const userChallenges = state.challenges.filter(c => 
                !user.answeredChallenges.includes(c.id) // Ch∆∞a tr·∫£ l·ªùi
            );

            if (userChallenges.length === 0) {
                challengeListPlayer.innerHTML = '<p class="text-gray-400 text-center">Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ th·ª≠ th√°ch!</p>';
                return;
            }

            userChallenges.forEach(challenge => {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold text-white mb-4">${challenge.question}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <button data-id="${challenge.id}" data-answer="1" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">1. ${challenge.options[0]}</button>
                        <button data-id="${challenge.id}" data-answer="2" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">2. ${challenge.options[1]}</button>
                        <button data-id="${challenge.id}" data-answer="3" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">3. ${challenge.options[2]}</button>
                        <button data-id="${challenge.id}" data-answer="4" class="challenge-answer-btn w-full text-left bg-gray-600 hover:bg-blue-500 text-white font-medium py-3 px-4 rounded-lg transition duration-200">4. ${challenge.options[3]}</button>
                    </div>
                    <!-- N√∫t xem gi·∫£i th√≠ch (·∫©n) -->
                    <button data-id="${challenge.id}" class="show-explanation-btn hidden mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                        Xem Gi·∫£i Th√≠ch
                    </button>
                    <p class="text-sm text-yellow-400 mt-2 text-right">Ph·∫ßn th∆∞·ªüng: üí∞ ${challenge.reward}</p>
                `;
                challengeListPlayer.appendChild(card);
            });
        };

        // X·ª≠ l√Ω tr·∫£ l·ªùi Th·ª≠ Th√°ch
        const handleChallengeAnswer = async (e) => {
            const btn = e.target.closest('.challenge-answer-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const answer = parseInt(btn.dataset.answer);
            const challenge = state.challenges.find(c => c.id === id);
            const user = state.currentUser;
            const card = btn.closest('.bg-gray-700');
            const allButtons = card.querySelectorAll('.challenge-answer-btn');
            
            if (!challenge) return;

            // V√¥ hi·ªáu h√≥a c√°c n√∫t
            const disableButtons = () => {
                allButtons.forEach(b => {
                    b.disabled = true;
                    b.classList.add('opacity-50', 'cursor-not-allowed');
                    // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√∫ng
                    if (parseInt(b.dataset.answer) === challenge.answer) {
                        b.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                        b.classList.add('bg-green-600');
                    }
                });
                // Hi·ªán n√∫t xem gi·∫£i th√≠ch
                const explanationBtn = card.querySelector('.show-explanation-btn');
                if (explanationBtn) {
                    explanationBtn.classList.remove('hidden');
                }
            };
            
            // H√†m x·ª≠ l√Ω khi tr·∫£ l·ªùi ƒë√∫ng
            const handleCorrectAnswer = () => {
                user.balance += challenge.reward;
                user.answeredChallenges.push(id);
                db.saveUsers(state.users);
                
                showToast(`Ch√≠nh x√°c! B·∫°n nh·∫≠n ƒë∆∞·ª£c üí∞ ${challenge.reward}!`);
                addActivityLog(`ƒë√£ tr·∫£ l·ªùi ƒë√∫ng th·ª≠ th√°ch "${challenge.question}"`, 'challenge', user);

                // C·∫≠p nh·∫≠t s·ªë d∆∞
                playerBalance.textContent = user.balance;
                
                // C·∫≠p nh·∫≠t C·ª≠a H√†ng (ƒë·ªÉ k√≠ch ho·∫°t n√∫t mua n·∫øu ƒë·ªß ti·ªÅn)
                renderShopPlayer(user);
                
                // ƒê√°nh d·∫•u n√∫t ƒë√∫ng
                btn.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                btn.classList.add('bg-green-600');
                
                disableButtons();
            };
            
            // H√†m x·ª≠ l√Ω khi tr·∫£ l·ªùi sai
            const handleWrongAnswer = async () => {
                btn.classList.remove('bg-gray-600', 'hover:bg-blue-500');
                btn.classList.add('bg-red-600', 'shake-error');
                // X√≥a animation ƒë·ªÉ c√≥ th·ªÉ l·∫Øc l·∫°i
                setTimeout(() => btn.classList.remove('shake-error'), 500);

                if (user.balance >= 5) {
                    const retry = await showModal(
                        'B·∫°n c√≥ mu·ªën th·ª≠ l·∫°i?',
                        `B·∫°n ƒë√£ tr·∫£ l·ªùi sai! B·∫°n c√≥ mu·ªën d√πng üí∞ 5 ƒë·ªÉ th·ª≠ l·∫°i kh√¥ng? (B·∫°n ƒëang c√≥ üí∞ ${user.balance})`,
                        'D√πng üí∞ 5',
                        true,
                        'Kh√¥ng, b·ªè qua'
                    );
                    
                    if (retry) {
                        // Tr·ª´ ti·ªÅn v√† cho th·ª≠ l·∫°i
                        user.balance -= 5;
                        db.saveUsers(state.users);
                        playerBalance.textContent = user.balance;
                        showToast('B·∫°n ƒë√£ b·ªã tr·ª´ üí∞ 5. H√£y ch·ªçn l·∫°i!', true);
                        
                        // K√≠ch ho·∫°t l·∫°i n√∫t sai
                        btn.classList.add('bg-gray-600', 'hover:bg-blue-500');
                        btn.classList.remove('bg-red-600');
                        // (Kh√¥ng return, ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m l·∫°i)
                    } else {
                        // Ng∆∞·ªùi d√πng ch·ªçn "Kh√¥ng", ƒë√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi v√† hi·ªán ƒë√°p √°n
                        user.answeredChallenges.push(id);
                        db.saveUsers(state.users);
                        disableButtons();
                    }
                } else {
                    // Kh√¥ng ƒë·ªß ti·ªÅn, t·ª± ƒë·ªông th·∫•t b·∫°i
                    showToast('B·∫°n ƒë√£ tr·∫£ l·ªùi sai v√† kh√¥ng ƒë·ªß üí∞ 5 ƒë·ªÉ th·ª≠ l·∫°i.', true);
                    user.answeredChallenges.push(id);
                    db.saveUsers(state.users);
                    disableButtons();
                }
            };

            if (answer === challenge.answer) {
                handleCorrectAnswer();
            } else {
                await handleWrongAnswer();
            }
        };
        
        // X·ª≠ l√Ω xem Gi·∫£i Th√≠ch
        const handleShowExplanation = (e) => {
            const btn = e.target.closest('.show-explanation-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const challenge = state.challenges.find(c => c.id === id);
            
            if (!challenge) return;
            
            let body = `<p class="text-lg">${challenge.explanationText || 'Admin ch∆∞a cung c·∫•p gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y.'}</p>`;
            
            if (challenge.explanationImg) {
                body += `<img src="${challenge.explanationImg}" alt="H√¨nh ·∫£nh gi·∫£i th√≠ch" class="mt-4 rounded-lg w-full object-contain" onerror="this.style.display='none'">`;
            }
            
            // D√πng h√†m modal, khi nh·∫•n OK th√¨ x√≥a c√¢u h·ªèi
            showModal('Gi·∫£i Th√≠ch ƒê√°p √Ån', body).then(() => {
                // Sau khi user nh·∫•n "OK"
                const card = btn.closest('.bg-gray-700');
                if (card) {
                    card.style.transition = 'opacity 0.5s, transform 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        // Ki·ªÉm tra n·∫øu h·∫øt c√¢u h·ªèi
                        if (challengeListPlayer.children.length === 0) {
                            renderChallengesPlayer(state.currentUser);
                        }
                    }, 500);
                }
            });
        };

        // Render C·ª≠a H√†ng (Player)
        const renderShopPlayer = (user) => {
            shopListPlayer.innerHTML = '';
            if (state.shopItems.length === 0) {
                shopListPlayer.innerHTML = '<p class="text-gray-400 text-center col-span-full">C·ª≠a h√†ng ƒëang c·∫≠p nh·∫≠t v·∫≠t ph·∫©m.</p>';
                return;
            }

            state.shopItems.forEach(item => {
                const isOwned = user.inventory.some(invItem => invItem.id === item.id);
                
                let priceHtml = '';
                let finalPrice = item.price;
                
                if (item.sale > 0 && item.sale <= 100) {
                    finalPrice = Math.round(item.price * (1 - item.sale / 100));
                    priceHtml = `
                        <span class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full">-${item.sale}%</span>
                        <div class="text-3xl font-bold text-green-400 mb-2">üí∞ ${finalPrice}</div>
                        <div class="text-sm text-gray-400 line-through mb-4">Gi√° g·ªëc: üí∞ ${item.price}</div>
                    `;
                } else {
                    priceHtml = `<div class="text-3xl font-bold text-green-400 mb-4">üí∞ ${item.price}</div>`;
                }
                
                const canAfford = user.balance >= finalPrice;

                shopListPlayer.innerHTML += `
                    <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 flex flex-col justify-between relative">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-2">${item.name}</h3>
                            ${priceHtml}
                        </div>
                        <button 
                            data-id="${item.id}" 
                            data-price="${finalPrice}" 
                            class="buy-item-btn w-full text-white font-medium py-3 px-4 rounded-lg transition duration-200 ${isOwned ? 'bg-gray-500 cursor-not-allowed' : (canAfford ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-500 cursor-not-allowed')}"
                            ${(isOwned || !canAfford) ? 'disabled' : ''}
                        >
                            ${isOwned ? 'ƒê√£ S·ªü H·ªØu' : (canAfford ? 'Mua Ngay' : 'Kh√¥ng ƒê·ªß Ti·ªÅn')}
                        </button>
                    </div>
                `;
            });
        };

        // X·ª≠ l√Ω Mua V·∫≠t Ph·∫©m
        const handleBuyItem = (e) => {
            const btn = e.target.closest('.buy-item-btn');
            if (!btn) return;

            const id = btn.dataset.id;
            const price = parseInt(btn.dataset.price);
            const item = state.shopItems.find(i => i.id === id);
            const user = state.currentUser;

            if (!item || user.balance < price || user.inventory.some(invItem => invItem.id === item.id)) {
                showToast('Kh√¥ng th·ªÉ mua v·∫≠t ph·∫©m!', true);
                return;
            }

            user.balance -= price;
            user.inventory.push({ id: item.id, name: item.name, boughtAt: Date.now() });
            db.saveUsers(state.users);
            
            showToast(`B·∫°n ƒë√£ mua ${item.name}!`, false);
            addActivityLog(`ƒë√£ ƒë·ªïi v·∫≠t ph·∫©m "${item.name}"`, 'purchase', user);
            
            // Render l·∫°i s·ªë d∆∞ v√† c·ª≠a h√†ng
            playerBalance.textContent = user.balance;
            renderShopPlayer(user);
            
            // Hi·ªáu ·ª©ng m≈©i t√™n ch·ªâ
            viewGiftsPointer.classList.remove('hidden');
            setTimeout(() => {
                viewGiftsPointer.classList.add('hidden');
            }, 5000);
        };
        
        // X·ª≠ l√Ω xem Qu√† ƒê√£ ƒê·ªïi
        viewMyGiftsBtn.onclick = () => {
            const user = state.currentUser;
            let body = '';
            if (user.inventory.length === 0) {
                body = '<p>B·∫°n ch∆∞a s·ªü h·ªØu v·∫≠t ph·∫©m n√†o.</p>';
            } else {
                body = '<ul class="list-disc list-inside space-y-2">';
                user.inventory.forEach(item => {
                    body += `<li><span class="font-semibold">${item.name}</span> (ƒê·ªïi ng√†y ${new Date(item.boughtAt).toLocaleDateString('vi-VN')})</li>`;
                });
                body += '</ul>';
            }
            showModal('V·∫≠t Ph·∫©m C·ªßa B·∫°n', body);
        };
        
        // X·ª≠ l√Ω C·∫≠p nh·∫≠t Profile
        const handleProfileUpdate = (e) => {
            e.preventDefault();
            const user = state.currentUser;
            const now = Date.now();
            const COOLDOWN_DAYS = 15;
            const COOLDOWN_MS = COOLDOWN_DAYS * 24 * 60 * 60 * 1000;
            
            const newName = profileDisplaynameInput.value.trim();
            const newIcon = profileIconInput.value.trim();
            const newPassword = profilePasswordInput.value.trim();
            
            let canUpdate = true;
            
            // Ki·ªÉm tra T√™n
            if (newName !== user.displayName) {
                if (user.cooldowns.name && now < user.cooldowns.name) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi t√™n sau ${new Date(user.cooldowns.name).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.displayName = newName;
                    user.cooldowns.name = now + COOLDOWN_MS;
                }
            }
            
            // Ki·ªÉm tra Icon
            if (newIcon !== user.icon) {
                if (user.cooldowns.icon && now < user.cooldowns.icon) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi icon sau ${new Date(user.cooldowns.icon).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.icon = newIcon;
                    user.cooldowns.icon = now + COOLDOWN_MS;
                }
            }
            
            // Ki·ªÉm tra M·∫≠t kh·∫©u
            if (newPassword) {
                if (user.cooldowns.password && now < user.cooldowns.password) {
                    showToast(`B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u sau ${new Date(user.cooldowns.password).toLocaleDateString('vi-VN')}.`, true);
                    canUpdate = false;
                } else {
                    user.password = newPassword;
                    user.cooldowns.password = now + COOLDOWN_MS;
                }
            }
            
            if (canUpdate) {
                db.saveUsers(state.users);
                showToast('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
                initPlayerView(user); 
            }
        };

        // --- Admin Functions ---

        // Render Danh s√°ch User (Admin)
        const renderUserList = () => {
            userListTbody.innerHTML = '';
            Object.values(state.users).forEach(user => {
                userListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6"><div class="user-icon user-icon-sm">${user.icon || 'üë§'}</div></td>
                        <td class="py-4 px-6 font-medium">${user.displayName || '(Ch∆∞a ƒë·∫∑t)'}</td>
                        <td class="py-4 px-6">${user.username}</td>
                        <td class="py-4 px-6">üí∞ ${user.balance}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-username="${user.username}" class="edit-user-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-username="${user.username}" class="delete-user-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        // X√≥a form User (Admin)
        const clearUserForm = () => {
            userUsernameInput.value = '';
            userDisplaynameInput.value = '';
            userIconInput.value = '';
            userPasswordInput.value = '';
            userBalanceInput.value = '0';
            userUsernameInput.readOnly = false; // K√≠ch ho·∫°t l·∫°i
            userForm.dataset.mode = 'add'; // ƒê·∫∑t ch·∫ø ƒë·ªô 'th√™m m·ªõi'
        };
        
        // X·ª≠ l√Ω Form User (Th√™m/S·ª≠a)
        const handleUserFormSubmit = (e) => {
            e.preventDefault();
            
            const username = userUsernameInput.value.trim();
            const displayName = userDisplaynameInput.value.trim();
            const icon = userIconInput.value.trim();
            const password = userPasswordInput.value.trim();
            const balance = parseInt(userBalanceInput.value) || 0;
            
            if (!username || !password) {
                showToast('T√†i kho·∫£n v√† m·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc!', true);
                return;
            }

            const now = Date.now();
            const mode = userForm.dataset.mode || 'add';

            if (mode === 'add') {
                // Th√™m M·ªõi
                if (state.users[username]) {
                    showToast('T√†i kho·∫£n n√†y ƒë√£ t·ªìn t·∫°i!', true);
                    return;
                }
                state.users[username] = {
                    username,
                    password,
                    displayName: displayName || username,
                    icon: icon || 'üë§',
                    balance,
                    inventory: [],
                    answeredChallenges: [],
                    friendRequests: [],
                    friends: {},
                    notifications: [],
                    hasNewNotification: false,
                    cooldowns: { name: null, icon: null, password: null },
                    createdAt: now
                };
                showToast('ƒê√£ th√™m ng∆∞·ªùi d√πng m·ªõi!', false);
            } else {
                // S·ª≠a
                const user = state.users[username];
                if (!user) {
                     showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ƒë·ªÉ s·ª≠a.', true);
                     return;
                }
                user.displayName = displayName;
                user.icon = icon;
                user.password = password;
                user.balance = balance;
                showToast(`ƒê√£ c·∫≠p nh·∫≠t @${username}!`, false);
            }

            db.saveUsers(state.users);
            renderUserList();
            clearUserForm();
        };

        // X·ª≠ l√Ω n√∫t S·ª≠a/X√≥a User
        const handleUserActions = (e) => {
            // S·ª≠a
            const editBtn = e.target.closest('.edit-user-btn');
            if (editBtn) {
                const username = editBtn.dataset.username;
                const user = state.users[username];
                if (!user) return;
                
                userUsernameInput.value = user.username;
                userDisplaynameInput.value = user.displayName || '';
                userIconInput.value = user.icon || '';
                userPasswordInput.value = user.password;
                userBalanceInput.value = user.balance;
                
                userUsernameInput.readOnly = true; // Kh√≥a username khi s·ª≠a
                userForm.dataset.mode = 'edit'; // ƒê·∫∑t ch·∫ø ƒë·ªô 's·ª≠a'
                
                window.scrollTo(0, 0); // Cu·ªôn l√™n ƒë·∫ßu trang
                return;
            }
            
            // X√≥a
            const deleteBtn = e.target.closest('.delete-user-btn');
            if (deleteBtn) {
                const username = deleteBtn.dataset.username;
                if (username === 'admin') {
                    showToast('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin!', true);
                    return;
                }
                
                showModal(
                    'X√°c nh·∫≠n x√≥a',
                    `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng @${username}? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`,
                    'X√≥a',
                    true
                ).then(confirmed => {
                    if (confirmed) {
                        delete state.users[username];
                        // C≈©ng ph·∫£i x√≥a kh·ªèi danh s√°ch b·∫°n b√® c·ªßa ng∆∞·ªùi kh√°c
                        Object.values(state.users).forEach(u => {
                            delete u.friends[username];
                            u.friendRequests = u.friendRequests.filter(req => req !== username);
                        });
                        
                        db.saveUsers(state.users);
                        renderUserList();
                        showToast(`ƒê√£ x√≥a @${username}.`, false);
                    }
                });
            }
        };

        // Render Danh s√°ch Th·ª≠ Th√°ch (Admin)
        const renderChallengeListAdmin = () => {
            challengeListTbody.innerHTML = '';
            state.challenges.forEach(challenge => {
                challengeListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6">${challenge.question}</td>
                        <td class="py-4 px-6">üí∞ ${challenge.reward}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-id="${challenge.id}" class="edit-challenge-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-id="${challenge.id}" class="delete-challenge-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        // X√≥a form Th·ª≠ Th√°ch
        const clearChallengeForm = () => {
            challengeIdInput.value = '';
            challengeQuestionInput.value = '';
            challengeOp1Input.value = '';
            challengeOp2Input.value = '';
            challengeOp3Input.value = '';
            challengeOp4Input.value = '';
            challengeAnswerInput.value = '';
            challengeRewardInput.value = '10';
            challengeExplanationTextInput.value = '';
            challengeExplanationImgInput.value = '';
            state.editingChallengeId = null;
        };

        // X·ª≠ l√Ω Form Th·ª≠ Th√°ch (Th√™m/S·ª≠a)
        const handleChallengeFormSubmit = (e) => {
            e.preventDefault();
            const id = state.editingChallengeId || `challenge_${Date.now()}`;
            const challenge = {
                id,
                question: challengeQuestionInput.value,
                options: [
                    challengeOp1Input.value,
                    challengeOp2Input.value,
                    challengeOp3Input.value,
                    challengeOp4Input.value,
                ],
                answer: parseInt(challengeAnswerInput.value),
                reward: parseInt(challengeRewardInput.value),
                explanationText: challengeExplanationTextInput.value.trim(),
                explanationImg: challengeExplanationImgInput.value.trim()
            };
            
            if (state.editingChallengeId) {
                // S·ª≠a
                const index = state.challenges.findIndex(c => c.id === id);
                state.challenges[index] = challenge;
                showToast('ƒê√£ c·∫≠p nh·∫≠t th·ª≠ th√°ch!', false);
            } else {
                // Th√™m
                state.challenges.push(challenge);
                showToast('ƒê√£ th√™m th·ª≠ th√°ch m·ªõi!', false);
            }
            
            db.saveChallenges(state.challenges);
            renderChallengeListAdmin();
            clearChallengeForm();
        };

        // X·ª≠ l√Ω S·ª≠a/X√≥a Th·ª≠ Th√°ch
        const handleChallengeActions = (e) => {
            // S·ª≠a
            const editBtn = e.target.closest('.edit-challenge-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const challenge = state.challenges.find(c => c.id === id);
                if (!challenge) return;
                
                state.editingChallengeId = id;
                challengeQuestionInput.value = challenge.question;
                challengeOp1Input.value = challenge.options[0];
                challengeOp2Input.value = challenge.options[1];
                challengeOp3Input.value = challenge.options[2];
                challengeOp4Input.value = challenge.options[3];
                challengeAnswerInput.value = challenge.answer;
                challengeRewardInput.value = challenge.reward;
                challengeExplanationTextInput.value = challenge.explanationText || '';
                challengeExplanationImgInput.value = challenge.explanationImg || '';
                
                window.scrollTo(0, 0);
                return;
            }
            
            // X√≥a
            const deleteBtn = e.target.closest('.delete-challenge-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ª≠ th√°ch n√†y?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.challenges = state.challenges.filter(c => c.id !== id);
                        db.saveChallenges(state.challenges);
                        renderChallengeListAdmin();
                        showToast('ƒê√£ x√≥a th·ª≠ th√°ch.', false);
                    }
                });
            }
        };

        // Render Danh s√°ch C·ª≠a H√†ng (Admin)
        const renderShopListAdmin = () => {
            shopListTbody.innerHTML = '';
            state.shopItems.forEach(item => {
                const finalPrice = item.sale > 0 ? Math.round(item.price * (1 - item.sale / 100)) : item.price;
                shopListTbody.innerHTML += `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-4 px-6">${item.name}</td>
                        <td class="py-4 px-6">üí∞ ${item.price}</td>
                        <td class="py-4 px-6">${item.sale || 0}%</td>
                        <td class="py-4 px-6">üí∞ ${finalPrice}</td>
                        <td class="py-4 px-6 space-x-2">
                            <button type="button" data-id="${item.id}" class="edit-shop-btn text-yellow-400 hover:text-yellow-300 font-medium">S·ª≠a</button>
                            <button type="button" data-id="${item.id}" class="delete-shop-btn text-red-500 hover:text-red-400 font-medium">X√≥a</button>
                        </td>
                    </tr>
                `;
            });
        };

        // X√≥a form C·ª≠a H√†ng
        const clearShopForm = () => {
            state.editingShopItemId = null;
            shopItemIdInput.value = '';
            shopItemNameInput.value = '';
            shopItemPriceInput.value = '100';
            shopItemSaleInput.value = '0';
        };

        // X·ª≠ l√Ω Form C·ª≠a H√†ng (Th√™m/S·ª≠a)
        const handleShopFormSubmit = (e) => {
            e.preventDefault();
            const id = state.editingShopItemId || `item_${Date.now()}`;
            const item = {
                id,
                name: shopItemNameInput.value,
                price: parseInt(shopItemPriceInput.value),
                sale: parseInt(shopItemSaleInput.value) || 0
            };

            if (state.editingShopItemId) {
                // S·ª≠a
                const index = state.shopItems.findIndex(i => i.id === id);
                state.shopItems[index] = item;
                showToast('ƒê√£ c·∫≠p nh·∫≠t v·∫≠t ph·∫©m!', false);
            } else {
                // Th√™m
                state.shopItems.push(item);
                showToast('ƒê√£ th√™m v·∫≠t ph·∫©m m·ªõi!', false);
            }

            db.saveShopItems(state.shopItems);
            renderShopListAdmin();
            clearShopForm();
        };

        // X·ª≠ l√Ω S·ª≠a/X√≥a C·ª≠a H√†ng
        const handleShopActions = (e) => {
            // S·ª≠a
            const editBtn = e.target.closest('.edit-shop-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const item = state.shopItems.find(i => i.id === id);
                if (!item) return;

                state.editingShopItemId = id;
                shopItemNameInput.value = item.name;
                shopItemPriceInput.value = item.price;
                shopItemSaleInput.value = item.sale || 0;
                
                window.scrollTo(0, 0);
                return;
            }

            // X√≥a
            const deleteBtn = e.target.closest('.delete-shop-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v·∫≠t ph·∫©m n√†y? (Kho ƒë·ªì c·ªßa user s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng)', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.shopItems = state.shopItems.filter(i => i.id !== id);
                        db.saveShopItems(state.shopItems);
                        renderShopListAdmin();
                        showToast('ƒê√£ x√≥a v·∫≠t ph·∫©m.', false);
                    }
                });
            }
        };
        
        // X·ª≠ l√Ω G·ª≠i Th√¥ng B√°o (Admin)
        const handleNotificationSubmit = (e) => {
            e.preventDefault();
            const message = notificationMessageInput.value.trim();
            if (!message) return;
            
            const notification = {
                id: `notif_${Date.now()}`,
                timestamp: Date.now(),
                message: message,
                read: false
            };
            
            // G·ª≠i cho t·∫•t c·∫£ user
            Object.values(state.users).forEach(user => {
                user.notifications.push(notification);
                user.hasNewNotification = true;
            });
            
            db.saveUsers(state.users);
            showToast('ƒê√£ g·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ ng∆∞·ªùi d√πng!', false);
            notificationMessageInput.value = '';
        };

        // Render L·ªãch S·ª≠ Ho·∫°t ƒê·ªông (Admin)
        const renderActivityLog = () => {
            activityLogList.innerHTML = '';
            if (state.activityLog.length === 0) {
                activityLogList.innerHTML = '<p class="text-gray-400 text-center">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>';
                return;
            }
            
            state.activityLog.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('vi-VN');
                const colorClass = log.type === 'purchase' ? 'text-green-400' : 'text-blue-400';
                
                activityLogList.innerHTML += `
                    <div class="bg-gray-700 p-4 rounded-lg animate-slide-in">
                        <p class="text-sm">
                            <span class="font-bold ${colorClass}">@${log.user}</span>
                            <span>${log.message}</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                `;
            });
        };

        // X·ª≠ l√Ω c√°c n√∫t X√≥a L·ªãch S·ª≠
        const handleLogClearing = (e) => {
            // X√≥a To√†n B·ªô L·ªãch S·ª≠
            if (e.target === clearActivityLogBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a TO√ÄN B·ªò l·ªãch s·ª≠ ho·∫°t ƒë·ªông?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        state.activityLog = [];
                        db.saveActivityLog([]);
                        renderActivityLog();
                        showToast('ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠.', false);
                    }
                });
            }
            
            // X√≥a L·ªãch S·ª≠ ƒê·ªïi Qu√† (V√Ä X√ìA KHO ƒê·ªí USER)
            if (e.target === clearPurchaseLogBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ ƒê·ªîI QU√Ä? (Vi·ªác n√†y s·∫Ω X√ìA S·∫†CH KHO ƒê·ªí c·ªßa t·∫•t c·∫£ user)', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        // X√≥a log
                        state.activityLog = state.activityLog.filter(log => log.type !== 'purchase');
                        db.saveActivityLog(state.activityLog);
                        renderActivityLog();
                        
                        // X√≥a kho ƒë·ªì
                        Object.values(state.users).forEach(user => {
                            user.inventory = [];
                        });
                        db.saveUsers(state.users);
                        
                        showToast('ƒê√£ x√≥a l·ªãch s·ª≠ ƒë·ªïi qu√† v√† kho ƒë·ªì c·ªßa user.', false);
                    }
                });
            }
            
            // X√≥a H·∫øt Th√¥ng B√°o (User)
            if (e.target === clearUserNotificationsBtn) {
                showModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ th√¥ng b√°o (chu√¥ng üîî) c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng?', 'X√≥a', true)
                .then(confirmed => {
                    if (confirmed) {
                        Object.values(state.users).forEach(user => {
                            user.notifications = [];
                            user.hasNewNotification = false;
                        });
                        db.saveUsers(state.users);
                        showToast('ƒê√£ x√≥a h·∫øt th√¥ng b√°o c·ªßa ng∆∞·ªùi d√πng.', false);
                    }
                });
            }
        };

        // --- Navigation Handlers ---

        // Chuy·ªÉn tab Player
        const switchPlayerTab = (tabName) => {
            // ·∫®n t·∫•t c·∫£ n·ªôi dung
            Object.values(playerTabs).forEach(tab => tab.classList.add('hidden'));
            // ·∫®n Giao di·ªán chi ti·∫øt
            mutualStreakDetailView.classList.add('hidden');
            friendListView.classList.remove('hidden'); // Reset v·ªÅ danh s√°ch
            
            // Hi·ªán n·ªôi dung tab ƒë∆∞·ª£c ch·ªçn
            if (playerTabs[tabName]) {
                playerTabs[tabName].classList.remove('hidden');
            } else if (tabName === 'friends') {
                playerTabs.friends.classList.remove('hidden');
            }

            // ƒê·ªïi style n√∫t
            playerNav.querySelectorAll('.player-tab').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                }
            });
            
            // Render l·∫°i khi chuy·ªÉn tab (ƒë·ªÉ c·∫≠p nh·∫≠t)
            if (tabName === 'challenges') renderChallengesPlayer(state.currentUser);
            if (tabName === 'shop') renderShopPlayer(state.currentUser);
            if (tabName === 'friends') renderFriends(state.currentUser);
        };
        
        // Chuy·ªÉn tab Admin
        const switchAdminTab = (tabName) => {
            Object.values(adminTabs).forEach(tab => tab.classList.add('hidden'));
            adminTabs[tabName].classList.remove('hidden');

            adminNav.querySelectorAll('.admin-tab').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-300', 'hover:bg-gray-700');
                }
            });
            
            // Render khi chuy·ªÉn
            if (tabName === 'userMgmt') renderUserList();
            if (tabName === 'challengeMgmt') renderChallengeListAdmin();
            if (tabName === 'shopMgmt') renderShopListAdmin();
            if (tabName === 'activityLog') renderActivityLog();
        };
        
        // G√°n s·ª± ki·ªán click cho nav
        playerNav.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.player-tab');
            if (tabBtn) switchPlayerTab(tabBtn.dataset.tab);
        });
        adminNav.addEventListener('click', (e) => {
            const tabBtn = e.target.closest('.admin-tab');
            if (tabBtn) switchAdminTab(tabBtn.dataset.tab);
        });

        // --- Initialization ---

        // Kh·ªüi t·∫°o trang Player
        const initPlayerView = (user) => {
            state.currentUser = user;
            
            // C·∫≠p nh·∫≠t Header
            playerUsername.textContent = user.username;
            playerDisplayname.textContent = user.displayName || user.username;
            playerHeaderIcon.textContent = user.icon || 'üë§';
            playerBalance.textContent = user.balance;
            
            // C·∫≠p nh·∫≠t chu√¥ng th√¥ng b√°o
            if (user.hasNewNotification) {
                notificationBell.classList.add('has-new');
            } else {
                notificationBell.classList.remove('has-new');
            }
            
            // C·∫≠p nh·∫≠t Profile Tab
            profileDisplaynameInput.value = user.displayName || user.username;
            profileIconInput.value = user.icon || 'üë§';
            profileIconDisplay.textContent = user.icon || 'üë§';
            profilePasswordInput.value = ''; // Lu√¥n x√≥a tr·ªëng
            
            // Render Cooldowns
            const now = Date.now();
            const renderCooldown = (elem, cdTimestamp) => {
                if (cdTimestamp && now < cdTimestamp) {
                    const date = new Date(cdTimestamp).toLocaleDateString('vi-VN');
                    elem.textContent = `C√≥ th·ªÉ ƒë·ªïi l·∫°i sau: ${date}`;
                } else {
                    elem.textContent = '';
                }
            };
            renderCooldown(cooldownName, user.cooldowns.name);
            renderCooldown(cooldownIcon, user.cooldowns.icon);
            renderCooldown(cooldownPassword, user.cooldowns.password);

            // M·ªü tab ƒë·∫ßu ti√™n
            switchPlayerTab('friends');
            
            showView('player');
        };

        // Kh·ªüi t·∫°o trang Admin
        const initAdminView = () => {
            switchAdminTab('userMgmt');
            showView('admin');
        };

        // X·ª≠ l√Ω ƒêƒÉng Nh·∫≠p
        const handleLogin = (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            // Admin Login
            if (username === 'admin' && password === '123') {
                if (rememberMeInput.checked) {
                    db.saveRememberedUser({ username, password });
                } else {
                    db.clearRememberedUser();
                }
                initAdminView();
                return;
            }

            // Player Login
            const user = state.users[username];
            if (user && user.password === password) {
                if (rememberMeInput.checked) {
                    db.saveRememberedUser({ username, password });
                } else {
                    db.clearRememberedUser();
                }
                initPlayerView(user);
            } else {
                showToast('T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', true);
            }
        };

        // X·ª≠ l√Ω ƒêƒÉng Xu·∫•t
        const handleLogout = () => {
            state.currentUser = null;
            showView('login');
            // ƒêi·ªÅn l·∫°i n·∫øu c√≥ "Nh·ªõ M·∫≠t Kh·∫©u"
            const rememberedUser = db.getRememberedUser();
            if (rememberedUser) {
                usernameInput.value = rememberedUser.username;
                passwordInput.value = rememberedUser.password;
                rememberMeInput.checked = true;
            } else {
                usernameInput.value = '';
                passwordInput.value = '';
                rememberMeInput.checked = false;
            }
        };

        // --- Main Init Function ---
        const init = () => {
            // Load t·∫•t c·∫£ d·ªØ li·ªáu
            state.users = db.getUsers();
            state.challenges = db.getChallenges();
            state.shopItems = db.getShopItems();
            state.activityLog = db.getActivityLog();
            
            // (FIX-ADDFRIEND) G√°n s·ª± ki·ªán cho form TH√äM B·∫†N (submit)
            addFriendForm.addEventListener('submit', handleAddFriendSubmit);
            
            // (FIX-ADDFRIEND) G√°n s·ª± ki·ªán cho DANH S√ÅCH (click)
            const friendTabContainer = document.getElementById('friends-tab');
            friendTabContainer.addEventListener('click', handleFriendListClick);
            
            // G√°n s·ª± ki·ªán cho n√∫t Rep Chu·ªói Chung
            repMutualStreakBtn.addEventListener('click', handleRepMutualStreak);

            // G√°n s·ª± ki·ªán chung cho Th·ª≠ Th√°ch (event delegation)
            challengeListPlayer.addEventListener('click', (e) => {
                handleChallengeAnswer(e);
                handleShowExplanation(e);
            });
            
            // G√°n s·ª± ki·ªán cho C·ª≠a H√†ng
            shopListPlayer.addEventListener('click', handleBuyItem);

            // G√°n s·ª± ki·ªán ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t
            loginForm.addEventListener('submit', handleLogin);
            logoutBtnPlayer.addEventListener('click', handleLogout);
            logoutBtnAdmin.addEventListener('click', handleLogout);
            
            // G√°n s·ª± ki·ªán cho Profile
            profileForm.addEventListener('submit', handleProfileUpdate);
            
            // G√°n s·ª± ki·ªán Admin: User
            userForm.addEventListener('submit', handleUserFormSubmit);
            clearUserFormBtn.addEventListener('click', clearUserForm);
            userListTbody.addEventListener('click', handleUserActions);
            
            // G√°n s·ª± ki·ªán Admin: Challenge
            challengeForm.addEventListener('submit', handleChallengeFormSubmit);
            clearChallengeFormBtn.addEventListener('click', clearChallengeForm);
            challengeListTbody.addEventListener('click', handleChallengeActions);

            // G√°n s·ª± ki·ªán Admin: Shop
            shopForm.addEventListener('submit', handleShopFormSubmit);
            clearShopFormBtn.addEventListener('click', clearShopForm);
            shopListTbody.addEventListener('click', handleShopActions);
            
            // G√°n s·ª± ki·ªán Admin: Notify
            notificationForm.addEventListener('submit', handleNotificationSubmit);
            
            // G√°n s·ª± ki·ªán Admin: Activity Log
            clearActivityLogBtn.addEventListener('click', handleLogClearing);
            clearPurchaseLogBtn.addEventListener('click', handleLogClearing);
            clearUserNotificationsBtn.addEventListener('click', handleLogClearing);
            
            // Render b·ªô ch·ªçn Emoji
            renderEmojiPicker(profileEmojiList, profileIconInput);
            renderEmojiPicker(adminEmojiList, userIconInput);
            
            // Hi·ªÉn th·ªã pop-up nh·∫Øc nh·ªü sau 1 gi√¢y
            setTimeout(() => {
                // Ch·ªâ hi·ªán ·ªü trang login
                if (views.login.classList.contains('hidden') === false) {
                    showToast('Nh·ªõ h√£y l∆∞u m·∫≠t kh·∫©u c·ªßa b·∫°n nh√©!', false);
                }
            }, 1000);

            // Ki·ªÉm tra "Nh·ªõ M·∫≠t Kh·∫©u"
            handleLogout(); // G·ªçi ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn
        };

        // Ch·∫°y ·ª©ng d·ª•ng
        init();
    });
    </script>
</body>
</html>